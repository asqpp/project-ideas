forward
global type w_sales from window
end type
type st_48 from statictext within w_sales
end type
type st_47 from statictext within w_sales
end type
type em_dperc from editmask within w_sales
end type
type st_46 from statictext within w_sales
end type
type em_distance from editmask within w_sales
end type
type sle_vehno from singlelineedit within w_sales
end type
type st_32 from statictext within w_sales
end type
type st_bultouch from statictext within w_sales
end type
type em_tcsamt from editmask within w_sales
end type
type em_tcsperc from editmask within w_sales
end type
type st_17 from statictext within w_sales
end type
type st_45 from statictext within w_sales
end type
type st_42 from statictext within w_sales
end type
type em_astperc from editmask within w_sales
end type
type sle_tin from singlelineedit within w_sales
end type
type st_taxno from statictext within w_sales
end type
type st_schemebal from statictext within w_sales
end type
type st_44 from statictext within w_sales
end type
type cbx_ccpdc from checkbox within w_sales
end type
type st_41 from statictext within w_sales
end type
type dw_approvedby from datawindow within w_sales
end type
type em_bcperc from editmask within w_sales
end type
type st_43 from statictext within w_sales
end type
type em_redmpoints from editmask within w_sales
end type
type st_state from statictext within w_sales
end type
type dw_state from datawindow within w_sales
end type
type sle_pan from singlelineedit within w_sales
end type
type st_pan from statictext within w_sales
end type
type sle_pos from singlelineedit within w_sales
end type
type st_40 from statictext within w_sales
end type
type st_netbalance from statictext within w_sales
end type
type em_netamt from editmask within w_sales
end type
type st_39 from statictext within w_sales
end type
type st_38 from statictext within w_sales
end type
type st_pcardamt from statictext within w_sales
end type
type st_pcardpoints from statictext within w_sales
end type
type st_37 from statictext within w_sales
end type
type st_36 from statictext within w_sales
end type
type sle_chqno from singlelineedit within w_sales
end type
type dw_chqbank from datawindow within w_sales
end type
type st_35 from statictext within w_sales
end type
type cbx_pdc from checkbox within w_sales
end type
type em_chqdate from editmask within w_sales
end type
type em_chqamt from editmask within w_sales
end type
type st_34 from statictext within w_sales
end type
type em_schmamt from editmask within w_sales
end type
type st_33 from statictext within w_sales
end type
type em_fancyamt from editmask within w_sales
end type
type st_fancyamt from statictext within w_sales
end type
type cb_next from commandbutton within w_sales
end type
type cb_prev from commandbutton within w_sales
end type
type dw_agent from datawindow within w_sales
end type
type st_31 from statictext within w_sales
end type
type st_bn from statictext within w_sales
end type
type sle_bn from singlelineedit within w_sales
end type
type st_30 from statictext within w_sales
end type
type sle_mobno from singlelineedit within w_sales
end type
type st_29 from statictext within w_sales
end type
type cbx_sendsms from checkbox within w_sales
end type
type st_15 from statictext within w_sales
end type
type cbx_printwanda from checkbox within w_sales
end type
type cbx_cst from checkbox within w_sales
end type
type cbx_updtsys from checkbox within w_sales
end type
type st_repair from statictext within w_sales
end type
type em_rcamt from editmask within w_sales
end type
type cb_rateall from commandbutton within w_sales
end type
type cbx_ws from checkbox within w_sales
end type
type cbx_showwgt from checkbox within w_sales
end type
type em_advance from editmask within w_sales
end type
type st_advance from statictext within w_sales
end type
type cbx_laserprint from checkbox within w_sales
end type
type em_discperc from editmask within w_sales
end type
type em_hmc from editmask within w_sales
end type
type st_28 from statictext within w_sales
end type
type st_cas from statictext within w_sales
end type
type em_ccamt from editmask within w_sales
end type
type st_27 from statictext within w_sales
end type
type em_bcharge from editmask within w_sales
end type
type st_26 from statictext within w_sales
end type
type cbx_addbc from checkbox within w_sales
end type
type dw_print from datawindow within w_sales
end type
type cbx_credit from checkbox within w_sales
end type
type st_25 from statictext within w_sales
end type
type dw_cashbank from datawindow within w_sales
end type
type cbx_loan from checkbox within w_sales
end type
type st_24 from statictext within w_sales
end type
type sle_note from singlelineedit within w_sales
end type
type st_23 from statictext within w_sales
end type
type sle_addr from singlelineedit within w_sales
end type
type st_vap from statictext within w_sales
end type
type st_22 from statictext within w_sales
end type
type em_ptaxamt from editmask within w_sales
end type
type em_ptaxperc from editmask within w_sales
end type
type st_rva from statictext within w_sales
end type
type em_rva from editmask within w_sales
end type
type st_time from statictext within w_sales
end type
type em_taxperc from editmask within w_sales
end type
type dw_billtype from datawindow within w_sales
end type
type st_21 from statictext within w_sales
end type
type st_20 from statictext within w_sales
end type
type em_grandamt from editmask within w_sales
end type
type st_opwgt from statictext within w_sales
end type
type em_opwgt from editmask within w_sales
end type
type st_billno from singlelineedit within w_sales
end type
type cbx_manual from checkbox within w_sales
end type
type cb_dthlp from commandbutton within w_sales
end type
type st_19 from statictext within w_sales
end type
type dw_counter from datawindow within w_sales
end type
type st_18 from statictext within w_sales
end type
type em_ast from editmask within w_sales
end type
type st_netamt from statictext within w_sales
end type
type em_netbalance from editmask within w_sales
end type
type st_stktype from statictext within w_sales
end type
type cb_cohelp from commandbutton within w_sales
end type
type cb_custhelp from commandbutton within w_sales
end type
type cbx_updtfr from checkbox within w_sales
end type
type cb_qtnprint from commandbutton within w_sales
end type
type cb_short from commandbutton within w_sales
end type
type dw_co from datawindow within w_sales
end type
type st_16 from statictext within w_sales
end type
type em_ob from editmask within w_sales
end type
type st_ob from statictext within w_sales
end type
type st_itemcode_m from statictext within w_sales
end type
type st_itemname_m from statictext within w_sales
end type
type st_qty_m from statictext within w_sales
end type
type st_weight_m from statictext within w_sales
end type
type st_stwgt_m from statictext within w_sales
end type
type st_stprice_m from statictext within w_sales
end type
type st_wastage_m from statictext within w_sales
end type
type st_mc_m from statictext within w_sales
end type
type st_amount_m from statictext within w_sales
end type
type st_rate_m from statictext within w_sales
end type
type st_jewl_m from statictext within w_sales
end type
type st_itemadj from statictext within w_sales
end type
type st_kdm from statictext within w_sales
end type
type dw_smcode from datawindow within w_sales
end type
type st_10 from statictext within w_sales
end type
type st_jcode from statictext within w_sales
end type
type st_va from statictext within w_sales
end type
type st_stock from statictext within w_sales
end type
type em_sreturn from editmask within w_sales
end type
type st_sreturn from statictext within w_sales
end type
type cb_sreturn from commandbutton within w_sales
end type
type cb_exchange from commandbutton within w_sales
end type
type st_14 from statictext within w_sales
end type
type st_13 from statictext within w_sales
end type
type st_12 from statictext within w_sales
end type
type st_11 from statictext within w_sales
end type
type st_9 from statictext within w_sales
end type
type st_8 from statictext within w_sales
end type
type st_7 from statictext within w_sales
end type
type st_6 from statictext within w_sales
end type
type st_5 from statictext within w_sales
end type
type st_4 from statictext within w_sales
end type
type em_duedate from editmask within w_sales
end type
type st_3 from statictext within w_sales
end type
type st_custname from singlelineedit within w_sales
end type
type em_staxamt from editmask within w_sales
end type
type st_staxamt from statictext within w_sales
end type
type dw_1 from datawindow within w_sales
end type
type em_rate8gm from editmask within w_sales
end type
type st_2 from statictext within w_sales
end type
type em_rate from editmask within w_sales
end type
type st_1 from statictext within w_sales
end type
type cb_delete from commandbutton within w_sales
end type
type em_rcvd from editmask within w_sales
end type
type st_rcvd from statictext within w_sales
end type
type em_balance from editmask within w_sales
end type
type st_balance from statictext within w_sales
end type
type em_nettot from editmask within w_sales
end type
type st_nettot from statictext within w_sales
end type
type em_exchange from editmask within w_sales
end type
type st_exchange from statictext within w_sales
end type
type em_discount from editmask within w_sales
end type
type st_discount from statictext within w_sales
end type
type em_billtotal from editmask within w_sales
end type
type st_billtotal from statictext within w_sales
end type
type st_custcode from statictext within w_sales
end type
type em_date from editmask within w_sales
end type
type st_date from statictext within w_sales
end type
type st_bill from statictext within w_sales
end type
type cb_exit from commandbutton within w_sales
end type
type cb_save from commandbutton within w_sales
end type
type cb_add from commandbutton within w_sales
end type
type rr_1 from roundrectangle within w_sales
end type
type st_retamt_m from statictext within w_sales
end type
type st_netamt_m from statictext within w_sales
end type
type st_balance_m from statictext within w_sales
end type
type st_duedate_m from statictext within w_sales
end type
type st_rcvdamt_m from statictext within w_sales
end type
type st_exchamt_m from statictext within w_sales
end type
type st_billamt_m from statictext within w_sales
end type
type st_taxamt_m from statictext within w_sales
end type
type st_discount_m from statictext within w_sales
end type
type st_grategm_m from statictext within w_sales
end type
type st_customer_m from statictext within w_sales
end type
type st_date_m from statictext within w_sales
end type
type st_gratepavan_m from statictext within w_sales
end type
type st_smname_m from statictext within w_sales
end type
type dw_sale from datawindow within w_sales
end type
end forward

shared variables
int icount
end variables

global type w_sales from window
integer width = 5527
integer height = 2340
boolean titlebar = true
string title = "Enter the Sales Details"
boolean controlmenu = true
windowtype windowtype = child!
windowstate windowstate = maximized!
long backcolor = 12632256
st_48 st_48
st_47 st_47
em_dperc em_dperc
st_46 st_46
em_distance em_distance
sle_vehno sle_vehno
st_32 st_32
st_bultouch st_bultouch
em_tcsamt em_tcsamt
em_tcsperc em_tcsperc
st_17 st_17
st_45 st_45
st_42 st_42
em_astperc em_astperc
sle_tin sle_tin
st_taxno st_taxno
st_schemebal st_schemebal
st_44 st_44
cbx_ccpdc cbx_ccpdc
st_41 st_41
dw_approvedby dw_approvedby
em_bcperc em_bcperc
st_43 st_43
em_redmpoints em_redmpoints
st_state st_state
dw_state dw_state
sle_pan sle_pan
st_pan st_pan
sle_pos sle_pos
st_40 st_40
st_netbalance st_netbalance
em_netamt em_netamt
st_39 st_39
st_38 st_38
st_pcardamt st_pcardamt
st_pcardpoints st_pcardpoints
st_37 st_37
st_36 st_36
sle_chqno sle_chqno
dw_chqbank dw_chqbank
st_35 st_35
cbx_pdc cbx_pdc
em_chqdate em_chqdate
em_chqamt em_chqamt
st_34 st_34
em_schmamt em_schmamt
st_33 st_33
em_fancyamt em_fancyamt
st_fancyamt st_fancyamt
cb_next cb_next
cb_prev cb_prev
dw_agent dw_agent
st_31 st_31
st_bn st_bn
sle_bn sle_bn
st_30 st_30
sle_mobno sle_mobno
st_29 st_29
cbx_sendsms cbx_sendsms
st_15 st_15
cbx_printwanda cbx_printwanda
cbx_cst cbx_cst
cbx_updtsys cbx_updtsys
st_repair st_repair
em_rcamt em_rcamt
cb_rateall cb_rateall
cbx_ws cbx_ws
cbx_showwgt cbx_showwgt
em_advance em_advance
st_advance st_advance
cbx_laserprint cbx_laserprint
em_discperc em_discperc
em_hmc em_hmc
st_28 st_28
st_cas st_cas
em_ccamt em_ccamt
st_27 st_27
em_bcharge em_bcharge
st_26 st_26
cbx_addbc cbx_addbc
dw_print dw_print
cbx_credit cbx_credit
st_25 st_25
dw_cashbank dw_cashbank
cbx_loan cbx_loan
st_24 st_24
sle_note sle_note
st_23 st_23
sle_addr sle_addr
st_vap st_vap
st_22 st_22
em_ptaxamt em_ptaxamt
em_ptaxperc em_ptaxperc
st_rva st_rva
em_rva em_rva
st_time st_time
em_taxperc em_taxperc
dw_billtype dw_billtype
st_21 st_21
st_20 st_20
em_grandamt em_grandamt
st_opwgt st_opwgt
em_opwgt em_opwgt
st_billno st_billno
cbx_manual cbx_manual
cb_dthlp cb_dthlp
st_19 st_19
dw_counter dw_counter
st_18 st_18
em_ast em_ast
st_netamt st_netamt
em_netbalance em_netbalance
st_stktype st_stktype
cb_cohelp cb_cohelp
cb_custhelp cb_custhelp
cbx_updtfr cbx_updtfr
cb_qtnprint cb_qtnprint
cb_short cb_short
dw_co dw_co
st_16 st_16
em_ob em_ob
st_ob st_ob
st_itemcode_m st_itemcode_m
st_itemname_m st_itemname_m
st_qty_m st_qty_m
st_weight_m st_weight_m
st_stwgt_m st_stwgt_m
st_stprice_m st_stprice_m
st_wastage_m st_wastage_m
st_mc_m st_mc_m
st_amount_m st_amount_m
st_rate_m st_rate_m
st_jewl_m st_jewl_m
st_itemadj st_itemadj
st_kdm st_kdm
dw_smcode dw_smcode
st_10 st_10
st_jcode st_jcode
st_va st_va
st_stock st_stock
em_sreturn em_sreturn
st_sreturn st_sreturn
cb_sreturn cb_sreturn
cb_exchange cb_exchange
st_14 st_14
st_13 st_13
st_12 st_12
st_11 st_11
st_9 st_9
st_8 st_8
st_7 st_7
st_6 st_6
st_5 st_5
st_4 st_4
em_duedate em_duedate
st_3 st_3
st_custname st_custname
em_staxamt em_staxamt
st_staxamt st_staxamt
dw_1 dw_1
em_rate8gm em_rate8gm
st_2 st_2
em_rate em_rate
st_1 st_1
cb_delete cb_delete
em_rcvd em_rcvd
st_rcvd st_rcvd
em_balance em_balance
st_balance st_balance
em_nettot em_nettot
st_nettot st_nettot
em_exchange em_exchange
st_exchange st_exchange
em_discount em_discount
st_discount st_discount
em_billtotal em_billtotal
st_billtotal st_billtotal
st_custcode st_custcode
em_date em_date
st_date st_date
st_bill st_bill
cb_exit cb_exit
cb_save cb_save
cb_add cb_add
rr_1 rr_1
st_retamt_m st_retamt_m
st_netamt_m st_netamt_m
st_balance_m st_balance_m
st_duedate_m st_duedate_m
st_rcvdamt_m st_rcvdamt_m
st_exchamt_m st_exchamt_m
st_billamt_m st_billamt_m
st_taxamt_m st_taxamt_m
st_discount_m st_discount_m
st_grategm_m st_grategm_m
st_customer_m st_customer_m
st_date_m st_date_m
st_gratepavan_m st_gratepavan_m
st_smname_m st_smname_m
dw_sale dw_sale
end type
global w_sales w_sales

type variables
str_tran strexchange[]
str_tran strsreturn[]
str_tran strisales[]
string seb = "E"
boolean bok = true
boolean bdone = false
boolean bchkentry = true
string saded = "A"
long lislno
dec dircvdafter
time titime
boolean bijewl = false
int iieditable = 1
dec diwstgminimum = 0
dec diwstgroundup = 0
dec diwstgrounddown = 0
dec ditaxperc = 0
string sivamodel = "N"
dec dimcminimum = 0
dec dibal = 0
string sidefstktype = ""
string siws = "N"
string sibccompulsory = "N"
string siuserbccompulsory = "N"
string siitemadjinsales = "N"
dec disretdisc = 0
string siautorearangemcstamt = "N"
dec dimaxmcperc = 0
string sigrandamttorcvdamt = "N"
dec didiscperc = 0
string sitaxafterdisc = "Y"
string sinodisc = ""
dec dibcadjustablewgt = 0
string sialloweditbcdet = "N"
string sistoponmcp = "N"
dec dithrate = 0
string sistoponmodel = "Y"
string siallowinsufstock = "N"
string sibulrate = "N"
string siratebeftax = "N"
dec dibultouch = 99.5
dec dimaxdiscperc = 0
end variables

forward prototypes
public  function int addnew ()
public  function int initsalemodule ()
public  subroutine  scrtomalayalam ()
public  function int balcalc (int rparm)
public  function dec qtnprint_sreturn (long rjob,int rprnlang,int rbillform,string rcondense,string rheadenglish,string rrateprint,long rslno,dec rtotal,string rhead,string rtype)
public  function dec qtnprint_exchange (long rjob,int rprnlang,int rbillform,string rcondense,string rheadenglish,string rrateprint,long rslno,dec rtotal,string rhead,string rtype)
public  function int bcodechk (int rrow)
public function long saveproc (string rtype)
public  subroutine  stktypechk ()
public  subroutine  calcbcharge (int rtype)
public  subroutine  filldetails (long rslno)
public  subroutine  evacalc ()
end prototypes

public  function int addnew ();
long lrow
long lslno
long ltotrow
string scode

ltotrow = dw_sale.rowcount()

if isnull(ltotrow) then
	ltotrow = 0
end if

if ltotrow <> 0 then
	scode = dw_sale.getitemstring(ltotrow,"itemcode")

	if trim(scode) <> "" then
		lrow = dw_sale.insertrow(0)
		dw_sale.setitem(lrow,"stktype",gsdefstktype)
		dw_sale.scrolltorow(lrow)
	else
		dw_sale.scrolltorow(dw_sale.rowcount())
	end if
else
	lrow = dw_sale.insertrow(0)
	dw_sale.setitem(lrow,"stktype",gsdefstktype)
end if

dw_sale.setcolumn(1)
dw_sale.setfocus()

return 1
end function

public  function int initsalemodule ();
long lbillno
long lbillno1
long lbillno2
string scode
string stype
string sbillno
string spref
string slen
str_tran strstmp[]

strexchange[] = strstmp[]
strsreturn[] = strstmp[]
strisales[] = strstmp[]
dw_sale.reset()
dw_sale.insertrow(0)
dw_1.setitem(1,1,"")
dw_1.settext("")
dw_co.settext("")
dw_smcode.setitem(1,"code","")
dw_smcode.settext("")
dw_cashbank.setitem(1,1,"CASH")
em_bcharge.text = ""
cbx_addbc.checked = false
st_custname.text = ""
sle_addr.text = ""
sle_mobno.text = ""
em_ob.text = ""
em_billtotal.text = ""
em_exchange.text = ""
em_nettot.text = ""
em_discount.text = ""
em_rcvd.text = ""
em_balance.text = ""
em_exchange.text = ""
em_staxamt.text = ""
em_ast.text = ""
em_sreturn.text = ""
em_grandamt.text = ""
em_opwgt.text = ""
em_ptaxamt.text = ""
this.sinodisc = ""
em_discount.enabled = true
em_discperc.enabled = true
sle_note.text = ""
cbx_loan.checked = false
em_ccamt.text = ""
em_chqamt.text = ""
cbx_pdc.checked = false
dw_chqbank.setitem(1,1,"")
sle_chqno.text = ""
em_chqdate.text = ""
em_bcharge.text = ""
em_hmc.text = ""
em_discperc.text = ""
em_redmpoints.text = ""
em_advance.text = ""
em_rcamt.text = ""
cbx_cst.checked = false
sle_bn.text = ""
dw_agent.setitem(1,1,"")
st_pcardpoints.text = ""
st_pcardamt.text = ""
em_netamt.text = ""
sle_pos.text = ""
sle_pan.text = ""
dw_approvedby.setitem(1,1,"")
st_schemebal.text = ""
sle_tin.text = ""
em_schmamt.text = ""
em_fancyamt.text = ""
em_tcsperc.text = ""
em_tcsamt.text = ""

if cbx_manual.checked then
	st_billno.text = ""
else
	if profilestring(gsinifile,"Software","ShortPrintOnly","N") = "Y" and &
			this.seb = "E" then
		stype = "T"
	else
		stype = "S"
	end if

	if profilestring(gsinifile,"Software","SalesFirstQtnNo","N") = "Y" then
		scode = "QTNNO"
	else
		if stype = "T" then
			scode = "TSALES" + this.seb
		else
			scode = "SALES" + this.seb
		end if
	end if

	SELECT cvalue 
	INTO :lbillno
	FROM generali
	WHERE trim ( code ) = :scode;

	if giaccount = 2 and &
			gifupdt = 1 and &
			cbx_updtfr.checked and &
			this.seb = "B" then
		SELECT cvalue 
		INTO :lbillno2
		FROM generali
		WHERE trim ( code ) = :scode 
		using transtmp;

		if lbillno < lbillno2 then
			lbillno = lbillno2
		end if
	end if

	if profilestring(gsinifile,"Software","SalesFirstQtnNo","N") = "Y" then
		sbillno = "Q/" + string(today(),"mmdd") + "/" + string(lbillno + 1,"000")
	else
		if stype = "T" then
			if this.seb = "B" then
				sbillno = "TSB/" + string(lbillno + 1,"00000")
			else
				sbillno = "TSE/" + string(lbillno + 1,"00000")
			end if
		else
			if this.seb = "B" then
				if profilestring(gsinifile,"Software","BillTypewiseBillNo","N") = "Y" and &
						this.seb = "B" then
					scode = dw_billtype.gettext()

					select prefix 
					into :spref
					from salestype
					where code = :scode;

					scode = "SALES" + spref

					select cvalue 
					into :lbillno
					from generali
					where code = :scode;

					if sqlca.sqlcode <> 0 then
						insert into generali ( code , cvalue )
						values (  :scode , 0 );

						lbillno = 0
					end if

					sbillno = spref + string(lbillno + 1,"00000")
				else
					select cvalue 
					into :spref
					from generals
					where code ='SBPREF';

					if isnull(spref) then
						spref = "SLB/"
					end if

					select cvalue 
					into :slen
					from generals
					where code ='SBLEN';

					if isnull(slen) then
						slen = "5"
					end if

					sbillno = spref + string(lbillno + 1,fill("0",integer(slen)))
				end if
			else
				select cvalue 
				into :spref
				from generals
				where code ='SEPREF';

				if isnull(spref) then
					spref = "SLE/"
				end if

				select cvalue 
				into :slen
				from generals
				where code ='SELEN';

				if isnull(slen) then
					slen = "5"
				end if

				sbillno = spref + string(lbillno + 1,fill("0",integer(slen)))
			end if
		end if
	end if

	st_billno.text = sbillno
end if

em_netbalance.text = ""
em_dperc.text = ""
em_duedate.text = ""
this.bijewl = false
this.dibal = 0
this.lislno = 0
st_time.text = string(now(),"HH:MM AM/PM")

if profilestring(gsinifile,"Software","ShowTaxInEstimate","N") = "N" and &
		this.seb = "E" then
	em_taxperc.text = ""
end if

cbx_printwanda.checked = false
cbx_ccpdc.checked = false

rollback;

return 1
end function

public  subroutine  scrtomalayalam ();

st_date_m.visible = true
st_grategm_m.visible = true
st_gratepavan_m.visible = true
st_customer_m.visible = true
st_smname_m.visible = true
st_itemcode_m.visible = true
st_itemname_m.visible = true
st_qty_m.visible = true
st_weight_m.visible = true
st_stwgt_m.visible = true
st_stprice_m.visible = true
st_wastage_m.visible = true
st_mc_m.visible = true
st_amount_m.visible = true
st_rate_m.visible = true
st_jewl_m.visible = true
st_billamt_m.visible = true
st_exchamt_m.visible = true
st_retamt_m.visible = true
st_taxamt_m.visible = true
st_netamt_m.visible = true
st_discount_m.visible = true
st_rcvdamt_m.visible = true
st_balance_m.visible = true
st_duedate_m.visible = true

return
end subroutine

public  function int balcalc (int rparm);
dec drcvd
dec dnetamt
dec dbal
dec dbamt
dec ddisc
dec deamt
dec dtaxamt
dec dsramt
dec dround
dec dast
dec dbc
dec dhmc
dec dadv
dec drcamt
dec dfancyamt
dec dschmamt
dec dchqamt
dec dtcsperc
dec dtcsamt
string sobject
graphicobject which_control

which_control = getfocus()
sobject = ""

if isvalid(which_control) then
	sobject = which_control.classname()
end if

this.calcbcharge(1)
dbamt = dec(em_billtotal.text)
ddisc = dec(em_discount.text)
deamt = dec(em_exchange.text)
dsramt = dec(em_sreturn.text)
dnetamt = dec(em_nettot.text)
drcvd = dec(em_rcvd.text)
dtaxamt = dec(em_staxamt.text)
dast = dec(em_ast.text)
drcamt = dec(em_rcamt.text)
dhmc = dec(em_hmc.text)
dbc = dec(em_bcharge.text)
dadv = dec(em_advance.text)
dschmamt = dec(em_schmamt.text)
dfancyamt = dec(em_fancyamt.text)
dtcsperc = dec(em_tcsperc.text)
dtcsamt = dec(em_tcsamt.text)

if isnull(dbamt) then
	dbamt = 0
end if

if isnull(ddisc) then
	ddisc = 0
end if

if isnull(deamt) then
	deamt = 0
end if

if isnull(dsramt) then
	dsramt = 0
end if

if isnull(dnetamt) then
	dnetamt = 0
end if

if isnull(drcvd) then
	drcvd = 0
end if

if isnull(dtaxamt) then
	dtaxamt = 0
end if

dround = dec(profilestring(gsinifile,"Software","AmtRoundTo","0"))
dnetamt = dbamt + dtaxamt + dast + drcamt + dhmc - deamt - dsramt - dadv + dfancyamt - dschmamt

if cbx_addbc.checked then
	dnetamt += dbc
end if

if dround > 0 then
	if dround = 1 then
		dnetamt = round(dnetamt,0)
	end if
end if

em_nettot.text = string(dnetamt)

if sobject <> "em_discount" and &
		sobject <> "em_rcvd" then
	if dec(em_discperc.text) > 0 then
		if profilestring(gsinifile,"Software","DiscBasedOnNetAmt","N") = "Y" then
			ddisc = (dec(em_nettot.text) * dec(em_discperc.text)) / 100
		else
			ddisc = (dec(em_billtotal.text) * dec(em_discperc.text)) / 100
		end if

		em_discount.text = string(ddisc)
	end if
end if

dtcsamt = ((dnetamt - dec(em_discount.text)) * dtcsperc) / 100
dtcsamt = round(dtcsamt,0)
dnetamt += dtcsamt

if dround > 0 then
	if dround = 1 then
		dnetamt = round(dnetamt,0)
	end if
end if

em_tcsamt.text = string(dtcsamt)
em_nettot.text = string(dnetamt)
em_grandamt.text = string(dec(em_ob.text) + dec(em_nettot.text) - dec(em_discount.text))
em_netamt.text = string(dec(em_nettot.text) - dec(em_discount.text))

if this.dibal = 0 and &
		rparm = 1 then
	if cbx_credit.checked and &
			cbx_credit.visible then
		em_rcvd.text = ""
		drcvd = 0
	else
		if this.sigrandamttorcvdamt = "Y" then
			em_rcvd.text = string(dec(em_grandamt.text))
			drcvd = dec(em_rcvd.text)
		else
			em_rcvd.text = string(dnetamt - ddisc)
			drcvd = dnetamt - ddisc
		end if
	end if
end if

dbal = dnetamt - ddisc - drcvd
em_balance.text = string(round(dbal,2))

if dnetamt < 0 then
	st_rcvd.text = "Paid :"
else
	st_rcvd.text = "Total Rcvd :"
end if

if dbal > 0 and &
		year(date(em_duedate.text)) < 1940 then
	if profilestring(gsinifile,"Software","DueDateCurDate","N") = "Y" then
		em_duedate.text = string(today())
	end if
end if

em_netbalance.text = string(dec(em_ob.text) + dec(em_balance.text))

return 1
end function

public  function dec qtnprint_sreturn (long rjob,int rprnlang,int rbillform,string rcondense,string rheadenglish,string rrateprint,long rslno,dec rtotal,string rhead,string rtype);
long lslno
long ljob
long ltrow
long lrow
dec dtotwstg
dec dtnetwgt
dec dtstwgt
dec dtotal
dec dweight
dec dstwgt
boolean beof
string scode
string sname
string sregional
string sjcode
string sitemtype
string skdm
string sprintzero
string sprinttotalwgt
int iqty
int istone
int iform2form
dec dstprice
dec dmcharge
dec dwastage
dec damount
dec drate
dec dnetwgt
dec dvaladd
dec dtnwgtg
dec dtnwgts
dec dsretamt
dec dtvaladd
dec dtamt

sprintzero = profilestring(gsinifile,"Software","PrintZeros","N")
sprinttotalwgt = profilestring(gsinifile,"Software","PrintTotalWgt","N")
iform2form = profileint(gsinifile,"Software","PrintForm2Form",1)
lslno = rslno
ljob = rjob
dtotal = rtotal
dtotwstg = 0
dtnetwgt = 0
dtstwgt = 0
beof = false

if rtype = "E" then
	if rbillform = 1 then
		prn.print(0,"",0)

		if rhead = "" then
			prn.print(0,"Sales Return",0)
			prn.print(0,fill("=",12),0)
		else
			prn.print(0,rhead,0)
			prn.print(0,fill("=",len(rhead)),0)
		end if
	else
		if rcondense <> "Y" and &
				iform2form = 1 then
		end if

		prn.print(0,"",0)

		if rhead = "" then
			prn.print(0,"Sales Return",0)
			prn.print(0,fill("=",12),0)
		else
			prn.print(0,rhead,0)
			prn.print(0,fill("=",len(rhead)),0)
		end if
	end if
end if

sprintshead_dos(rbillform,rcondense,rheadenglish,rrateprint,"R",0)
beof = false
dtnwgtg = 0
dtnwgts = 0
dsretamt = 0
dtvaladd = 0
dtotwstg = 0
ltrow = upperbound(strsreturn)
lrow = 1

do while lrow <= ltrow
	scode = strsreturn[lrow].itemcode
	sname = strsreturn[lrow].itemname
	iqty = strsreturn[lrow].qty
	dweight = strsreturn[lrow].weight
	dstwgt = strsreturn[lrow].stonewgt
	dstprice = strsreturn[lrow].stoneprice
	dmcharge = strsreturn[lrow].mcharge
	dwastage = strsreturn[lrow].wastage
	damount = strsreturn[lrow].amount
	drate = strsreturn[lrow].rate

	select regionalname , itype 
	into :sregional, :sitemtype
	from items
	where code = :scode;

	scode = trim(scode)
	sname = trim(sname)
	sregional = trim(sregional)

	if rprnlang = 2 then
		sname = sregional

		if rbillform = 1 then
			printsetfont(ljob,1)
		else
			printsetfont(ljob,5)
		end if
	end if

	if rbillform = 1 then
		iqty = round(iqty,0)

		if isnull(dweight) then
			dweight = 0
		end if

		dweight = round(dweight,3)

		if isnull(drate) then
			drate = 0
		end if

		drate = round(drate,2)
		dstwgt = round(dstwgt,3)
		dnetwgt = round(dweight - dstwgt,3)
		dstprice = round(dstprice,2)
		dmcharge = round(dmcharge,2)
		dwastage = round(dwastage,3)
		dvaladd = round(dwastage * drate + dmcharge,2)
		damount = round(damount,2)

		if sitemtype = "G" then
			dtnwgtg += dweight
		else
			if sitemtype = "S" then
				dtnwgts += dweight
			end if
		end if

		sname = trim(left(sname,16))
		prn.print(0,sname,17)
		prn.print(0,ftrans(drate,6,2),25)
		prn.print(0,ftrans(iqty,3,0),29)
		prn.print(0,ftrans(dweight,7,3),37)

		if dstwgt > 0 then
			prn.print(0,ftrans(dstwgt,6,3),44)
		else
			if sprintzero = "Y" then
				prn.print(0,ftrans(dstwgt,6,3),44)
			end if
		end if

		prn.print(44,ftrans(dnetwgt,8,3),55)

		if dstprice > 0 then
			prn.print(0,ftrans(dstprice,6,2),62)
		else
			if sprintzero = "Y" then
				prn.print(0,ftrans(dstprice,6,2),62)
			end if
		end if

		prn.print(62,ftrans(dvaladd,7,2),70)
		prn.print(0,ftrans(damount,10,2),0)

		if isnull(dvaladd) then
			dvaladd = 0
		end if

		dtvaladd += dvaladd
		dsretamt += damount
	else
		if rbillform = 2 then
			iqty = round(iqty,0)

			if isnull(dweight) then
				dweight = 0
			end if

			dweight = round(dweight,3)

			if isnull(drate) then
				drate = 0
			end if

			drate = round(drate,2)
			dstwgt = round(dstwgt,3)
			dnetwgt = round(dweight - dstwgt + dwastage,3)
			dstprice = round(dstprice,2)
			dmcharge = round(dmcharge,2)
			dwastage = round(dwastage,3)

			if iform2form = 1 then
				dvaladd = round(dmcharge + dstprice,2)
			else
				dvaladd = round(dmcharge,2)
			end if

			damount = round(damount,2)

			if sitemtype = "G" then
				dtnwgtg += dweight
			else
				if sitemtype = "S" then
					dtnwgts += dweight
				end if
			end if

			if skdm = "Y" then
				if rprnlang = 1 then
					sname = trim(sname) + "[KDM]"
				else
					sname = trim(sname) + "(sI.Un.Fw.)"
				end if
			else
				if skdm = "9" then
					sname = trim(sname) + "(916)"
				end if
			end if

			sname = trim(left(sname,12))
			prn.print(0,sname,12)
			prn.print(0,ftrans(drate,6,2),18)
			prn.print(0,ftrans(iqty,3,0),21)
			prn.print(0,ftrans(dweight,8,3),30)

			if dstwgt > 0 then
				prn.print(0,ftrans(dstwgt,6,3),37)
			else
				if sprintzero = "Y" then
					prn.print(0,ftrans(dstwgt,6,3),37)
				end if
			end if

			prn.print(37,ftrans(dwastage,6,3),45)
			prn.print(0,ftrans(dnetwgt,8,3),54)

			if iform2form = 2 then
				if dstprice > 0 or &
						sprintzero = "Y" then
					prn.print(0,ftrans(dstprice,7,2),62)
				else
					prn.print(0,"",62)
				end if

				prn.print(0,ftrans(dvaladd,8,2),70)
			else
				prn.print(0,ftrans(dnetwgt * drate,9,2),64)
				prn.print(0,ftrans(dvaladd,7,2),70)
			end if

			if iform2form = 2 then
				prn.print(0,ftrans(damount,10,2),0)
			else
				prn.print(71,ftrans(damount,10,2),0)
			end if

			if isnull(dvaladd) then
				dvaladd = 0
			end if

			dtvaladd += dvaladd
			dsretamt += damount
			dtotwstg += dwastage
		end if
	end if

	lrow ++
loop

prn.print(0,fill("-",80),0)
prn.print(0,"Total    : ",20)

if rbillform = 1 then
	prn.print(26,ftrans(dtnwgtg,10,3),61)

	if profilestring(gsinifile,"Software","PrintTotalVA","Y") = "Y" then
		prn.print(0,ftrans(dtvaladd,8,2),70)
	else
		prn.print(0,"",70)
	end if

	prn.print(0,ftrans(dsretamt,10,2),0)
else
	if profilestring(gsinifile,"Software","PrintTotalWastage","Y") = "Y" then
		prn.print(20,ftrans(dtnwgtg,9,3),37)
		prn.print(0,ftrans(dtotwstg,6,3),62)
	else
		prn.print(20,ftrans(dtnwgtg,9,3),62)
	end if

	if profilestring(gsinifile,"Software","PrintTotalMC","Y") = "Y" then
		if iform2form = 2 then
			prn.print(0,ftrans(dtvaladd,8,2),70)
		else
			prn.print(63,ftrans(dtvaladd,8,2),71)
		end if
	else
		prn.print(0,"",70)
	end if

	if iform2form = 2 then
		prn.print(0,ftrans(dsretamt,10,2),0)
	else
		prn.print(71,ftrans(dsretamt,10,2),0)
	end if
end if

if dtnwgts > 0 then
	if rbillform = 1 then
		prn.print(10,"Silver wgt",24)
	else
		prn.print(7,"Silver wgt",20)
	end if

	prn.print(24,ftrans(dtnwgts,9,3),0)
end if

if rtype = "E" then
	dtotal -= dsretamt
else
	dtotal += dsretamt
end if

return dtotal
end function

public  function dec qtnprint_exchange (long rjob,int rprnlang,int rbillform,string rcondense,string rheadenglish,string rrateprint,long rslno,dec rtotal,string rhead,string rtype);
long lslno
long ljob
long ltrow
long lrow
dec dtotexwgt
dec dtotexwgt2
dec dlesswgt
dec dtotogwgt
dec dweight
dec dstwgt
boolean beof
string scode
string sname
string sregional
string sjcode
string sitemtype
string skdm
int iqty
int istone
dec dtpamt
dec dlessperc
dec damount
dec drate
dec dnetwgt
dec dvaladd
dec dtnwgtg
dec dtnwgts
dec dtotal
dec dtvaladd
dec dtamt
dec dstprice
dec dmud
string smudshow

smudshow = profilestring(gsinifile,"Software","MudShowInPrint","N")
lslno = rslno
ljob = rjob
dtotal = rtotal

if rtype = "E" then
	prn.print(0," ",0)

	if rhead = "" then
		prn.print(0,"Exchange",0)
		prn.print(0,fill("=",8),0)
	else
		prn.print(0,rhead,0)
		prn.print(0,fill("=",len(rhead)),0)
	end if

	prn.print(0,"Item Name",15)
	prn.print(0," Qty",20)
	prn.print(0,"   Weight",30)

	if profilestring(gsinifile,"Software","ExchangeForm","2") = "2" then
		prn.print(0,"",36)
	else
		prn.print(0," Less",36)
	end if

	prn.print(0,"St.Wgt",44)
	prn.print(0,"     Net",54)
	prn.print(0,"  Rate",62)
	prn.print(0,"St.Amt",70)
	prn.print(0,"    Amount",0)
	prn.print(20,"   in gms",30)
	prn.print(0,"  wgt",44)
	prn.print(0,"  weight",0)
end if

prn.print(0,fill("-",80),0)
beof = false
dtotexwgt = 0
dtotexwgt2 = 0
ltrow = upperbound(strexchange)
lrow = 1

do while lrow <= ltrow
	scode = strexchange[lrow].itemcode
	sname = strexchange[lrow].itemname
	iqty = strexchange[lrow].qty
	dweight = strexchange[lrow].weight
	dstwgt = strexchange[lrow].stonewgt
	dstprice = strexchange[lrow].stoneprice
	dlesswgt = strexchange[lrow].lesswgt
	damount = strexchange[lrow].amount
	drate = strexchange[lrow].rate
	dmud = strexchange[lrow].mud

	select regionalname , itype 
	into :sregional, :sitemtype
	from items
	where code = :scode;

	scode = trim(scode)

	if rprnlang = 2 then
		sname = trim(sregional)
	else
		sname = trim(sname)
	end if

	if isnull(dmud) then
		dmud = 0
	end if

	iqty = round(iqty,0)

	if smudshow = "N" then
		dweight = round(dweight - dmud,3)
	else
		dlesswgt += dmud
	end if

	dlesswgt = round(dlesswgt,3)
	dnetwgt = round(dweight - dlesswgt - dstwgt,3)
	damount = round(damount,2)
	dtotogwgt += dweight
	dtpamt += damount
	prn.print(0,sname,15)
	dlessperc = dlesswgt / dweight * 100
	prn.print(0,ftrans(iqty,4,0),20)
	prn.print(0,ftrans(dweight,9,3),30)

	if profilestring(gsinifile,"Software","PrintDepPerc","N") = "Y" and &
			dlesswgt > 0 then
		dlessperc = dlesswgt / dweight * 100
		prn.print(0,ftrans(dlesswgt,5,3) + " " + string(dlessperc,"##") & 
				+ "%",36)
	else
		prn.print(0,ftrans(dlesswgt,5,3),36)
	end if

	prn.print(0,ftrans(dstwgt,6,3),43)
	prn.print(0,ftrans(dnetwgt,9,3),54)
	prn.print(0,ftrans(drate,6,2),62)
	prn.print(0,ftrans(dstprice,6,2),70)
	prn.print(0,ftrans(damount,10,2),0)
	dtotexwgt += dweight
	dtotexwgt2 += dnetwgt
	lrow ++
loop

prn.print(0,fill("-",80),0)
prn.print(0,"Total      : ",20)

if gsids = "Nj" or &
		gsids = "Ga" then
	prn.print(0," ",70)
else
	prn.print(0,ftrans(dtotexwgt,9,3),43)
	prn.print(0,ftrans(dtotexwgt2,9,3),70)
end if

prn.print(0,ftrans(dtpamt,10,2),0)
prn.print(0,fill("=",80),0)

if rtype = "E" then
	dtotal -= dtpamt
else
	dtotal += dtpamt
end if

return dtotal
end function

public  function int bcodechk (int rrow);
string scode
string sdmdunit
string sitype
string sstk
string sstkinnos
string spart
string sqtype
string sscode
string stmp
string staxint
string sqtype2
string smodel
string svaoffer
string shuid
longlong lbcode
int iqty
int iret
int idmdnos
int irow
dec dwgt
dec dwastage
dec dstwgt
dec dstprice
dec dmcrate
dec dmcamt
dec ddmdamt
dec ddmdwgt
dec dtaxperc
dec dastperc
dec drate
dec dvap
dec dmcamt2
dec dtamt
dec dgrate
dec dstktouch
dec dcost
dec dttouch
dec dmccost
dec dcperc

if profilestring(gsinifile,"Software","BarcodeCutLastDigit","N") = "Y" then
	scode = trim(dw_sale.gettext())
	lbcode = longlong(mid(scode,1,len(scode) - 1))
else
	lbcode = longlong(dw_sale.gettext())
end if

iret = 1

select icode , qty , weight , stweight , stprice , wastage , mcrate , mc , rate , vap , stk , tamt , stkinnos , part , qtype , stktouch , cost , transtouch , smithcode , costmc , model , costperc , huid 
into :scode, :iqty, :dwgt, :dstwgt, :dstprice, :dwastage, :dmcrate, :dmcamt, :drate, :dvap, :sstk, :dtamt, :sstkinnos, :spart, :sqtype, :dstktouch, :dcost, :dttouch, :sscode, :dmccost, :smodel, :dcperc, :shuid
from barcode
where bcode = :lbcode;

if sqlca.sqlcode = 0 then
	if this.sibccompulsory = "Y" and &
			sstk = "N" then
		messagebox("Warning","No Stock in this barcode...")

		return iret
	else
		irow = dw_sale.find("bcode = " + string(lbcode),1,100)

		if irow > 0 and &
				irow <> rrow and &
				this.sibccompulsory = "Y" then
			messagebox("Warning","This barcode already entered ...")

			return iret
		end if
	end if

	select itype , taxinternal , defquality , vaoffer 
	into :sitype, :staxint, :sqtype2, :svaoffer
	from items
	where code = :scode;

	if isnull(sqtype) then
		sqtype = ""
	end if

	if isnull(sqtype2) then
		sqtype2 = ""
	end if

	dastperc = gdastperc

	if cbx_cst.checked then
		dastperc = 0
	end if

	if svaoffer = "Y" then
		dmcrate = 0
		dmcamt = 0
		dvap = 0
	end if

	if sqtype = "" then
		sqtype = sqtype2
	end if

	if gsinternationalrate = "Y" and &
			sqtype <> "" then
		dgrate = 0

		select rate 
		into :dgrate
		from itemsqtype
		where code = :sqtype;
	end if

	if left(trim(sqtype),2) = "18" and &
			sitype = "G" and &
			dgrate = 0 then
		dgrate = gdg18rate
	else
		if dgrate = 0 then
			dgrate = gdgrate
		end if
	end if

	if dvap > 0 then
		if sitype = "G" or &
				sitype = "D" then
			dmcrate = (dgrate * dvap) / 100
		else
			if sitype = "S" then
				dmcrate = (gdsrate * dvap) / 100
			else
				if sitype = "P" then
					dmcrate = (gdprate * dvap) / 100
				end if
			end if
		end if
	end if

	if dtamt > 0 then
		if staxint = "Y" then
			dtaxperc = dec(em_taxperc.text)
			dtamt = (dtamt * 100) / (100 + dtaxperc + dastperc)
		end if

		if this.siautorearangemcstamt = "Y" then
			if sitype = "G" or &
					sitype = "D" then
				dmcamt = dtamt - (dwgt - dstwgt) * dgrate
			else
				if sitype = "S" then
					dmcamt = dtamt - (dwgt - dstwgt) * gdsrate
				else
					if sitype = "P" then
						dmcamt = dtamt - (dwgt - dstwgt) * gdprate
					end if
				end if
			end if

			if dstprice > 0 then
				if dmcamt - dstprice > 0 then
					dmcamt -= dstprice
				else
					dstprice = dmcamt
					dmcamt = 0
				end if
			else
				if this.dimaxmcperc > 0 and &
						dstwgt > 0 then
					dstprice = dmcamt - round((dmcamt * this.dimaxmcperc) / 100,0)
					dmcamt -= dstprice
				end if
			end if

			if dmcamt < 0 then
				dmcamt = 0
			end if

			if dstprice < 0 then
				dstprice = 0
			end if
		end if
	end if

	dmcamt2 = dmcamt

	if dmcamt = 0 and &
			dmcrate > 0 then
		dmcamt = (dwgt - dstwgt) * dmcrate
	else
		if dmcamt > 0 and &
				dwgt - dstwgt > 0 then
			dmcrate = dmcamt / (dwgt - dstwgt)
		end if
	end if

	select dmdamt , dmdwgt , dmdunit , dmdnos 
	into :ddmdamt, :ddmdwgt, :sdmdunit, :idmdnos
	from barcodedmd
	where bcode = :lbcode;

	if isnull(ddmdamt) then
		ddmdamt = 0
	end if

	if isnull(ddmdwgt) then
		ddmdwgt = 0
	end if

	if isnull(idmdnos) then
		idmdnos = 0
	end if

	dw_sale.setitem(rrow,"bcode",lbcode)
	dw_sale.setitem(rrow,"itemcode",scode)

	if spart <> "" and &
			not isnull(spart) then
		dw_sale.setitem(rrow,"itemname",spart)
	end if

	dw_sale.setitem(rrow,"qty",iqty)
	dw_sale.setitem(rrow,"iqtype",sqtype)
	dw_sale.setitem(rrow,"model",smodel)
	dw_sale.setitem(rrow,"weight",dwgt)
	dw_sale.setitem(rrow,"stonewgt",dstwgt)
	dw_sale.setitem(rrow,"stoneprice",dstprice)
	dw_sale.setitem(rrow,"wstgrate",dwastage)
	dw_sale.setitem(rrow,"mcrate",dmcrate)
	dw_sale.setitem(rrow,"mcharge",dmcamt)
	dw_sale.setitem(rrow,"bcmcamt",dmcamt2)
	dw_sale.setitem(rrow,"dmdamt",ddmdamt)
	dw_sale.setitem(rrow,"dmdwgt",ddmdwgt)
	dw_sale.setitem(rrow,"dmdnos",idmdnos)
	dw_sale.setitem(rrow,"dmdunit",sdmdunit)
	dw_sale.setitem(rrow,"stktouch",dstktouch)
	dw_sale.setitem(rrow,"cost",dcost)
	dw_sale.setitem(rrow,"ttouch",dttouch)
	dw_sale.setitem(rrow,"scode",sscode)
	dw_sale.setitem(rrow,"mccost",dmccost)
	dw_sale.setitem(rrow,"vaperc",dvap)
	dw_sale.setitem(rrow,"bcitem",scode)
	dw_sale.setitem(rrow,"pcostperc",dcperc)
	dw_sale.setitem(rrow,"huid",shuid)

	if dtamt > 0 then
		dw_sale.setitem(rrow,"amount",dtamt)

		if dwgt - dstwgt > 0 then
			drate = (dtamt - dmcamt - dstprice - ddmdamt) / (dwgt - dstwgt)
		else
			drate = dtamt - dmcamt - dstprice - ddmdamt
		end if
	end if

	if sstkinnos = "Y" then
		dw_sale.setitem(rrow,"stkinnos","Y")

		if dtamt > 0 then
			drate = dtamt
		end if
	end if

	if drate > 0 then
		if staxint = "Y" then
			dtaxperc = dec(em_taxperc.text)
			drate = (drate * 100) / (100 + dtaxperc + dastperc)
		end if

		dw_sale.setitem(rrow,"rate",drate)
	end if

	stmp = ""

	if dttouch > 0 or &
			sscode <> "" then
		stmp = "TT:" + string(dttouch,"####0.##") + "-S:" & 
				+ sscode
	end if

	if dmccost > 0 then
		stmp = stmp + " MCC:" + string(dmccost,"#####0.00")
	end if

	st_cas.text = stmp
else
	iret = 0
end if

return iret
end function

public function long saveproc (string rtype);
int irow
int itrow
int iadjqty
int ijewl
int ifrcount
int isplitbill
int iqty
dec damt
dec dbamt
dec dexamt
dec dtaxamt
dec dsretamt
dec dob
dec dtaxable
dec dnetamt2
dec dast
dec ddisc2
dec dgrate
dec dastperc
dec dwstgchk
dec dmcchk
dec dnetwgtchk
dec dwstgrate
dec dmcrate
dec ddisc
dec dtwgt
dec dadjwgt
dec dretdisc
dec dwgt
dec dbcharge
dec dhmc
dec dadv
dec dtax5
dec dtax5perc
dec dccamt
dec dtva
dec dthrate
dec dast5
dec dminvaperc
dec dbamt2
dec dvaperc
dec dminvaperc2
string scode
string scustcode
string ssmcode
string sadjitem
string scalcwacost
string sstkinnos
string stmp
string sname
string spref
string slen
string sstate
string sucode
string scounter
string saddr
string snote
string scbcode
string sopaccode
string svasepac
string smob
string sbccomp
string sog
string sapprovedby
string stin
string sstonemust
boolean bsave = true
str_tran strsales[]
string stype
string scustname
string sbillno
string saccode
string sacpart
string sbatch
string scst
string sprintwanda
string schqno
string schqbank
string schqpdc
long ljob
int istatus
int iprintok
dec dnetwgt
dec dvaladn
dec dacamt
dec dtvaladn
dec dtamt
dec dtbamt
dec drcvd
dec dbalance
dec dnetamt
dec dchqamt
dec dtwgtg
dec dtwgts
date dtdate
date dtduedate
date dtdate2
date dtduedate2
date dtbdate
date dtchqdate
time ttime
int icontrol
long lslno
long lbillno
long lslno2
long lbillno2
long lexchslno
long lretnslno
long ltmp
dec dpaidamt
dec dtpamt = 0
dec dsgst
dec dcgst
dec digst
dec dsgst2
dec dcgst2
dec digst2
int iterows
int itsrrows
dec dtaxperc
dec dsilverrate
dec dgoldrate
dec drcamt
dec dcardamt
dec dredmpoints
dec djewlamt
dec dpnetwgt
dec drcvdafter
dec dstwgt
dec dcwgt
dec dccost
dec ddiscperc
dec dtcsperc
dec dtcsamt
int itmp
int ijcount
int idistance
boolean bjfind
string stype1
string scode1
string scocode
string sfr
string sbilltype
string sloan
string saddbcharge
string spdocno
string ssrdocno
string sshowwgt
string sws
string sagent
string spos
string span
string sccpdc
dec dcost
dec dcurstock
dec dwacost
dec dcost1 = 0
dec dround
dec dptaxperc
dec dptax
dec dfancyamt
dec dschmamt
dec dbcperc
string sdstatus = "Delivered"
string ssecnote = ""
string sdparm = ""
string svehno
dec dsecwgt = 0
strcamt strjamt[]
boolean beof
dec dweight
string sjewlcode
string sstktype
string sttype
longlong lbcode
date dtccpdcdt
string spend2
dec dcomn
dec dcomntax
dec dbcomn
dec dbcomntax
string spend
string snerr
string spcode
dec dtmpjewlamt = 0
dec dtmptotjewlamt = 0
dec dcostamt
dec dtcostamt
dec dprof
dec dtprof
string supdpart
date dtupddate
time dtupdtime

declare cursors cursor for
 select code , qty , weight , stonewgt , jcode , bcode , stktype from salesd where slno = :lslno ;

declare cursorp cursor for
 select code , qty , weight , stwgt , cost , stktype from purchased where slno = :lslno ;

declare cursorr cursor for
 select code , qty , weight , stonewgt , stktype , bcode from salesrd where slno = :lslno ;

cb_save.enabled = false
em_balance.setfocus()
scalcwacost = profilestring(gsinifile,"Software","CalcWACost","Y")
svasepac = profilestring(gsinifile,"Software","VASepAc","N")

select minvaperc 
into :dminvaperc
from userm
where code = :gsuserid;

if isnull(dminvaperc) then
	dminvaperc = 0
end if

dbamt = 0
dexamt = 0
dsretamt = 0
dtwgt = 0
ifrcount = 0
dtaxable = 0
dsretamt = dec(em_sreturn.text)
scustcode = trim(dw_1.gettext())
ssmcode = dw_smcode.getitemstring(1,"code")

if isnull(ssmcode) then
	ssmcode = ""
end if

if isnull(scustcode) then
	scustcode = ""
end if

scounter = trim(dw_counter.getitemstring(1,1))

if isnull(scounter) then
	scounter = ""
end if

ddisc = dec(em_discount.text)
dbamt2 = dec(em_billtotal.text)
dgrate = dec(em_rate.text)
dthrate = this.dithrate
dtva = 0
irow = 1
itrow = dw_sale.rowcount()

do while irow <= itrow
	scode = dw_sale.getitemstring(irow,"itemcode")

	if isnull(scode) or &
			trim(scode) = "" then
		dw_sale.deleterow(irow)
	else
		scode = trim(scode)
		ijewl = dw_sale.getitemnumber(irow,"jewl")
		strsales[irow].itemcode = scode
		strsales[irow].itemname = left(trim(dw_sale.getitemstring(irow,"itemname")),30)
		strsales[irow].qty = dw_sale.getitemnumber(irow,"qty")
		strsales[irow].rate = dw_sale.getitemdecimal(irow,"rate")
		strsales[irow].weight = dw_sale.getitemdecimal(irow,"weight")
		strsales[irow].wastage = dw_sale.getitemdecimal(irow,"wastage")
		strsales[irow].mcharge = dw_sale.getitemdecimal(irow,"mcharge")
		strsales[irow].stoneprice = dw_sale.getitemdecimal(irow,"stoneprice")
		strsales[irow].stonewgt = dw_sale.getitemdecimal(irow,"stonewgt")
		strsales[irow].amount = dw_sale.getitemdecimal(irow,"amount")
		strsales[irow].itemtype = dw_sale.getitemstring(irow,"itemtype")
		strsales[irow].jewlcode = dw_sale.getitemstring(irow,"jewlcode")
		strsales[irow].kdm = dw_sale.getitemstring(irow,"kdm")
		strsales[irow].cost = dw_sale.getitemdecimal(irow,"cost")
		strsales[irow].adjitem = dw_sale.getitemstring(irow,"adjitem")
		strsales[irow].adjtype = dw_sale.getitemstring(irow,"adjtype")
		strsales[irow].adjwgt = dw_sale.getitemdecimal(irow,"adjwgt")
		strsales[irow].adjqty = dw_sale.getitemnumber(irow,"adjqty")
		strsales[irow].jrate = dw_sale.getitemnumber(irow,"jrate")
		strsales[irow].jva = dw_sale.getitemnumber(irow,"jva")
		strsales[irow].stkinnos = dw_sale.getitemstring(irow,"stkinnos")
		strsales[irow].bcode = dw_sale.getitemnumber(irow,"bcode")
		strsales[irow].dmdwgt = dw_sale.getitemdecimal(irow,"dmdwgt")
		strsales[irow].dmdamt = dw_sale.getitemdecimal(irow,"dmdamt")
		strsales[irow].dmdunit = dw_sale.getitemstring(irow,"dmdunit")
		strsales[irow].dmdnos = dw_sale.getitemnumber(irow,"dmdnos")
		strsales[irow].fr = dw_sale.getitemnumber(irow,"fr")
		strsales[irow].rmno = dw_sale.getitemstring(irow,"rmno")
		strsales[irow].stkfd = dw_sale.getitemstring(irow,"stkfd")
		strsales[irow].stktype = dw_sale.getitemstring(irow,"stktype")
		strsales[irow].iqtype = dw_sale.getitemstring(irow,"iqtype")
		strsales[irow].stktouch = dw_sale.getitemnumber(irow,"stktouch")
		strsales[irow].mperc = dw_sale.getitemnumber(irow,"vaperc")
		strsales[irow].model = dw_sale.getitemstring(irow,"model")
		strsales[irow].note = dw_sale.getitemstring(irow,"note")
		strsales[irow].huid = dw_sale.getitemstring(irow,"huid")

		if isnull(strsales[irow].weight) then
			strsales[irow].weight = 0
		end if

		if isnull(strsales[irow].wastage) then
			strsales[irow].wastage = 0
		end if

		if isnull(strsales[irow].mcharge) then
			strsales[irow].mcharge = 0
		end if

		if isnull(strsales[irow].stoneprice) then
			strsales[irow].stoneprice = 0
		end if

		if isnull(strsales[irow].stonewgt) then
			strsales[irow].stonewgt = 0
		end if

		if isnull(strsales[irow].weight) then
			strsales[irow].weight = 0
		end if

		if isnull(strsales[irow].rate) then
			strsales[irow].rate = 0
		end if

		if isnull(strsales[irow].qty) then
			strsales[irow].qty = 0
		end if

		if isnull(strsales[irow].cost) then
			strsales[irow].cost = 0
		end if

		if isnull(strsales[irow].adjitem) then
			strsales[irow].adjitem = ""
		end if

		if isnull(strsales[irow].adjqty) then
			strsales[irow].adjqty = 0
		end if

		if isnull(strsales[irow].adjwgt) then
			strsales[irow].adjwgt = 0
		end if

		if isnull(strsales[irow].jewlcode) then
			strsales[irow].jewlcode = ""
		end if

		if isnull(strsales[irow].jva) then
			strsales[irow].jva = 0
		end if

		if isnull(strsales[irow].jrate) then
			strsales[irow].jrate = 0
		end if

		if isnull(strsales[irow].stkinnos) then
			strsales[irow].stkinnos = "N"
		end if

		if isnull(strsales[irow].bcode) then
			strsales[irow].bcode = 0
		end if

		if isnull(strsales[irow].dmdwgt) then
			strsales[irow].dmdwgt = 0
		end if

		if isnull(strsales[irow].dmdnos) then
			strsales[irow].dmdnos = 0
		end if

		if isnull(strsales[irow].dmdamt) then
			strsales[irow].dmdamt = 0
		end if

		if isnull(strsales[irow].dmdunit) then
			strsales[irow].dmdunit = ""
		end if

		if isnull(strsales[irow].fr) then
			strsales[irow].fr = 0
		end if

		if isnull(strsales[irow].rmno) then
			strsales[irow].rmno = ""
		end if

		if isnull(strsales[irow].stkfd) then
			strsales[irow].stkfd = ""
		end if

		if isnull(strsales[irow].stktype) then
			strsales[irow].stktype = ""
		end if

		if isnull(strsales[irow].iqtype) then
			strsales[irow].iqtype = ""
		end if

		if isnull(strsales[irow].stktouch) then
			strsales[irow].stktouch = 100
		end if

		if isnull(strsales[irow].mperc) then
			strsales[irow].mperc = 0
		end if

		if isnull(strsales[irow].model) then
			strsales[irow].model = ""
		end if

		if isnull(strsales[irow].note) then
			strsales[irow].note = ""
		end if

		if isnull(strsales[irow].huid) then
			strsales[irow].huid = ""
		end if

		if cbx_updtfr.checked then
			strsales[irow].fr = 1
		end if

		if isnull(ijewl) or &
				ijewl = 0 then
			strsales[irow].jewlcode = ""
			strsales[irow].jrate = 0
			strsales[irow].jva = 0
		end if

		ifrcount += strsales[irow].fr

		if strsales[irow].weight <= 0 and &
				strsales[irow].stkinnos = "N" then
			bsave = false
			messagebox("Warning","Check Weight (" + trim(scode) + ").You can't Proceed...",stopsign!,ok!)
			dw_sale.setrow(irow)
			dw_sale.setcolumn("weight")
			dw_sale.setfocus()
			exit
		end if

		if strsales[irow].rate <= 0 then
			bsave = false
			messagebox("Warning","Check Rate (" + trim(scode) + ").You can't Proceed...",stopsign!,ok!)
			dw_sale.setrow(irow)
			dw_sale.setcolumn("rate")
			dw_sale.setfocus()
			exit
		end if

		if profilestring(gsinifile,"Software","StktypeStrict","N") = "Y" and &
				strsales[irow].stktype = "" then
			messagebox("Warning","Check Stock Type (" + trim(scode) + ").You can't save...",stopsign!,ok!)
			dw_sale.setrow(irow)
			dw_sale.setcolumn("weight")
			dw_sale.setfocus()
			this.stktypechk()
			bsave = false
			exit
		end if

		if strsales[irow].qty <= 0 then
			if strsales[irow].itemtype = "G" and &
					profilestring(gsinifile,"Software","QtyWarning","Y") = "Y" then
				messagebox("Warning","Check qty (" + trim(scode) + ").",information!,ok!)

				if gsstrictchk = "Y" then
					bsave = false
					dw_sale.setrow(irow)
					dw_sale.setcolumn("qty")
					dw_sale.setfocus()
					exit
				end if
			else
				if strsales[irow].itemtype = "S" or &
						strsales[irow].itemtype = "O" then
					if profilestring(gsinifile,"Software","QtyWarning","Y") = "Y" then
						messagebox("Warning","Check qty (" + trim(scode) + ").",information!,ok!)
					end if
				end if
			end if
		end if

		if strsales[irow].wastage > 0 and &
				strsales[irow].mcharge <= 0 and &
				this.sivamodel = "N" then
			messagebox("Warning","Check Wastage and MC (" + trim(scode) + ").",information!,ok!)

			if gsstrictchk = "Y" then
				bsave = false
				dw_sale.setrow(irow)
				dw_sale.setcolumn("wastage")
				dw_sale.setfocus()
				exit
			end if
		end if

		if strsales[irow].stonewgt > 0 and &
				strsales[irow].stoneprice <= 0 then
			messagebox("Warning","Check Stone Price (" + trim(scode) + ").",information!,ok!)

			if gsstrictchk = "Y" then
				bsave = false
				dw_sale.setrow(irow)
				dw_sale.setcolumn("stoneprice")
				dw_sale.setfocus()
				exit
			end if
		end if

		dnetwgtchk = strsales[irow].weight - strsales[irow].stonewgt
		dmcrate = dw_sale.getitemdecimal(irow,"mcrate")

		if isnull(dmcrate) then
			dmcrate = 0
		end if

		if giwastageopt = 1 then
			dwstgchk = round((dnetwgtchk * gdwastage) / 100,3)
		else
			if giwastageopt = 2 then
				dwstgrate = dw_sale.getitemdecimal(irow,"wstgrate")

				if isnull(dwstgrate) then
					dwstgrate = 0
				end if

				dwstgchk = round(dnetwgtchk / 8 * dwstgrate,3)
			end if
		end if

		if this.sivamodel = "Y" then
			dmcchk = mccalc(scode,dnetwgtchk,strsales[irow].qty,strsales[irow].rate,strsales[irow].iqtype)

			if dmcchk = 0 then
				select vaperc 
				into :dmcrate
				from items
				where code = :scode;

				dmcchk = round((dnetwgtchk * strsales[irow].rate * dmcrate) / 100,0)
			end if
		else
			dmcchk = dnetwgtchk * dmcrate
		end if

		if profilestring(gsinifile,"Software","RoundOffAllAmt","N") = "Y" then
			dmcchk = round(dmcchk,0)
		end if

		if strsales[irow].wastage < dwstgchk and &
				this.sivamodel = "N" then
			messagebox("Warning","Wastage is less than " + string(dwstgchk,"###0.000") & 
					+ "(" & 
					+ trim(scode) & 
					+ ").",information!,ok!)

			if gsstrictchk = "Y" then
				bsave = false
				dw_sale.setrow(irow)
				dw_sale.setcolumn("wastage")
				dw_sale.setfocus()
				exit
			end if
		end if

		if strsales[irow].mcharge < dmcchk then
			messagebox("Warning","MC is less than " + string(dmcchk,"###0.000") & 
					+ "(" & 
					+ trim(scode) & 
					+ ").",information!,ok!)

			if gsstrictchk = "Y" then
				bsave = false
				dw_sale.setrow(irow)
				dw_sale.setcolumn("mcharge")
				dw_sale.setfocus()
				exit
			end if
		end if

		if strsales[irow].bcode = 0 then
			select bccompulsory 
			into :sbccomp
			from items
			where code = :strsales[irow].itemcode;

			if sbccomp = "Y" then
				messagebox("Warning","Barcode Compulsory for the item " + strsales[irow].itemcode & 
						+ ".~n You cant continue...",stopsign!,ok!)
				bsave = false
			end if
		end if

		if strsales[irow].stonewgt = 0 then
			select stonemust 
			into :sstonemust
			from items
			where code = :strsales[irow].itemcode;

			if sstonemust = "Y" then
				messagebox("Warning","Stone Compulsory for the item " + strsales[irow].itemcode & 
						+ ".~n You cant continue. Sorry...",stopsign!,ok!)
				bsave = false
			end if
		end if

		if this.siallowinsufstock = "N" and &
				this.saded = "A" then
			if this.seb = "E" then
				select qtyb , weightb 
				into :iqty, :dwgt
				from items
				where code = :strsales[irow].itemcode;
			else
				select qty , weight 
				into :iqty, :dwgt
				from items
				where code = :strsales[irow].itemcode;
			end if

			if strsales[irow].qty > iqty or &
					strsales[irow].weight > dwgt then
				messagebox("Stock Warning","Insufficent Stock for the item " + strsales[irow].itemcode & 
						+ ".~n You cant continue. Sorry...",stopsign!,ok!)
				bsave = false
			end if
		end if

		if strsales[irow].itemtype = "G" then
			dtwgt += strsales[irow].weight
		end if

		dbamt += strsales[irow].amount

		if strsales[irow].fr = 1 then
			dtaxable += strsales[irow].amount
		end if

		dtva += strsales[irow].mcharge + strsales[irow].wastage * strsales[irow].rate

		if dminvaperc > 0 then
			if ddisc > 0 then
				dvaperc = (100 * (strsales[irow].mcharge - (ddisc * strsales[irow].amount) / dbamt2)) / (strsales[irow].amount - strsales[irow].mcharge)
			else
				dvaperc = (100 * strsales[irow].mcharge) / (strsales[irow].amount - strsales[irow].mcharge)
			end if

			if dvaperc < dminvaperc then
				messagebox("VA% Missmatch","Allowed Minimum VA% is out of limit CVA(" & 
						+ string(dvaperc,"#####.##") & 
						+ ")...Row-" & 
						+ string(irow,"###") & 
						+ ".~nAuthorisation needed.....")
				open(w_passverify_modify)
				sucode = message.stringparm
				dminvaperc2 = 0

				select minvaperc 
				into :dminvaperc2
				from userm
				where code = :sucode;

				if isnull(dminvaperc2) then
					dminvaperc2 = 0
				end if

				if dvaperc >= dminvaperc2 then
				else
					if dminvaperc2 > 0 then
						messagebox("Sorry","This VA% is not allowed.",stopsign!)
						bsave = false
						exit
					end if
				end if
			end if
		end if
	end if

	irow += 1
loop

ddisc2 = round((dbamt * this.didiscperc) / 100,0)

if ddisc > ddisc2 + 10 and &
		dtwgt > 0 and &
		gsids = "Nj" and &
		dec(em_rva.text) = 0 then
	messagebox("Warning","Discount should be less than " + string(ddisc2,"####0.00") & 
			+ ".You can't proceed...",stopsign!,ok!)
	bsave = false
	em_discount.setfocus()
end if

if this.seb = "E" and &
		dtaxable > 0 and &
		profilestring(gsinifile,"Software","SplitBills","N") = "Y" and &
		giaccount = 2 and &
		gifupdt = 1 and &
		dtaxable <> dbamt then
	isplitbill = 1
else
	isplitbill = 0
	dtaxable = 0
end if

itrow = upperbound(strexchange)
irow = 1

do while irow <= itrow
	if strexchange[irow].weight > 0 and &
			strexchange[irow].rate <= 0 then
		bsave = false
		messagebox("Warning","Check Exchange Rate (" + trim(strexchange[irow].itemcode) & 
				+ ").You can't proceed...",stopsign!,ok!)
	end if

	dexamt += strexchange[irow].amount
	irow += 1
loop

if dbamt = 0 and &
		dexamt = 0 and &
		dsretamt = 0 then
	bsave = false
	messagebox("Warning","There is no entries. You can't proceed...",stopsign!,ok!)
else
	if dbamt = 0 then
	end if
end if

if giaccount = 1 and &
		gilevel = 1 and &
		trim(scustcode) = "" and &
		real(em_balance.text) <> 0 then
end if

if real(em_balance.text) <> 0 and &
		(trim(scustcode) = "" or &
		isnull(scustcode)) then
	messagebox("Warning","Enter customer for credit sale ",stopsign!,ok!)
	cb_save.enabled = true
	dw_1.setfocus()

	return 0
end if

if real(em_balance.text) > 0 and &
		year(date(em_duedate.text)) < 1980 then
	if profilestring(gsinifile,"Software","DuedateComp","Y") = "Y" then
		messagebox("Warning","Enter Duedate for credit sale ",stopsign!,ok!)
		cb_save.enabled = true
		em_duedate.setfocus()

		return 0
	end if
end if

if not bsave then
	if giaccount = 2 then
	end if

	cb_save.enabled = true

	return 0
end if

setpointer(hourglass!)

if dec(em_balance.text) > 0 then
	if profilestring(gsinifile,"Software","SalesCreditDeliveryStatusChange","N") = "Y" then
		openwithparm(w_sales_status,this.lislno)
		sdparm = message.stringparm

		if isnull(sdparm) then
			sdparm = ""
		end if

		if sdparm <> "" then
			sdstatus = left(sdparm,pos(sdparm,"|") - 1)
			sdparm = mid(sdparm,pos(sdparm,"|") + 1,400)
			dsecwgt = dec(left(sdparm,pos(sdparm,"|") - 1))
			ssecnote = mid(sdparm,pos(sdparm,"|") + 1,400)

			if isnull(dsecwgt) then
				dsecwgt = 0
			end if
		end if
	end if
end if

irow = 1
itrow = dw_sale.rowcount()
dtdate = date(em_date.text)

if profilestring(gsinifile,"Software","UpdateTime","Y") = "Y" then
	ttime = now()
end if

dtduedate = date(em_duedate.text)
lexchslno = 0
lretnslno = 0
dschmamt = 0
dfancyamt = 0

if rtype = "T" or &
		profilestring(gsinifile,"Software","SalesConfirmModel","N") = "Y" then
	icontrol = 3
else
	if this.seb = "B" then
		icontrol = 1
	else
		icontrol = 2
	end if
end if

scustname = trim(st_custname.text)
saddr = trim(sle_addr.text)
smob = trim(sle_mobno.text)

if year(dtduedate) < year(today()) then
	setnull(dtduedate)
end if

scocode = trim(dw_co.gettext())
sbilltype = trim(dw_billtype.getitemstring(1,1))
svehno = trim(sle_vehno.text)
idistance = integer(em_distance.text)
dbamt = dec(em_billtotal.text)
dexamt = dec(em_exchange.text)
dtaxperc = dec(em_taxperc.text)
dtaxamt = dec(em_staxamt.text)
dastperc = dec(em_astperc.text)
dast = dec(em_ast.text)
dtcsperc = dec(em_tcsperc.text)
dtcsamt = dec(em_tcsamt.text)
drcamt = dec(em_rcamt.text)
dsretamt = dec(em_sreturn.text)
dnetamt = dec(em_nettot.text)
ddisc = dec(em_discount.text)
ddiscperc = dec(em_discperc.text)
dredmpoints = dec(em_redmpoints.text)
drcvd = dec(em_rcvd.text)
dbalance = dec(em_balance.text)
dob = dec(em_ob.text)
dnetamt2 = dnetamt - ddisc
dptaxperc = dec(em_ptaxperc.text)
dptax = dec(em_ptaxamt.text)
snote = trim(sle_note.text)
scbcode = dw_cashbank.getitemstring(1,1)

if isnull(scbcode) then
	scbcode = "CASH"
end if

dbcharge = dec(em_bcharge.text)
dhmc = dec(em_hmc.text)
dadv = dec(em_advance.text)
dschmamt = dec(em_schmamt.text)
dfancyamt = dec(em_fancyamt.text)
dround = dnetamt - (dbamt - dexamt - dsretamt + dtaxamt + dast + dtcsamt + dhmc + drcamt - dadv + dfancyamt - dschmamt)
dccamt = dec(em_ccamt.text)
sagent = dw_agent.getitemstring(1,1)

if isnull(sagent) then
	sagent = ""
end if

schqbank = dw_chqbank.getitemstring(1,1)
dchqamt = dec(em_chqamt.text)
schqno = trim(sle_chqno.text)
dtchqdate = date(em_chqdate.text)
spos = trim(sle_pos.text)
span = trim(sle_pan.text)
sstate = dw_state.getitemstring(1,1)
dbcperc = dec(em_bcperc.text)
sapprovedby = dw_approvedby.getitemstring(1,1)

if isnull(sapprovedby) then
	sapprovedby = ""
end if

stin = trim(sle_tin.text)

if cbx_pdc.checked then
	schqpdc = "Y"
else
	schqpdc = "N"
end if

if cbx_ccpdc.checked then
	sccpdc = "Y"
else
	sccpdc = "N"
end if

if cbx_addbc.checked then
	saddbcharge = "Y"
	dround -= dbcharge
else
	saddbcharge = "N"
end if

if cbx_loan.checked then
	sloan = "Y"
else
	sloan = "N"
end if

if cbx_cst.checked then
	scst = "Y"
else
	scst = "N"
end if

if cbx_updtfr.checked then
	sfr = "Y"
else
	sfr = "N"
end if

if cbx_ws.checked then
	sws = "Y"
else
	sws = "N"
end if

if cbx_printwanda.checked then
	sprintwanda = "Y"
else
	sprintwanda = "N"
end if

if gsids = "Afj" then
	if dexamt + dsretamt > 0 and &
			trim(ssmcode) = "" then
		messagebox("Salesman","Salesman is empty...You can't proceed...",stopsign!,ok!)
		cb_save.enabled = true
		dw_smcode.setfocus()

		return 0
	end if
end if

if isnull(dtaxamt) then
	dtaxamt = 0
end if

if dnetamt2 <> drcvd and &
		drcvd = 0 then
	istatus = 1
else
	if dnetamt2 <> drcvd and &
			drcvd <> 0 then
		istatus = 2
	else
		if dnetamt2 = drcvd then
			istatus = 3
		end if
	end if
end if

SELECT cvalue 
INTO :ltmp
FROM generali
WHERE code ='BLOCK';

if sqlca.sqlcode <> 0 then
	insert into generali ( code , cvalue )
	values ( 'BLOCK' , 0 );
end if

update generali
SET cvalue =cvalue + 1
WHERE code ='BLOCK';

if giaccount = 2 then
	if messagebox("Save","Save this bill ?",question!,okcancel!) = 2 then
		cb_save.enabled = true

		rollback;

		return 0
	end if
else
	if messagebox("Continue?","Do you want proceed ?",question!,okcancel!) = 2 then
		cb_save.enabled = true

		rollback;

		return 0
	end if
end if

dtvaladn = 0
dtamt = 0
dtwgts = 0
dtwgtg = 0

if this.saded = "E" then
	sbillno = trim(st_billno.text)
	lslno = this.lislno
	drcvdafter = this.dircvdafter
else
	scode = "SERIALNO"

	SELECT cvalue 
	INTO :lslno
	FROM generali
	WHERE code = :scode;

	if giaccount = 2 and &
			gifupdt = 1 then
		SELECT cvalue 
		INTO :lslno2
		FROM generali
		WHERE code = :scode 
		using transtmp;

		if lslno < lslno2 then
			lslno = lslno2
		end if

		update generali
		SET cvalue = :lslno + 1
		WHERE code = :scode 
		using transtmp;

		commit using transtmp;
	end if

	if giaccount = 2 and &
			gisysupdt = 1 then
		SELECT cvalue 
		INTO :lslno2
		FROM generali
		WHERE code = :scode 
		using transtmpsys;

		if lslno < lslno2 then
			lslno = lslno2
		end if

		update generali
		SET cvalue = :lslno + 1
		WHERE code = :scode 
		using transtmpsys;

		commit using transtmpsys;

		if giaccount = 2 and &
				gifupdt = 1 then
			update generali
			SET cvalue = :lslno + 1
			WHERE code = :scode 
			using transtmp;

			commit using transtmp;
		end if
	end if

	update generali
	SET cvalue = :lslno + 1
	WHERE code = :scode;

	if sqlca.sqlcode <> 0 then
		messagebox("Error","general i makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	else
		commit;
	end if

	lslno += 1

	if profilestring(gsinifile,"Software","SalesFirstQtnNo","N") = "Y" then
		scode = "QTNNO"
	else
		if rtype = "T" then
			if profilestring(gsinifile,"Software","EstimateConfirmModel","N") = "Y" then
				scode = "SALES" + this.seb
			else
				scode = "TSALES" + this.seb
			end if
		else
			if profilestring(gsinifile,"Software","BillTypewiseBillNo","N") = "Y" and &
					this.seb = "B" then
				select prefix 
				into :spref
				from salestype
				where code = :sbilltype;

				scode = "SALES" + spref
			else
				scode = "SALES" + this.seb
			end if
		end if
	end if

	if cbx_manual.checked then
		sbillno = trim(st_billno.text)
	else
		SELECT cvalue 
		INTO :lbillno
		FROM generali
		WHERE code = :scode;

		if giaccount = 2 and &
				gifupdt = 1 and &
				cbx_updtfr.checked and &
				this.seb = "B" then
			SELECT cvalue 
			INTO :lbillno2
			FROM generali
			WHERE code = :scode 
			using transtmp;

			if lbillno < lbillno2 then
				lbillno = lbillno2
			end if
		end if

		update generali
		SET cvalue = :lbillno + 1
		WHERE code = :scode;

		if sqlca.sqlcode <> 0 then
			messagebox("Error","general i makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if

		if profilestring(gsinifile,"Software","EstimateConfirmModel","N") = "Y" and &
				giaccount = 2 and &
				gifupdt = 1 and &
				rtype = "T" and &
				this.seb = "E" then
		end if

		if profilestring(gsinifile,"Software","SalesFirstQtnNo","N") = "Y" then
			sbillno = "Q/" + string(today(),"mmdd") + "/" + string(lbillno + 1,"000")
		else
			if rtype = "T" then
				if profilestring(gsinifile,"Software","EstimateConfirmModel","N") = "Y" then
					select cvalue 
					into :spref
					from generals
					where code ='SEPREF';

					if isnull(spref) then
						spref = "SLE/"
					end if

					select cvalue 
					into :slen
					from generals
					where code ='SELEN';

					if isnull(slen) then
						slen = "5"
					end if

					sbillno = spref + string(lbillno + 1,fill("0",integer(slen)))
				else
					if this.seb = "B" then
						sbillno = "TSB/" + string(lbillno + 1,"00000")
					else
						sbillno = "TSE/" + string(lbillno + 1,"00000")
					end if
				end if
			else
				if profilestring(gsinifile,"Software","BillTypewiseBillNo","N") = "Y" and &
						this.seb = "B" then
					sbillno = spref + string(lbillno + 1,"00000")
				else
					if this.seb = "B" then
						select cvalue 
						into :spref
						from generals
						where code ='SBPREF';

						if isnull(spref) then
							spref = "SLB/"
						end if

						select cvalue 
						into :slen
						from generals
						where code ='SBLEN';

						if isnull(slen) then
							slen = "5"
						end if

						sbillno = spref + string(lbillno + 1,fill("0",integer(slen)))
					else
						select cvalue 
						into :spref
						from generals
						where code ='SEPREF';

						if isnull(spref) then
							spref = "SLE/"
						end if

						select cvalue 
						into :slen
						from generals
						where code ='SELEN';

						if isnull(slen) then
							slen = "5"
						end if

						sbillno = spref + string(lbillno + 1,fill("0",integer(slen)))
					end if
				end if
			end if
		end if
	end if

	iterows = upperbound(strexchange)
	drcvdafter = 0
end if

if this.saded = "E" then
	select sr 
	into :sttype
	from salesm
	where slno = :lslno;

	if sttype = "S" then
		select control 
		into :icontrol
		from salesm
		where slno = :lslno;

		open cursors;      //sqlca

		beof = false

		do while not beof
			fetch cursors into :scode,:iqty,:dweight,:dstwgt,:sjewlcode,:lbcode,:sstktype;      //sqlca

			if sqlca.sqlcode <> 0 then
				beof = true
			end if

			if not beof then
				scode = trim(scode)

				if isnull(iqty) then
					iqty = 0
				end if

				if isnull(dweight) then
					dweight = 0
				end if

				if isnull(dstwgt) then
					dstwgt = 0
				end if

				if trim(sjewlcode) = "" or &
						isnull(sjewlcode) then
					if icontrol = 1 then
						update items
						set qty =qty +  :iqty , qtyb =qtyb +  :iqty , weight =weight +  :dweight , weightb =weightb +  :dweight , stonewgt =stonewgt +  :dstwgt , stonewgtb =stonewgtb +  :dstwgt
						where code = :scode;

						if sstktype <> "" then
							chkstktype(scode,sstktype)

							update itemsstk
							set qty =qty +  :iqty , qtyb =qtyb +  :iqty , weight =weight +  :dweight , weightb =weightb +  :dweight , stonewgt =stonewgt +  :dstwgt , stonewgtb =stonewgtb +  :dstwgt
							where code = :scode and
							stktype = :sstktype;
						end if
					else
						update items
						set qtyb =qtyb +  :iqty , weightb =weightb +  :dweight , stonewgtb =stonewgtb +  :dstwgt
						where code = :scode;

						if sstktype <> "" then
							chkstktype(scode,sstktype)

							update itemsstk
							set qtyb =qtyb +  :iqty , weightb =weightb +  :dweight , stonewgtb =stonewgtb +  :dstwgt
							where code = :scode and
							stktype = :sstktype;
						end if
					end if
				end if
			end if

			if lbcode <> 0 then
				update barcode
				set stk ='Y'
				where bcode = :lbcode;
			end if
		loop

		close cursors;      //sqlca

		open cursorp;      //sqlca

		beof = false

		do while not beof
			fetch cursorp into :scode,:iqty,:dweight,:dstwgt,:dcost,:sstktype;      //sqlca

			if sqlca.sqlcode <> 0 then
				beof = true
			end if

			if not beof then
				scode = trim(scode)

				if icontrol = 1 then
					select weight , cost 
					into :dcwgt, :dccost
					from items
					where code = :scode;
				else
					select weightb , cost 
					into :dcwgt, :dccost
					from items
					where code = :scode;
				end if

				if sstktype <> "" then
					if icontrol = 1 then
						select weight 
						into :dcwgt
						from itemsstk
						where code = :scode and
						stktype = :sstktype;
					else
						select weightb 
						into :dcwgt
						from itemsstk
						where code = :scode and
						stktype = :sstktype;
					end if
				end if

				if dcwgt - dweight > 0 and &
						scalcwacost = "Y" then
					dwacost = (dcwgt * dccost - dweight * dcost) / (dcwgt - dweight)
				else
					dwacost = dccost
				end if

				if isnull(iqty) then
					iqty = 0
				end if

				if isnull(dweight) then
					dweight = 0
				end if

				if icontrol = 1 then
					update items
					set qty =qty -  :iqty , qtyb =qtyb -  :iqty , weight =weight -  :dweight , weightb =weightb -  :dweight , stonewgt =stonewgt -  :dstwgt , stonewgtb =stonewgtb -  :dstwgt , cost = :dwacost
					where code = :scode;

					if sstktype <> "" then
						chkstktype(scode,sstktype)

						update itemsstk
						set qty =qty -  :iqty , qtyb =qtyb -  :iqty , weight =weight -  :dweight , weightb =weightb -  :dweight , stonewgt =stonewgt -  :dstwgt , stonewgtb =stonewgtb -  :dstwgt
						where code = :scode and
						stktype = :sstktype;
					end if

					continue
				end if

				update items
				set qtyb =qtyb -  :iqty , weightb =weightb -  :dweight , stonewgtb =stonewgtb -  :dstwgt , cost = :dwacost
				where code = :scode;

				if sstktype <> "" then
					chkstktype(scode,sstktype)

					update itemsstk
					set qtyb =qtyb -  :iqty , weightb =weightb -  :dweight , stonewgtb =stonewgtb -  :dstwgt , cost = :dwacost
					where code = :scode and
					stktype = :sstktype;
				end if
			end if
		loop

		close cursorp;      //sqlca

		open cursorr;      //sqlca

		beof = false

		do while not beof
			fetch cursorr into :scode,:iqty,:dweight,:dstwgt,:sstktype,:lbcode;      //sqlca

			if sqlca.sqlcode <> 0 then
				beof = true
			end if

			if not beof then
				scode = trim(scode)

				if isnull(iqty) then
					iqty = 0
				end if

				if isnull(dweight) then
					dweight = 0
				end if

				if isnull(dstwgt) then
					dstwgt = 0
				end if

				if icontrol = 1 then
					update items
					set qty =qty -  :iqty , qtyb =qtyb -  :iqty , weight =weight -  :dweight , weightb =weightb -  :dweight , stonewgt =stonewgt -  :dstwgt , stonewgtb =stonewgtb -  :dstwgt
					where code = :scode;

					if sstktype <> "" then
						chkstktype(scode,sstktype)

						update itemsstk
						set qty =qty -  :iqty , qtyb =qtyb -  :iqty , weight =weight -  :dweight , weightb =weightb -  :dweight , stonewgt =stonewgt -  :dstwgt , stonewgtb =stonewgtb -  :dstwgt
						where code = :scode and
						stktype = :sstktype;
					end if

					continue
				end if

				update items
				set qtyb =qtyb -  :iqty , weightb =weightb -  :dweight , stonewgtb =stonewgtb -  :dstwgt
				where code = :scode;

				if sstktype <> "" then
					chkstktype(scode,sstktype)

					update itemsstk
					set qtyb =qtyb -  :iqty , weightb =weightb -  :dweight , stonewgtb =stonewgtb -  :dstwgt
					where code = :scode and
					stktype = :sstktype;
				end if
			end if
		loop

		close cursorr;      //sqlca

		select tdate 
		into :dtdate2
		from salesm
		where slno = :lslno;
	end if

	select exchslno , retnslno 
	into :lexchslno, :lretnslno
	from salesm
	where slno = :lslno;

	select docno 
	into :spdocno
	from purchasem
	where slno = :lslno;

	select billno 
	into :ssrdocno
	from salesrm
	where slno = :lslno;

	delete
	from salesm
	where slno = :lslno;

	delete
	from salesd
	where slno = :lslno;

	delete
	from purchasem
	where slno = :lslno;

	delete
	from purchased
	where slno = :lslno;

	delete
	from salesrm
	where slno = :lslno;

	delete
	from salesrd
	where slno = :lslno;

	delete
	from daybook
	where slno = :lslno;

	delete
	from daybookpart
	where slno = :lslno;

	delete
	from daybookratewgt
	where slno = :lslno;

	delete
	from spdmddet
	where slno = :lslno;

	delete
	from stkandprofit
	where slno = :lslno;

	delete
	from oglist
	where slno = :lslno;

	delete
	from kuricolln
	where slno = :lslno;
end if

if rtype = "T" or &
		profilestring(gsinifile,"Software","SalesConfirmModel","N") = "Y" then
	icontrol = 3
else
	if this.seb = "B" then
		icontrol = 1
	else
		icontrol = 2
	end if
end if

if dexamt > 0 and &
		(isnull(spdocno) or &
		spdocno = "") then
	if this.seb = "B" and &
			profilestring(gsinifile,"Software","ExchangeNoSeperate","N") = "Y" then
		if profilestring(gsinifile,"Software","PBillTypewiseBillNo","N") = "Y" and &
				this.seb = "B" then
			select pprefix 
			into :spref
			from salestype
			where code = :sbilltype;

			if isnull(spref) or &
					spref = "" then
				spref = "PUB/"
			end if

			scode = "PURCH" + spref

			select cvalue 
			into :lbillno
			from generali
			where code = :scode;

			if sqlca.sqlcode <> 0 then
				insert into generali ( code , cvalue )
				values (  :scode , 0 );

				lbillno = 0
			end if

			if giaccount = 2 and &
					gifupdt = 1 and &
					cbx_updtfr.checked and &
					this.seb = "B" then
				SELECT cvalue 
				INTO :lbillno2
				FROM generali
				WHERE code = :scode 
				using transtmp;

				if lbillno < lbillno2 then
					lbillno = lbillno2
				end if
			end if

			update generali
			SET cvalue = :lbillno + 1
			WHERE code = :scode;
		else
			scode = "PURCHASE" + this.seb

			SELECT cvalue 
			INTO :lbillno
			FROM generali
			WHERE code = :scode;

			if giaccount = 2 and &
					gifupdt = 1 and &
					cbx_updtfr.checked and &
					this.seb = "B" then
				SELECT cvalue 
				INTO :lbillno2
				FROM generali
				WHERE code = :scode 
				using transtmp;

				if lbillno < lbillno2 then
					lbillno = lbillno2
				end if
			end if

			if isnull(lbillno) then
				lbillno = 0
			end if

			update generali
			SET cvalue = :lbillno + 1
			WHERE code = :scode;

			if this.seb = "B" then
				select cvalue 
				into :spref
				from generals
				where code ='PBPREF';
			else
				select cvalue 
				into :spref
				from generals
				where code ='PEPREF';
			end if
		end if

		lbillno ++

		if isnull(spref) then
			spref = ""
		end if

		spdocno = spref + string(lbillno,"00000")
	else
		spdocno = sbillno
	end if
end if

if dsretamt > 0 and &
		(isnull(ssrdocno) or &
		ssrdocno = "") then
	if this.seb = "B" and &
			profilestring(gsinifile,"Software","SRetNoSeperate","N") = "Y" then
		scode = "SRETURN" + this.seb

		SELECT cvalue 
		INTO :lbillno
		FROM generali
		WHERE code = :scode;

		update generali
		SET cvalue =cvalue + 1
		WHERE trim ( code ) = :scode;

		if isnull(lbillno) then
			lbillno = 0
		end if

		lbillno ++

		if this.seb = "B" then
			spref = "SRB/"
		else
			spref = "SRE/"
		end if

		if isnull(spref) then
			spref = ""
		end if

		ssrdocno = spref + string(lbillno,"00000")
	else
		ssrdocno = sbillno
	end if
end if

if isnull(ssrdocno) or &
		ssrdocno = "" then
	ssrdocno = sbillno
end if

if cbx_showwgt.checked then
	sshowwgt = "Y"
else
	sshowwgt = "N"
end if

if profilestring(gsinifile,"Software","TaxSystem","GST") = "VAT" then
	dsgst = 0
	dcgst = 0
	digst = 0
else
	if scst = "Y" then
		dsgst = 0
		dcgst = 0
		digst = dtaxamt
		dsgst2 = 0
		dcgst2 = 0
		digst2 = dptax
	else
		dsgst = dtaxamt / 2
		dcgst = dtaxamt / 2
		digst = 0
		dsgst2 = dptax / 2
		dcgst2 = dptax / 2
		digst2 = 0
	end if
end if

dacamt = dnetamt - ddisc

insert into salesm ( slno , billno , custcode , custname , billamt , ramt , discount , status , sr , eamt , grate , control , tdate , ttime , staxperc , staxamt , srate , duedate , ramtafter , sretamt , jrate , smcode , ob , cocode , round , opbill , prn , netamt , advance , astamt , counter , ic , fr , exchslno , retnslno , tva , billtype , ograte , addr , note , loan , cbcode , bcharge , addbcharge , ccamt , hmc , discperc , rddisc , showwgt , ws , rcamt , thrate , cst , printwanda , mobno , agcode , fancyamt , schmamt , chqbank , chqno , chqdate , chqamt , chqpdc , placeos , pan , statecode , sgst , cgst , igst , redmpoints , bcperc , approvedby , ccpdc , tin , astperc , dstatus , secwgt , secnote , tcsperc , tcsamt , bultouch , vehno , distance )
values (  :lslno ,  :sbillno ,  :scustcode ,  :scustname ,  :dbamt ,  :drcvd ,  :ddisc ,  :istatus ,  :rtype ,  :dexamt ,  :dgrate ,  :icontrol ,  :dtdate ,  :ttime ,  :dtaxperc ,  :dtaxamt ,  :gdsrate ,  :dtduedate ,  :drcvdafter ,  :dsretamt ,  :gdjrate ,  :ssmcode ,  :dob ,  :scocode ,  :dround , 0 , 0 ,  :dacamt ,  :dadv ,  :dast ,  :scounter ,  :gsincharge ,  :sfr ,  :lexchslno ,  :lretnslno , 0 ,  :sbilltype ,  :gdograte ,  :saddr ,  :snote ,  :sloan ,  :scbcode ,  :dbcharge ,  :saddbcharge ,  :dccamt ,  :dhmc ,  :ddiscperc , 0 ,  :sshowwgt ,  :sws ,  :drcamt ,  :dthrate ,  :scst ,  :sprintwanda ,  :smob ,  :sagent ,  :dfancyamt ,  :dschmamt ,  :schqbank ,  :schqno ,  :dtchqdate ,  :dchqamt ,  :schqpdc ,  :spos ,  :span ,  :sstate ,  :dsgst ,  :dcgst ,  :digst ,  :dredmpoints ,  :dbcperc ,  :sapprovedby ,  :sccpdc ,  :stin ,  :dastperc ,  :sdstatus ,  :dsecwgt ,  :ssecnote ,  :dtcsperc ,  :dtcsamt ,  :this.dibultouch ,  :svehno ,  :idistance );

if sqlca.sqlcode <> 0 then
	messagebox("Error","Sales m makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
	bsave = false
end if

if scustcode <> "" then
	select duedate , billdate 
	into :dtduedate2, :dtbdate
	from clients
	where code = :scustcode;

	if year(dtduedate) > 1990 and &
			(dtduedate > dtduedate2 or &
			isnull(dtduedate2)) then
		update clients
		set duedate = :dtduedate
		where code = :scustcode;
	end if

	if (year(dtbdate) > 1990 and &
			dtdate > dtbdate) or &
			isnull(dtbdate) then
		update clients
		set billdate = :dtdate
		where code = :scustcode;
	end if
end if

if dexamt > 0 then
	istatus = 3

	if profilestring(gsinifile,"Software","PTaxExternal","N") = "Y" then
		dptax = round((dexamt * gdptax) / 100,2)
		dptaxperc = gdptax
	else
	end if

	insert into purchasem ( slno , billno , docno , suppcode , name , billamt , pamt , status , pr , control , tdate , ttime , rate , smcode , round , netamt , eamt , addamt , taxamt , taxperc , astamt , ic , taxexternal , addr , pan , statecode , sgst , cgst , igst , counter , billtype )
	values (  :lslno ,  :spdocno ,  :spdocno ,  :scustcode ,  :scustname ,  :dexamt ,  :dexamt ,  :istatus , 'E' ,  :icontrol ,  :dtdate ,  :ttime ,  :gdgrate ,  :ssmcode , 0 ,  :dexamt , 0 , 0 ,  :dptax ,  :dptaxperc , 0 ,  :gsincharge , 'Y' ,  :saddr ,  :span ,  :sstate ,  :dsgst2 ,  :dcgst2 ,  :digst2 ,  :scounter ,  :sbilltype );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Purchase m makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

dacamt = 0
sacpart = "By Sales (" + sbillno + ")"

if scustname <> "" then
	sacpart = sacpart + " To " + scustname
end if

sacpart = left(sacpart,40)

insert into daybookpart ( slno , particular , vchno , ic , uid , ttime , rate )
values (  :lslno ,  :sacpart , '' ,  :gsincharge ,  :gsuserid ,  :ttime ,  :dgrate );

if sqlca.sqlcode <> 0 then
	messagebox("Error","Daybook Part makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
	bsave = false
end if

if dbalance <> 0 and &
		dgrate > 0 and &
		sshowwgt = "Y" then
	dwgt = (-round(dbalance / dgrate,2))

	insert into daybookratewgt ( slno , rate , mcp , wgt , code , tdate , control )
	values (  :lslno ,  :dgrate , 0 ,  :dwgt ,  :scustcode ,  :dtdate ,  :icontrol );
end if

sopaccode = "RS"

if drcvd <> 0 then
	saccode = scbcode

	if drcvd > dccamt + dchqamt or &
			drcvd < 0 then
		dacamt = (-(drcvd - dccamt - dchqamt))

		if scbcode <> "CASH" and &
				dccamt + dchqamt = 0 then
			saccode = scbcode
		else
			saccode = "CASH"
		end if

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	end if

	if dccamt > 0 then
		dacamt = (-dccamt)

		if sccpdc = "Y" then
			saccode = "CNC"

			if this.saded = "E" then
				select pend 
				into :spend2
				from pdclist
				where slno = :lslno and
				chqno = :sbillno;

				delete
				from pdclist
				where slno = :lslno and
				chqno = :sbillno;
			end if

			if isnull(spend2) or &
					spend2 = "" then
				spend2 = "Y"
			end if

			if year(dtchqdate) > 2000 then
				dtccpdcdt = dtchqdate
			else
				dtccpdcdt = relativedate(dtdate,3)
			end if

			insert into pdclist ( slno , tdate , docno , bank , code , chqno , chqdate , amount , particulars , rp , pend , control )
			values (  :lslno ,  :dtdate ,  :sbillno ,  :scbcode , 'CNC' ,  :sbillno ,  :dtccpdcdt ,  :dccamt ,  :sacpart , 'R' ,  :spend2 ,  :icontrol );

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Pdclist makes problem..." + sqlca.sqlerrtext,information!,ok!)
				bsave = false
			end if
		else
			saccode = scbcode
		end if

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	end if

	if dchqamt > 0 then
		dacamt = (-dchqamt)

		if cbx_pdc.checked then
			saccode = "CNC"
		else
			saccode = schqbank
		end if

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	end if

	if scbcode <> "CASH" then
		select cvalue 
		into :dbcomn
		from generald
		where code ='BANKCOMN';

		if dec(em_bcperc.text) > 0 then
			dbcomn = dec(em_bcperc.text)
		end if

		select cvalue 
		into :dbcomntax
		from generald
		where code ='BCOMNTAX';

		if isnull(dbcomn) then
			dbcomn = 0
		end if

		if isnull(dbcomntax) then
			dbcomntax = 0
		end if

		if dccamt > 0 then
			dcomn = round((dccamt * dbcomn) / 100,1)
		else
			if cbx_addbc.checked then
				dcomn = round(((dnetamt - dbcharge) * dbcomn) / 100,1)
			else
				dcomn = round((drcvd * dbcomn) / 100,1)
			end if
		end if

		dcomntax = round((dcomn * dbcomntax) / 100,1)

		if dcomn <> 0 then
			saccode = scbcode
			dacamt = dcomn

			insert into daybook ( slno , tdate , accode , amount , control , opaccode )
			values (  :lslno ,  :dtdate ,  :saccode ,  :dacamt ,  :icontrol ,  :sopaccode );

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if

			if cbx_addbc.checked = false then
				saccode = "BCOMN"
				dacamt = (-dcomn)

				insert into daybook ( slno , tdate , accode , amount , control , opaccode )
				values (  :lslno ,  :dtdate ,  :saccode ,  :dacamt ,  :icontrol ,  :sopaccode );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
					bsave = false
				end if
			end if
		end if

		if dcomntax <> 0 then
			saccode = scbcode
			dacamt = dcomntax

			insert into daybook ( slno , tdate , accode , amount , control , opaccode )
			values (  :lslno ,  :dtdate ,  :saccode ,  :dacamt ,  :icontrol ,  :sopaccode );

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if

			if cbx_addbc.checked = false then
				saccode = "BCOMNTAX"
				dacamt = (-dcomntax)

				insert into daybook ( slno , tdate , accode , amount , control , opaccode )
				values (  :lslno ,  :dtdate ,  :saccode ,  :dacamt ,  :icontrol ,  :sopaccode );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
					bsave = false
				end if
			end if
		end if
	end if
end if

if cbx_pdc.checked and &
		dchqamt > 0 then
	if this.saded = "E" then
		select pend 
		into :spend
		from pdclist
		where slno = :lslno;

		delete
		from pdclist
		where slno = :lslno;
	end if

	if isnull(spend) or &
			spend = "" then
		spend = "Y"
	end if

	insert into pdclist ( slno , tdate , docno , bank , code , chqno , chqdate , amount , particulars , rp , pend , control )
	values (  :lslno ,  :dtdate ,  :sbillno ,  :schqbank , 'CNC' ,  :schqno ,  :dtchqdate ,  :dchqamt ,  :sacpart , 'R' ,  :spend ,  :icontrol );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Pdclist makes problem..." + sqlca.sqlerrtext,information!,ok!)
		bsave = false
	end if
end if

if trim(scustcode) <> "" then
	saccode = scustcode
	dacamt = (-(dnetamt - ddisc))

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if

	if drcvd <> 0 then
		saccode = scustcode
		dacamt = drcvd

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	end if
end if

if ddisc <> 0 then
	saccode = ""

	select cvalue 
	into :saccode
	from generals
	where code ='SDISCAC';

	if isnull(saccode) or &
			saccode = "" then
		saccode = "DISC"
	end if

	dacamt = (-ddisc)

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if dhmc <> 0 then
	saccode = "HMC"
	dacamt = dhmc

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if dtcsamt <> 0 then
	saccode = "TCSAC"
	dacamt = dtcsamt

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if drcamt <> 0 then
	saccode = "RCAMT"
	dacamt = drcamt

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if dadv <> 0 then
	saccode = "ADVANCE"
	dacamt = (-dadv)

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if dfancyamt <> 0 then
	saccode = "FANCY"
	dacamt = dfancyamt

	insert into daybook ( slno , accode , amount , control , tdate )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if dschmamt <> 0 then
	if profilestring(gsinifile,"Software","AdjustSchemeAmtWithSchemeColln","N") = "Y" then
		select code 
		into :spcode
		from clients_kuridet
		where custlinkac = :scustcode;

		if isnull(spcode) then
			spcode = ""
		end if

		if spcode = "" then
			spcode = scustcode
		end if

		snerr = "Amt adjusted with Sales"

		insert into kuricolln ( slno , tdate , code , amount , control , sno , grate , agent , rcptno , closed , wgt , docno , note )
		values (  :lslno ,  :dtdate ,  :spcode , -  :dschmamt ,  :icontrol , 1 ,  :dgrate , '' , '' , 'N' ,  :dwgt ,  :sbillno ,  :snerr );

		saccode = spcode
		dacamt = (-dschmamt)

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	else
		saccode = "SCHMAMT"
		dacamt = (-dschmamt)

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	end if
end if

itrow = upperbound(strsales)
irow = 1
dcostamt = 0
dtcostamt = 0
dprof = 0
dtprof = 0

do while irow <= itrow
	dstwgt = 0

	if gistktype = 2 then
		dstwgt = strsales[irow].stonewgt
	end if

	if strsales[irow].adjtype = "To" then
		dadjwgt = strsales[irow].adjwgt
		iadjqty = strsales[irow].adjqty
	else
		dadjwgt = (-strsales[irow].adjwgt)
		iadjqty = (-strsales[irow].adjqty)
	end if

	if rtype = "S" then
		if this.seb = "B" and &
				(strsales[irow].jewlcode = "" or &
				isnull(strsales[irow].jewlcode)) then
			update items
			SET weight =weight - (  :strsales[irow].weight -  :dstwgt +  :dadjwgt ) , qty =qty -  :strsales[irow].qty , weightb =weightb - (  :strsales[irow].weight -  :dstwgt +  :dadjwgt ) , qtyb =qtyb -  :strsales[irow].qty , stonewgt =stonewgt -  :strsales[irow].stonewgt , stonewgtb =stonewgtb -  :strsales[irow].stonewgt
			WHERE code = :strsales[irow].itemcode;

			if strsales[irow].stktype <> "" then
				chkstktype(strsales[irow].itemcode,strsales[irow].stktype)

				update itemsstk
				SET weight =weight - (  :strsales[irow].weight -  :dstwgt +  :dadjwgt ) , qty =qty -  :strsales[irow].qty , weightb =weightb - (  :strsales[irow].weight -  :dstwgt +  :dadjwgt ) , qtyb =qtyb -  :strsales[irow].qty , stonewgt =stonewgt -  :strsales[irow].stonewgt , stonewgtb =stonewgtb -  :strsales[irow].stonewgt
				WHERE code = :strsales[irow].itemcode and
				stktype = :strsales[irow].stktype;
			end if
		else
			if strsales[irow].jewlcode = "" or &
					isnull(strsales[irow].jewlcode) then
				update items
				SET weightb =weightb - (  :strsales[irow].weight -  :dstwgt +  :dadjwgt ) , qtyb =qtyb -  :strsales[irow].qty , stonewgtb =stonewgtb -  :strsales[irow].stonewgt
				WHERE code = :strsales[irow].itemcode;

				if strsales[irow].stktype <> "" then
					chkstktype(strsales[irow].itemcode,strsales[irow].stktype)

					update itemsstk
					SET weightb =weightb - (  :strsales[irow].weight -  :dstwgt +  :dadjwgt ) , qtyb =qtyb -  :strsales[irow].qty , stonewgtb =stonewgtb -  :strsales[irow].stonewgt
					WHERE code = :strsales[irow].itemcode and
					stktype = :strsales[irow].stktype;
				end if
			end if
		end if

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Items makes problem(code)..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if

		if strsales[irow].jewlcode <> "" and &
				not isnull(strsales[irow].jewlcode) then
			bjfind = false
			ijcount = upperbound(strjamt)

			if ijcount > 0 then
				for itmp = 1 to ijcount
					if strsales[irow].jewlcode = strjamt[itmp].code then
						dtmpjewlamt = (strsales[irow].weight - strsales[irow].stonewgt) * strsales[irow].jrate + strsales[irow].jva

						if isnull(dtmpjewlamt) then
							dtmpjewlamt = 0
						end if

						strjamt[itmp].amount += dtmpjewlamt
						dtmptotjewlamt += dtmpjewlamt
						bjfind = true
					end if
				next
			end if

			if bjfind = false then
				dtmpjewlamt = (strsales[irow].weight - strsales[irow].stonewgt) * strsales[irow].jrate + strsales[irow].jva

				if isnull(dtmpjewlamt) then
					dtmpjewlamt = 0
				end if

				dtmptotjewlamt += dtmpjewlamt
				strjamt[ijcount + 1].code = strsales[irow].jewlcode
				strjamt[ijcount + 1].amount = dtmpjewlamt
			end if
		end if
	end if

	select name 
	into :sname
	from items
	where code = :strsales[irow].itemcode;

	if trim(sname) = trim(strsales[irow].itemname) then
		strsales[irow].itemname = ""
	end if

	insert into salesd ( slno , code , qty , weight , stonewgt , stoneprice , mcharge , wastage , rate , amount , jcode , kdm , cost , name , sno , jrate , jva , bcode , fr , rmno , mark , stktype , iqtype , stktouch , dmdwgt , dmdnos , vaperc , model , note , huid )
	values (  :lslno ,  :strsales[irow].itemcode ,  :strsales[irow].qty ,  :strsales[irow].weight ,  :strsales[irow].stonewgt ,  :strsales[irow].stoneprice ,  :strsales[irow].mcharge ,  :strsales[irow].wastage ,  :strsales[irow].rate ,  :strsales[irow].amount ,  :strsales[irow].jewlcode ,  :strsales[irow].kdm ,  :strsales[irow].cost ,  :strsales[irow].itemname ,  :irow ,  :strsales[irow].jrate ,  :strsales[irow].jva ,  :strsales[irow].bcode ,  :strsales[irow].fr ,  :strsales[irow].rmno ,  :strsales[irow].stkfd ,  :strsales[irow].stktype ,  :strsales[irow].iqtype ,  :strsales[irow].stktouch ,  :strsales[irow].dmdwgt ,  :strsales[irow].dmdnos ,  :strsales[irow].mperc ,  :strsales[irow].model ,  :strsales[irow].note ,  :strsales[irow].huid );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Sales D makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if

	if strsales[irow].stkinnos = "Y" then
		dcostamt = strsales[irow].qty * strsales[irow].cost
	else
		dcostamt = (strsales[irow].weight - strsales[irow].stonewgt) * strsales[irow].cost
	end if

	dprof = strsales[irow].amount - dcostamt
	dtcostamt += dcostamt
	dtprof += dprof

	if strsales[irow].dmdwgt > 0 then
		insert into spdmddet ( slno , sno , dmdwgt , dmdunit , dmdamt , dmdnos , brand , purity , centrate )
		values (  :lslno ,  :irow ,  :strsales[irow].dmdwgt ,  :strsales[irow].dmdunit ,  :strsales[irow].dmdamt ,  :strsales[irow].dmdnos , '' , '' , 0 );
	end if

	if strsales[irow].adjitem <> "" and &
			strsales[irow].adjwgt <> 0 then
		if strsales[irow].bcode > 0 then
			if strsales[irow].adjtype = "To" then
				update barcode
				set qty =qty -  :strsales[irow].adjqty , weight =weight -  :strsales[irow].adjwgt
				where bcode = :strsales[irow].bcode;
			else
				update barcode
				set qty =qty +  :strsales[irow].adjqty , weight =weight +  :strsales[irow].adjwgt
				where bcode = :strsales[irow].bcode;
			end if
		end if

		if strsales[irow].itemcode <> strsales[irow].adjitem then
			if strsales[irow].adjtype = "To" then
				insert into itemadj ( slno , fromcode , fromqty , fromwgt , tocode , toqty , towgt , particular , tdate , ttime , control , fromcost , tocost , sno , mark , fromstktype , tostktype , ic , fromstktouch , tostktouch , bcode )
				values (  :lslno ,  :strsales[irow].itemcode , 0 ,  :strsales[irow].adjwgt ,  :strsales[irow].adjitem ,  :strsales[irow].adjqty ,  :strsales[irow].adjwgt ,  :sacpart ,  :dtdate ,  :ttime ,  :icontrol ,  :strsales[irow].cost ,  :strsales[irow].cost ,  :irow ,  :strsales[irow].stkfd ,  :strsales[irow].stktype ,  :strsales[irow].stktype ,  :gsincharge ,  :strsales[irow].stktouch ,  :strsales[irow].stktouch ,  :strsales[irow].bcode );
			else
				insert into itemadj ( slno , fromcode , fromqty , fromwgt , tocode , toqty , towgt , particular , tdate , ttime , control , fromcost , tocost , sno , mark , fromstktype , tostktype , ic , fromstktouch , tostktouch , bcode )
				values (  :lslno ,  :strsales[irow].adjitem ,  :strsales[irow].adjqty ,  :strsales[irow].adjwgt ,  :strsales[irow].itemcode , 0 ,  :strsales[irow].adjwgt ,  :sacpart ,  :dtdate ,  :ttime ,  :icontrol ,  :strsales[irow].cost ,  :strsales[irow].cost ,  :irow ,  :strsales[irow].stkfd ,  :strsales[irow].stktype ,  :strsales[irow].stktype ,  :gsincharge ,  :strsales[irow].stktouch ,  :strsales[irow].stktouch ,  :strsales[irow].bcode );
			end if

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Adjustment makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if

			if strsales[irow].adjtype = "From" then
				strsales[irow].adjwgt = (-strsales[irow].adjwgt)
				strsales[irow].adjqty = (-strsales[irow].adjqty)
			end if

			if this.seb = "B" then
				update items
				SET weight =weight +  :strsales[irow].adjwgt , qty =qty +  :strsales[irow].adjqty , weightb =weightb +  :strsales[irow].adjwgt , qtyb =qtyb +  :strsales[irow].adjqty
				WHERE trim ( code ) = :strsales[irow].adjitem;

				if strsales[irow].stktype <> "" then
					chkstktype(strsales[irow].adjitem,strsales[irow].stktype)

					update itemsstk
					SET weight =weight +  :strsales[irow].adjwgt , qty =qty +  :strsales[irow].adjqty , weightb =weightb +  :strsales[irow].adjwgt , qtyb =qtyb +  :strsales[irow].adjqty
					WHERE trim ( code ) = :strsales[irow].adjitem and
					stktype = :strsales[irow].stktype;
				end if
			else
				update items
				SET weightb =weightb +  :strsales[irow].adjwgt , qtyb =qtyb +  :strsales[irow].adjqty
				WHERE trim ( code ) = :strsales[irow].adjitem;

				if strsales[irow].stktype <> "" then
					chkstktype(strsales[irow].adjitem,strsales[irow].stktype)

					update itemsstk
					SET weightb =weightb +  :strsales[irow].adjwgt , qtyb =qtyb +  :strsales[irow].adjqty
					WHERE trim ( code ) = :strsales[irow].adjitem and
					stktype = :strsales[irow].stktype;
				end if
			end if

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Item makes problem in adjustment..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if
		end if
	end if

	if strsales[irow].bcode <> 0 and &
			rtype = "S" then
		update barcode
		set stk ='N' , islno = :lslno , sdate = :dtdate
		where bcode = :strsales[irow].bcode;

		if sqlca.sqlcode <> 0 then
			messagebox("Error","barcode problem ..." + sqlca.sqlerrtext,exclamation!,ok!)
		end if
	end if

	irow += 1
loop

if profilestring(gsinifile,"Software","StkAndProfitUpdate","N") = "Y" then
	dtcostamt = (-dtcostamt)
	dtprof = dtprof - ddisc + dtaxamt + dast

	insert into stkandprofit ( slno , tdate , stkvalue , profit , note , control , docno )
	values (  :lslno ,  :dtdate ,  :dtcostamt ,  :dtprof , 'Sales' ,  :icontrol ,  :sbillno );

	dtcostamt = 0
	dtprof = 0
end if

if dtaxamt <> 0 then
	if profilestring(gsinifile,"Software","TaxSystem","GST") = "VAT" then
		saccode = ""

		select cvalue 
		into :saccode
		from generals
		where code ='STAXAC';

		if isnull(saccode) or &
				saccode = "" then
			saccode = "TAX"
		end if

		dacamt = dtaxamt

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	else
		if dsgst > 0 then
			saccode = "SGST"
			dacamt = dtaxamt / 2

			insert into daybook ( slno , accode , amount , control , tdate , opaccode )
			values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if

			saccode = "CGST"
			dacamt = dtaxamt / 2

			insert into daybook ( slno , accode , amount , control , tdate , opaccode )
			values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if
		else
			if digst > 0 then
				saccode = "IGST"
				dacamt = dtaxamt

				insert into daybook ( slno , accode , amount , control , tdate , opaccode )
				values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
					bsave = false
				end if
			else
				saccode = "TAX"
				dacamt = dtaxamt

				insert into daybook ( slno , accode , amount , control , tdate , opaccode )
				values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
					bsave = false
				end if
			end if
		end if
	end if
end if

if dast <> 0 then
	saccode = "AST"
	dacamt = dast

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if dptax <> 0 then
	saccode = ""

	select cvalue 
	into :saccode
	from generals
	where code ='PTAXAC';

	if isnull(saccode) or &
			saccode = "" then
		saccode = "PTAX"
	end if

	dacamt = (-dptax)

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Tran makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if

	saccode = "PTAXEXP"
	dacamt = dptax

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Tran makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

irow = 1
iterows = upperbound(strexchange)

if iterows > 0 then
	do while irow <= iterows
		if rtype = "S" then
			if strexchange[irow].weight > 0 then
				dcost1 = round(strexchange[irow].amount / strexchange[irow].weight,2)
			else
				dcost1 = strexchange[irow].rate
			end if

			select weightb , cost 
			into :dcurstock, :dcost
			from items
			where trim ( code ) = :strexchange[irow].itemcode;

			if isnull(dcurstock) then
				dcurstock = 0
			end if

			if isnull(dcost) then
				dcost = 0
			end if

			if isnull(dcost1) then
				dcost1 = 0
			end if

			if dcurstock + strexchange[irow].weight > 0 and &
					dcurstock > 0 and &
					scalcwacost = "Y" then
				dwacost = (dcurstock * dcost + strexchange[irow].weight * dcost1) / (dcurstock + strexchange[irow].weight)
			else
				dwacost = dcost1
			end if

			dwacost = round(dwacost,2)

			if this.seb = "B" then
				update items
				SET weight =weight +  :strexchange[irow].weight , weightb =weightb +  :strexchange[irow].weight , qty =qty +  :strexchange[irow].qty , qtyb =qtyb +  :strexchange[irow].qty , cost = :dwacost , stonewgt =stonewgt -  :strexchange[irow].stonewgt , stonewgtb =stonewgtb -  :strexchange[irow].stonewgt
				WHERE trim ( code ) = :strexchange[irow].itemcode;

				if strexchange[irow].stktype <> "" then
					chkstktype(strexchange[irow].itemcode,strexchange[irow].stktype)

					update itemsstk
					SET weight =weight +  :strexchange[irow].weight , weightb =weightb +  :strexchange[irow].weight , qty =qty +  :strexchange[irow].qty , qtyb =qtyb +  :strexchange[irow].qty , stonewgt =stonewgt -  :strexchange[irow].stonewgt , stonewgtb =stonewgtb -  :strexchange[irow].stonewgt
					WHERE trim ( code ) = :strexchange[irow].itemcode and
					stktype = :strexchange[irow].stktype;
				end if
			else
				update items
				SET weightb =weightb +  :strexchange[irow].weight , qtyb =qtyb +  :strexchange[irow].qty , cost = :dwacost , stonewgtb =stonewgtb -  :strexchange[irow].stonewgt
				WHERE trim ( code ) = :strexchange[irow].itemcode;

				if strexchange[irow].stktype <> "" then
					chkstktype(strexchange[irow].itemcode,strexchange[irow].stktype)

					update itemsstk
					SET weightb =weightb +  :strexchange[irow].weight , qtyb =qtyb +  :strexchange[irow].qty , stonewgtb =stonewgtb -  :strexchange[irow].stonewgt
					WHERE trim ( code ) = :strexchange[irow].itemcode and
					stktype = :strexchange[irow].stktype;
				end if
			end if
		end if

		select name 
		into :sname
		from items
		where code = :strexchange[irow].itemcode;

		if trim(sname) = trim(strexchange[irow].itemname) then
			strexchange[irow].itemname = ""
		end if

		if isnull(strexchange[irow].fr) then
			strexchange[irow].fr = 0
		end if

		if cbx_updtfr.checked then
			strexchange[irow].fr = 1
		end if

		sbatch = ""

		if isnull(strexchange[irow].batch) then
			strexchange[irow].batch = ""
		end if

		if profilestring(gsinifile,"Software","KeepOGList","N") = "Y" then
			if strexchange[irow].itemcode = "OG" then
				if strexchange[irow].batch = "" then
					select cvalue 
					into :ltmp
					from generali
					where code ='OGBATCH';

					if sqlca.sqlcode <> 0 then
						insert into generali ( code , cvalue )
						values ( 'OGBATCH' , 100000 );

						ltmp = 100000
					end if

					sbatch = string(ltmp + 1,"000000")

					update generali
					set cvalue =cvalue + 1
					where code ='OGBATCH';
				else
					sbatch = strexchange[irow].batch
				end if

				insert into oglist ( slno , code , batch , weight , touch , lesswgt , amount , issuedwgt , pend , tdate , docno )
				values (  :lslno ,  :strexchange[irow].itemcode ,  :sbatch ,  :strexchange[irow].weight ,  :strexchange[irow].touch ,  :strexchange[irow].lesswgt ,  :strexchange[irow].amount , 0 , 'Y' ,  :dtdate ,  :sbillno );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","OG List makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
				end if
			end if
		end if

		insert into purchased ( slno , code , qty , weight , rate , lesswgt , amount , cost , stwgt , stprice , mud , name , sno , fr , mark , stktype , iqtype , lessperc , touch , stktouch , rate2 , batch )
		values (  :lslno ,  :strexchange[irow].itemcode ,  :strexchange[irow].qty ,  :strexchange[irow].weight ,  :strexchange[irow].rate ,  :strexchange[irow].lesswgt ,  :strexchange[irow].amount ,  :dcost1 ,  :strexchange[irow].stonewgt ,  :strexchange[irow].stoneprice ,  :strexchange[irow].mud ,  :strexchange[irow].itemname ,  :irow ,  :strexchange[irow].fr ,  :strexchange[irow].stkfd ,  :strexchange[irow].stktype ,  :strexchange[irow].iqtype ,  :strexchange[irow].lessperc ,  :strexchange[irow].touch ,  :strexchange[irow].stktouch ,  :strexchange[irow].rate2 ,  :sbatch );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Purchase D makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if

		dtcostamt += strexchange[irow].amount

		if strexchange[irow].itemcode = "OG" then
			sog = "Y"
		end if

		irow += 1
	loop

	if profilestring(gsinifile,"Software","StkAndProfitUpdate","N") = "Y" then
		dtcostamt += dptax
		dtprof = 0

		insert into stkandprofit ( slno , tdate , stkvalue , profit , note , control , docno )
		values (  :lslno ,  :dtdate ,  :dtcostamt ,  :dtprof , 'Exchange' ,  :icontrol ,  :sbillno );

		dtcostamt = 0
		dtprof = 0
	end if
end if

dretdisc = 0

if dsretamt > 0 then
	itsrrows = upperbound(strsreturn)
	dretdisc = strsreturn[1].wgtamt

	if isnull(dretdisc) then
		dretdisc = 0
	end if

	irow = 1

	do while irow <= itsrrows
		dstwgt = 0

		if gistktype = 2 then
			dstwgt = strsreturn[irow].stonewgt
		end if

		if rtype = "S" then
			if this.seb = "B" then
				update items
				SET weight =weight + (  :strsreturn[irow].weight -  :dstwgt ) , qty =qty +  :strsreturn[irow].qty , weightb =weightb + (  :strsreturn[irow].weight -  :dstwgt ) , qtyb =qtyb +  :strsreturn[irow].qty , stonewgt =stonewgt +  :strsreturn[irow].stonewgt , stonewgtb =stonewgtb +  :strsreturn[irow].stonewgt
				WHERE trim ( code ) = :strsreturn[irow].itemcode;

				if strsreturn[irow].stktype <> "" then
					chkstktype(strsreturn[irow].itemcode,strsreturn[irow].stktype)

					update itemsstk
					SET weight =weight + (  :strsreturn[irow].weight -  :dstwgt ) , qty =qty +  :strsreturn[irow].qty , weightb =weightb + (  :strsreturn[irow].weight -  :dstwgt ) , qtyb =qtyb +  :strsreturn[irow].qty , stonewgt =stonewgt +  :strsreturn[irow].stonewgt , stonewgtb =stonewgtb +  :strsreturn[irow].stonewgt
					WHERE trim ( code ) = :strsreturn[irow].itemcode and
					stktype = :strsreturn[irow].stktype;
				end if
			else
				update items
				SET weightb =weightb + (  :strsreturn[irow].weight -  :dstwgt ) , qtyb =qtyb +  :strsreturn[irow].qty , stonewgtb =stonewgtb +  :strsreturn[irow].stonewgt
				WHERE trim ( code ) = :strsreturn[irow].itemcode;

				if strsreturn[irow].stktype <> "" then
					chkstktype(strsreturn[irow].itemcode,strsreturn[irow].stktype)

					update itemsstk
					SET weightb =weightb + (  :strsreturn[irow].weight -  :dstwgt ) , qtyb =qtyb +  :strsreturn[irow].qty , stonewgtb =stonewgtb +  :strsreturn[irow].stonewgt
					WHERE trim ( code ) = :strsreturn[irow].itemcode and
					stktype = :strsreturn[irow].stktype;
				end if
			end if

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Items makes problem(code)..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if
		end if

		select name 
		into :sname
		from items
		where code = :strsreturn[irow].itemcode;

		if trim(sname) = trim(strsreturn[irow].itemname) then
			strsreturn[irow].itemname = ""
		end if

		if isnull(strsreturn[irow].fr) then
			strsreturn[irow].fr = 0
		end if

		if cbx_updtfr.checked then
			strsreturn[irow].fr = 1
		end if

		insert into salesrd ( slno , code , qty , weight , stonewgt , stoneprice , mcharge , wastage , rate , amount , cost , name , sno , fr , mark , stktype , iqtype , stktouch , bcode , dmdwgt )
		values (  :lslno ,  :strsreturn[irow].itemcode ,  :strsreturn[irow].qty ,  :strsreturn[irow].weight ,  :strsreturn[irow].stonewgt ,  :strsreturn[irow].stoneprice ,  :strsreturn[irow].mcharge ,  :strsreturn[irow].wastage ,  :strsreturn[irow].rate ,  :strsreturn[irow].amount ,  :strsreturn[irow].cost ,  :strsreturn[irow].itemname ,  :irow ,  :strsreturn[irow].fr ,  :strsreturn[irow].stkfd ,  :strsreturn[irow].stktype ,  :strsreturn[irow].iqtype ,  :strsreturn[irow].stktouch ,  :strsreturn[irow].bcode ,  :strsreturn[irow].dmdwgt );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Salesret D makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if

		dtcostamt += strsreturn[irow].amount

		if strsreturn[irow].bcode > 0 then
			update barcode
			set stk ='Y' , rslno = :lslno
			where bcode = :strsreturn[irow].bcode;
		end if

		irow += 1
	loop

	dtax5 = strsreturn[1].taxamt
	dtax5perc = strsreturn[1].taxperc

	if isnull(dtax5) then
		dtax5 = 0
	end if

	dast5 = strsreturn[1].ast
	damt = round(dsretamt + dretdisc - dtax5 - dast5,2)

	insert into salesrm ( slno , billno , custcode , custname , billamt , pamt , status , sr , grate , control , tdate , ttime , srate , ob , round , netamt , eamt , discount , staxperc , staxamt , astamt , ic , smcode )
	values (  :lslno ,  :ssrdocno ,  :scustcode ,  :scustname ,  :damt ,  :dsretamt , 1 , 'E' ,  :gdgrate ,  :icontrol ,  :dtdate ,  :ttime ,  :gdsrate , 0 , 0 ,  :dsretamt , 0 ,  :dretdisc ,  :dtax5perc ,  :dtax5 ,  :dast5 ,  :gsincharge ,  :ssmcode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Salesret m makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if

	if profilestring(gsinifile,"Software","StkAndProfitUpdate","N") = "Y" then
		dtcostamt = dsretamt
		dtprof = 0

		insert into stkandprofit ( slno , tdate , stkvalue , profit , note , control , docno )
		values (  :lslno ,  :dtdate ,  :dtcostamt ,  :dtprof , 'Exchange' ,  :icontrol ,  :sbillno );

		dtcostamt = 0
		dtprof = 0
	end if

	if isnull(dtax5) then
		dtax5 = 0
	end if

	if dtax5 <> 0 then
		if profilestring(gsinifile,"Software","TaxSystem","GST") = "VAT" then
			saccode = ""

			select cvalue 
			into :saccode
			from generals
			where code ='STAXAC';

			if isnull(saccode) or &
					saccode = "" then
				saccode = "TAX"
			end if

			dacamt = (-dtax5)

			insert into daybook ( slno , accode , amount , control , tdate , opaccode )
			values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

			if sqlca.sqlcode <> 0 then
				messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
				bsave = false
			end if
		else
			if scst = "Y" then
				saccode = "IGST"
				dacamt = (-dtax5)

				insert into daybook ( slno , accode , amount , control , tdate , opaccode )
				values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
					bsave = false
				end if
			else
				saccode = "SGST"
				dacamt = (-dtax5) / 2

				insert into daybook ( slno , accode , amount , control , tdate , opaccode )
				values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
					bsave = false
				end if

				saccode = "CGST"
				dacamt = (-dtax5) / 2

				insert into daybook ( slno , accode , amount , control , tdate , opaccode )
				values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

				if sqlca.sqlcode <> 0 then
					messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
					bsave = false
				end if
			end if
		end if
	end if

	if dast5 > 0 then
		dacamt = (-dast5)
		saccode = "AST"

		insert into daybook ( slno , accode , amount , control , tdate , opaccode )
		values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

		if sqlca.sqlcode <> 0 then
			messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
			bsave = false
		end if
	end if
end if

itmp = 1
ijcount = upperbound(strjamt)

do while itmp <= ijcount
	saccode = strjamt[itmp].code
	dacamt = strjamt[itmp].amount

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if

	itmp += 1
loop

if dbamt <> 0 then
	saccode = "RS"

	if svasepac = "Y" then
		dacamt = dbamt - dtmptotjewlamt - dtva
	else
		dacamt = dbamt - dtmptotjewlamt
	end if

	if drcvd <> 0 then
		sopaccode = scbcode
	else
		if scustcode <> "" then
			sopaccode = scustcode
		end if
	end if

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if isnull(dtax5) then
	dtax5 = 0
end if

if dsretamt <> 0 then
	saccode = "ESR"
	dacamt = (-(dsretamt - dtax5))

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if dexamt <> 0 then
	if sog = "Y" then
		saccode = profilestring(gsinifile,"Software","OGPurchaseAc","EP")
	else
		saccode = "EP"
	end if

	dacamt = (-dexamt)

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate ,  :sopaccode );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if svasepac = "Y" and &
		dtva <> 0 then
	saccode = "VA"
	dacamt = dtva

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate , 'RS' );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

select sum ( amount ) 
into :dround
from daybook
where slno = :lslno;

if dround <> 0 then
	saccode = "ROUND"
	dacamt = (-dround)

	insert into daybook ( slno , accode , amount , control , tdate , opaccode )
	values (  :lslno ,  :saccode ,  :dacamt ,  :icontrol ,  :dtdate , 'RS' );

	if sqlca.sqlcode <> 0 then
		messagebox("Error","Daybook makes problem..." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if this.saded = "E" and &
		gskeepupdatelogs = "Y" then
	if profilestring(gsinifile,"Software","UpdateTime","Y") = "Y" then
		dtupddate = today()
	end if

	dtupdtime = now()
	supdpart = "Sales Entry(" + trim(sbillno) + ") Edited -" & 
			+ string(dtdate2)

	insert into delpart ( tdate , part , control , slno , utype , ttype , updtdate , updttime , uid , ic )
	values (  :dtdate ,  :supdpart ,  :gisemi ,  :lslno , 'E' , 'S' ,  :dtupddate ,  :dtupdtime ,  :gsuserid ,  :gsincharge );

	if sqlca.sqlcode <> 0 then
		messagebox("Warning","delpart makes problem.." + sqlca.sqlerrtext,exclamation!,ok!)
		bsave = false
	end if
end if

if bsave then
	commit;

    boolean lb_conn_success
	integer li_result
	long ll_transaction_slno
	string ls_operation
	
	if cbx_updtfr.checked then
			ll_transaction_slno = lslno  
			ls_operation =saded        
			
			lb_conn_success = connectdbf4(1)
			
			if lb_conn_success then
				 
				 li_result = updatefr(ll_transaction_slno, ls_operation)
				 
				 
				 if li_result = 1 then
					//  messagebox("Success", "successfully!")
					 
				 else
					  messagebox("Error", "failed!")
				 end if
				 
				
				 disconnect using transtmp4;
			else
				 
				 messagebox("Connection Error", "check configuration.")
			end if
	end if    		
	
	//	cbx_updtfr.checked
	//		updatefr(lslno,this.saded)
		

	

else
	messagebox("Error","This transaction is not saved..." + sqlca.sqlerrtext,exclamation!,ok!)

	rollback;

	cb_save.enabled = true

	return 0
end if

return lslno
end function

public  subroutine  stktypechk ();
int irow
string sstktype2
string sqtype2
string sparm2
string stmp
string scolnm
dec dtouch

irow = dw_sale.getrow()
sstktype2 = dw_sale.getitemstring(irow,"stktype")
sqtype2 = dw_sale.getitemstring(irow,"iqtype")

if isnull(sstktype2) then
	sstktype2 = ""
end if

if isnull(sqtype2) then
	sqtype2 = ""
end if

stmp = sqtype2
sparm2 = sstktype2

if sqtype2 <> "" then
	sparm2 = sstktype2 + "|" + sqtype2
end if

dtouch = dw_sale.getitemnumber(irow,"stktouch")

if isnull(dtouch) then
	dtouch = 0
end if

if dtouch > 0 then
	sparm2 = sparm2 + "\" + string(dtouch,"####0.##")
end if

openwithparm(w_stktypeqtype,sparm2)
sparm2 = message.stringparm
sstktype2 = ""
sqtype2 = ""

if pos(sparm2,"|") > 0 then
	sstktype2 = left(sparm2,pos(sparm2,"|") - 1)
	sqtype2 = mid(sparm2,pos(sparm2,"|") + 1,10)

	if pos(sqtype2,"\") > 0 then
		dtouch = dec(mid(sqtype2,pos(sqtype2,"\") + 1,30))
		sqtype2 = left(sqtype2,pos(sqtype2,"\") - 1)
	end if
else
	if pos(sparm2,"\") > 0 then
		dtouch = dec(mid(sparm2,pos(sparm2,"\") + 1,30))
		sstktype2 = left(sparm2,pos(sparm2,"\") - 1)
	else
		if sparm2 <> "" then
			sstktype2 = trim(sparm2)
		end if
	end if
end if

if sparm2 <> "" then
	dw_sale.setitem(irow,"stktype",sstktype2)
	dw_sale.setitem(irow,"iqtype",sqtype2)

	if dtouch > 0 then
		dw_sale.setitem(irow,"stktouch",dtouch)
	end if

	st_kdm.text = sqtype2
	st_stktype.text = sstktype2

	if stmp <> sqtype2 then
		if messagebox("Warning","Do you want to update wastage & MC for dw_sale item~naccording to the quality type?",question!,yesno!,1) = 1 then
			scolnm = dw_sale.getcolumnname()
			dw_sale.setcolumn("weight")
			dw_sale.triggerevent(itemchanged!)
			dw_sale.setcolumn(scolnm)
		end if
	end if
end if

return
end subroutine

public  subroutine  calcbcharge (int rtype);
dec drcvd
dec dnetamt
dec dbal
dec dbamt
dec ddisc
dec deamt
dec dtaxamt
dec dsramt
dec dround
dec dast
dec dbc
dec dcomn
dec dcomntax
dec dbcomn
dec dbcomntax
dec dccamt
dec drcamt
dec dhmc
string scode

dbc = 0
scode = trim(dw_cashbank.gettext())

if isnull(scode) then
	scode = ""
end if

dccamt = dec(em_ccamt.text)

if scode <> "CASH" then
	if rtype = 0 then
		if dccamt > 0 then
			dnetamt = dccamt
		else
			dnetamt = dec(em_rcvd.text)
		end if
	else
		dbamt = dec(em_billtotal.text)
		ddisc = dec(em_discount.text)
		deamt = dec(em_exchange.text)
		dsramt = dec(em_sreturn.text)
		dnetamt = dec(em_nettot.text)
		drcvd = dec(em_rcvd.text)
		dtaxamt = dec(em_staxamt.text)
		dast = dec(em_ast.text)
		drcamt = dec(em_rcamt.text)
		dhmc = dec(em_hmc.text)

		if isnull(dbamt) then
			dbamt = 0
		end if

		if isnull(ddisc) then
			ddisc = 0
		end if

		if isnull(deamt) then
			deamt = 0
		end if

		if isnull(dsramt) then
			dsramt = 0
		end if

		if isnull(dnetamt) then
			dnetamt = 0
		end if

		if isnull(drcvd) then
			drcvd = 0
		end if

		if isnull(dtaxamt) then
			dtaxamt = 0
		end if

		dnetamt = dbamt + dtaxamt + dast + drcamt + dhmc - deamt - dsramt - ddisc
	end if

	select cvalue 
	into :dbcomn
	from generald
	where code ='BANKCOMN';

	select cvalue 
	into :dbcomntax
	from generald
	where code ='BCOMNTAX';

	if isnull(dbcomn) then
		dbcomn = 0
	end if

	if isnull(dbcomntax) then
		dbcomntax = 0
	end if

	if dccamt > 0 then
		dnetamt = dccamt
	end if

	if dec(em_bcperc.text) > 0 then
		dbcomn = dec(em_bcperc.text)
	end if

	dcomn = round((dnetamt * dbcomn) / 100,1)
	dcomntax = round((dcomn * dbcomntax) / 100,1)
	dbc = dcomn + dcomntax
end if

em_bcharge.text = string(dbc)

return
end subroutine

public  subroutine  filldetails (long rslno);
string sbillno
string scustname
string sitemtype
string scustcode
string snodisc
string sshowwgt
string scst
string sprintwanda
string ssmcode
string scode
int icontrol
int ijewl
int iqty
int idmdnos
int ifr
int istkqtya
int istkqtyb
int idistance
long lslno
long lterows
long lrow
long lsno
dec dbamt
dec drcvd
dec ddisc
dec dexamt
dec dsretamt
dec dgrate
dec dsrate
dec dbalance
dec dast5
datetime dtdate
datetime dtduedate
time ttime
string sname
string sstkinnos
string sname2
string srmno
string sstkfd
string sfr
string sbilltype
string sloan
string saddbcharge
string scbcode
string sws
string smob
string spos
dec dweight
dec dstwgt
dec dstprice
dec dmcharge
dec dwastage
dec drate
dec damount
dec dcostperc
dec dastperc
dec dbultouch
dec dlessperc
dec dlesswgt
dec drcamt
dec dcardamt
dec dredmpoints
dec dtax5
dec dtax5perc
dec dtcsperc
dec dtcsamt
dec dtaxperc
dec dtaxamt
dec dcost
dec dob
dec dtouch
dec dstktouch
dec dcostmc
dec dpcpoint = 0
dec dpcamt = 0
string sjewlcode
string skdm
string scocode
string sdmdunit
string smark
string sstktype
string ssr
string sqtype
string scounter
string saddr
string snote
string sbatch
string smodel
string sagent
string span
dec dwstgrate
dec dmcrate
dec dstkwgta
dec dstkwgtb
dec dmud
dec dround
dec djrate
dec djva
dec dvaperqty
dec dvaperc
dec dvaperc2
dec dchqamt
dec dbcperc
dec ddmdamt
dec ddmdwgt
dec dast
dec dretdisc
dec dptaxperc
dec dptax
dec drate2
dec dbcharge
dec dccamt
dec dhmc
dec ddiscperc
dec dadv
dec dfancyamt
dec dschmamt
date dtchqdate
string schqbank
string schqno
string schqpdc
string sstate
string sapprovedby
string sccpdc
string stin
string svehno
string snote2
string shuid
longlong lbcode
boolean beof
int icnt

declare cursors cursor for
 select salesd.code , salesd.name , salesd.qty , salesd.weight , salesd.stonewgt , salesd.stoneprice , salesd.mcharge , salesd.wastage , salesd.amount , items.itype , salesd.rate , salesd.jcode , salesd.kdm , salesd.cost , items.weight , items.qty , items.weightb , items.qtyb , items.wastage , items.mcharge , salesd.jrate , salesd.jva , items.stkinnos , salesd.bcode , items.name , salesd.rmno , salesd.mark , salesd.stktype , salesd.fr , salesd.sno , salesd.iqtype , items.vaperqty , items.vaperc , salesd.stktouch , salesd.vaperc , salesd.model , salesd.note , salesd.huid from salesd , items where salesd.code =items.code and salesd.slno = :lslno order by sno ;

declare cursorsr cursor for
 select salesrd.code , salesrd.name , salesrd.qty , salesrd.weight , salesrd.stonewgt , salesrd.stoneprice , salesrd.mcharge , salesrd.wastage , salesrd.amount , items.itype , salesrd.rate , salesrd.jcode , salesrd.kdm , salesrd.cost , items.weight , items.qty , items.weightb , items.qtyb , items.wastage , items.mcharge , items.stkinnos , items.name , salesrd.mark , salesrd.stktype , salesrd.iqtype , salesrd.stktouch , salesrd.bcode from salesrd , items where salesrd.code =items.code and salesrd.slno = :lslno order by sno ;

declare cursorp cursor for
 select purchased.code , purchased.name , purchased.qty , purchased.rate , purchased.weight , purchased.lesswgt , purchased.amount , items.itype , purchased.cost , purchased.stwgt , purchased.stprice , purchased.mud , items.name , purchased.mark , purchased.stktype , purchased.iqtype , purchased.lessperc , purchased.touch , purchased.stktouch , purchased.rate2 , purchased.batch from purchased , items where purchased.code =items.code and slno = :lslno order by sno ;

this.title = "Edit Sales"
lslno = rslno

SELECT billno , custcode , custname , billamt , ramt , discount , tdate , eamt , grate , control , ttime , srate , staxperc , staxamt , ramtafter , duedate , smcode , sretamt , ob , cocode , round , sr , astamt , counter , fr , billtype , addr , note , loan , bcharge , addbcharge , cbcode , ccamt , hmc , discperc , advance , showwgt , ws , rcamt , thrate , cst , printwanda , mobno , agcode , fancyamt , schmamt , chqbank , chqamt , chqno , chqdate , chqpdc , placeos , pan , statecode , redmpoints , bcperc , approvedby , ccpdc , tin , astperc , tcsperc , tcsamt , bultouch , vehno , distance 
INTO :sbillno, :scustcode, :scustname, :dbamt, :drcvd, :ddisc, :dtdate, :dexamt, :dgrate, :icontrol, :ttime, :dsrate, :dtaxperc, :dtaxamt, :this.dircvdafter, :dtduedate, :ssmcode, :dsretamt, :dob, :scocode, :dround, :ssr, :dast, :scounter, :sfr, :sbilltype, :saddr, :snote, :sloan, :dbcharge, :saddbcharge, :scbcode, :dccamt, :dhmc, :ddiscperc, :dadv, :sshowwgt, :sws, :drcamt, :this.dithrate, :scst, :sprintwanda, :smob, :sagent, :dfancyamt, :dschmamt, :schqbank, :dchqamt, :schqno, :dtchqdate, :schqpdc, :spos, :span, :sstate, :dredmpoints, :dbcperc, :sapprovedby, :sccpdc, :stin, :dastperc, :dtcsperc, :dtcsamt, :dbultouch, :svehno, :idistance
FROM salesm
WHERE slno = :lslno;

if profilestring(gsinifile,"Software","EditShortPrintOnly","N") = "Y" and &
		ssr <> "T" and &
		giaccount = 2 then
	messagebox("Access Denied..","You are not permited to edit this document...")
	close(this)

	return
end if

if sqlca.sqlcode <> 0 then
	messagebox("Err",sqlca.sqlerrtext)
end if

select taxperc , taxamt 
into :dptaxperc, :dptax
from purchasem
where slno = :lslno;

select discount 
into :dretdisc
from salesrm
where slno = :lslno;

if isnull(dretdisc) then
	dretdisc = 0
end if

if dbultouch > 0 then
	this.dibultouch = dbultouch
end if

st_bultouch.text = string(this.dibultouch)
setpointer(hourglass!)

if icontrol = 1 then
	this.seb = "B"
else
	this.seb = "E"
end if

this.lislno = lslno
this.titime = time(ttime)
this.ditaxperc = dtaxperc
dw_sale.settransobject(sqlca)
dw_smcode.setitem(1,1,ssmcode)
em_date.text = string(dtdate,"dd/mm/yyyy")
em_rate.text = string(dgrate)
em_rate8gm.text = string(dgrate * 8)
dw_1.settext(scustcode)
dw_1.setitem(1,1,scustcode)
dw_1.accepttext()
dw_co.settext(scocode)
dw_co.setitem(1,1,scocode)
dw_co.accepttext()
dw_billtype.setitem(1,1,sbilltype)
dw_counter.setitem(1,1,scounter)
st_time.text = string(ttime,"HH:MM AM/PM")
st_billno.text = sbillno
st_custname.text = scustname
sle_addr.text = saddr
sle_mobno.text = smob
sle_vehno.text = svehno
em_distance.text = string(idistance)
sle_pan.text = span
em_ob.text = string(dob)
em_billtotal.text = string(dbamt)
em_exchange.text = string(dexamt)
em_sreturn.text = string(dsretamt)
em_taxperc.text = string(dtaxperc)
em_staxamt.text = string(dtaxamt)
em_ast.text = string(dast)
em_tcsperc.text = string(dtcsperc)
em_tcsamt.text = string(dtcsamt)
em_hmc.text = string(dhmc)
em_rcamt.text = string(drcamt)
em_schmamt.text = string(dschmamt)
em_fancyamt.text = string(dfancyamt)

if isnull(dtcsamt) then
	dtcsamt = 0
end if

em_nettot.text = string(dbamt - dexamt - dsretamt + dtaxamt + dround + dast + dtcsamt + dhmc + drcamt + dfancyamt - dschmamt - dadv)
em_discount.text = string(ddisc)
em_discperc.text = string(ddiscperc)
em_redmpoints.text = string(dredmpoints)
em_rcvd.text = string(drcvd)

if isnull(ddisc) then
	ddisc = 0
end if

if isnull(drcvd) then
	drcvd = 0
end if

em_balance.text = string(dec(em_nettot.text) - ddisc - drcvd)

if year(date(dtduedate)) > 1940 then
	em_duedate.text = string(dtduedate,"dd/mm/yyyy")
end if

em_ptaxperc.text = string(dptaxperc)
em_ptaxamt.text = string(dptax)
sle_note.text = snote
dw_cashbank.setitem(1,1,scbcode)
em_ccamt.text = string(dccamt)
em_bcharge.text = string(dbcharge)
em_advance.text = string(dadv)
dw_agent.setitem(1,1,sagent)
dw_chqbank.setitem(1,1,schqbank)
em_chqamt.text = string(dchqamt)
sle_chqno.text = schqno
em_chqdate.text = string(dtchqdate)
sle_pos.text = spos
dw_state.setitem(1,1,sstate)
dw_approvedby.setitem(1,1,sapprovedby)
sle_tin.text = stin
em_astperc.text = string(dastperc)

if dbcperc > 0 then
	em_bcperc.text = string(dbcperc)
end if

if schqpdc = "Y" then
	cbx_pdc.checked = true
else
	cbx_pdc.checked = false
end if

if sccpdc = "Y" then
	cbx_ccpdc.checked = true
else
	cbx_ccpdc.checked = false
end if

if sshowwgt = "Y" then
	cbx_showwgt.checked = true
else
	cbx_showwgt.checked = false
end if

if saddbcharge = "Y" then
	cbx_addbc.checked = true
else
	cbx_addbc.checked = false
end if

if sloan = "Y" then
	cbx_loan.checked = true
end if

if scst = "Y" then
	cbx_cst.checked = true
end if

this.ditaxperc = dtaxperc

if sws = "Y" then
	cbx_ws.checked = true
else
	cbx_ws.checked = false
end if

this.dibal = dec(em_balance.text)

if this.dibal > 0 then
	cbx_credit.checked = true
end if

if sfr = "Y" then
	cbx_updtfr.checked = true
else
	cbx_updtfr.checked = false
end if

if sprintwanda = "Y" then
	cbx_printwanda.checked = true
end if

SELECT count ( *) 
INTO :lterows
FROM purchased
WHERE slno = :lslno;

if isnull(lterows) then
	lterows = 0
end if

open cursors;      //sqlca

beof = false
dw_sale.reset()

do while not beof
	fetch cursors into :scode,:sname,:iqty,:dweight,:dstwgt,:dstprice,:dmcharge,:dwastage,:damount,:sitemtype,:drate,:sjewlcode,:skdm,:dcost,:dstkwgta,:istkqtya,:dstkwgtb,:istkqtyb,:dwstgrate,:dmcrate,:djrate,:djva,:sstkinnos,:lbcode,:sname2,:srmno,:smark,:sstktype,:ifr,:lsno,:sqtype,:dvaperqty,:dvaperc2,:dstktouch,:dvaperc,:smodel,:snote2,:shuid;      //sqlca

	if sqlca.sqlcode <> 0 then
		beof = true
	end if

	if not beof then
		ddmdwgt = 0
		ddmdamt = 0
		sdmdunit = ""
		idmdnos = 0
		dcostmc = 0

		if lbcode > 0 then
			select nodisc , costmc , costperc 
			into :snodisc, :dcostmc, :dcostperc
			from barcode
			where bcode = :lbcode;

			if snodisc = "N" then
				this.sinodisc = "N"
			end if
		end if

		select dmdwgt , dmdunit , dmdamt , dmdnos 
		into :ddmdwgt, :sdmdunit, :ddmdamt, :idmdnos
		from spdmddet
		where slno = :lslno and
		sno = :lsno;

		if isnull(ddmdwgt) then
			ddmdwgt = 0
		end if

		if isnull(ddmdamt) then
			ddmdamt = 0
		end if

		if isnull(sdmdunit) then
			sdmdunit = ""
		end if

		if isnull(idmdnos) then
			idmdnos = 0
		end if

		if dvaperc = 0 and &
				dvaperc2 > 0 then
			dvaperc = dvaperc2
		end if

		scode = trim(scode)
		sname = trim(sname)
		iqty = round(iqty,0)
		dweight = round(dweight,3)
		drate = round(drate,2)
		dstwgt = round(dstwgt,3)
		dstprice = round(dstprice,2)
		dmcharge = round(dmcharge,2)
		dwastage = round(dwastage,3)
		damount = round(damount,2)

		if lbcode <> 0 then
			select wastage , mcrate 
			into :dwstgrate, :dmcrate
			from barcode
			where bcode = :lbcode;
		end if

		if trim(sjewlcode) <> "" and &
				not isnull(sjewlcode) then
			ijewl = 1
		end if

		if sname = "" or &
				isnull(sname) then
			sname = sname2
		end if

		lrow = dw_sale.insertrow(0)
		dw_sale.setitem(lrow,"itemcode",scode)
		dw_sale.setitem(lrow,"itemname",sname)
		dw_sale.setitem(lrow,"rate",drate)
		dw_sale.setitem(lrow,"qty",iqty)
		dw_sale.setitem(lrow,"weight",dweight)
		dw_sale.setitem(lrow,"stonewgt",dstwgt)
		dw_sale.setitem(lrow,"stoneprice",dstprice)
		dw_sale.setitem(lrow,"mcharge",dmcharge)
		dw_sale.setitem(lrow,"wastage",dwastage)
		dw_sale.setitem(lrow,"amount",damount)
		dw_sale.setitem(lrow,"itemtype",sitemtype)
		dw_sale.setitem(lrow,"jewlcode",sjewlcode)
		dw_sale.setitem(lrow,"jewl",ijewl)
		dw_sale.setitem(lrow,"kdm",skdm)
		dw_sale.setitem(lrow,"iqtype",sqtype)
		dw_sale.setitem(lrow,"cost",dcost)
		dw_sale.setitem(lrow,"stkinnos",sstkinnos)
		dw_sale.setitem(lrow,"bcode",lbcode)
		dw_sale.setitem(lrow,"dmdamt",ddmdamt)
		dw_sale.setitem(lrow,"dmdwgt",ddmdwgt)
		dw_sale.setitem(lrow,"dmdnos",idmdnos)
		dw_sale.setitem(lrow,"dmdunit",sdmdunit)
		dw_sale.setitem(lrow,"stktype",sstktype)
		dw_sale.setitem(lrow,"fr",ifr)
		dw_sale.setitem(lrow,"stktouch",dstktouch)
		dw_sale.setitem(lrow,"mccost",dcostmc)
		dw_sale.setitem(lrow,"bcitem",scode)
		dw_sale.setitem(lrow,"pcostperc",dcostperc)

		if icontrol = 1 then
			dw_sale.setitem(lrow,"stockwgt",dstkwgta)
			dw_sale.setitem(lrow,"stockqty",istkqtya)
		else
			dw_sale.setitem(lrow,"stockwgt",dstkwgtb)
			dw_sale.setitem(lrow,"stockqty",istkqtyb)
		end if

		dw_sale.setitem(lrow,"wstgrate",dwstgrate)
		dw_sale.setitem(lrow,"mcrate",dmcrate)
		dw_sale.setitem(lrow,"vaperqty",dvaperqty)
		dw_sale.setitem(lrow,"vaperc",dvaperc)
		dw_sale.setitem(lrow,"jrate",djrate)
		dw_sale.setitem(lrow,"jva",djva)
		dw_sale.setitem(lrow,"rmno",srmno)
		dw_sale.setitem(lrow,"stkfd",smark)
		dw_sale.setitem(lrow,"model",smodel)
		dw_sale.setitem(lrow,"note",snote2)
		dw_sale.setitem(lrow,"huid",shuid)
	end if
loop

close cursors;      //sqlca

if dsretamt > 0 then
	select staxperc , staxamt , astamt 
	into :dtax5perc, :dtax5, :dast5
	from salesrm
	where slno = :lslno;
end if

open cursorsr;      //sqlca

beof = false
lrow = 1

do while not beof
	fetch cursorsr into :scode,:sname,:iqty,:dweight,:dstwgt,:dstprice,:dmcharge,:dwastage,:damount,:sitemtype,:drate,:sjewlcode,:skdm,:dcost,:dstkwgta,:istkqtya,:dstkwgtb,:istkqtyb,:dwstgrate,:dmcrate,:sstkinnos,:sname2,:smark,:sstktype,:sqtype,:dstktouch,:lbcode;      //sqlca

	if sqlca.sqlcode <> 0 then
		beof = true
	end if

	if not beof then
		scode = trim(scode)
		sname = trim(sname)
		iqty = round(iqty,0)
		dweight = round(dweight,3)
		drate = round(drate,2)
		dstwgt = round(dstwgt,3)
		dstprice = round(dstprice,2)
		dmcharge = round(dmcharge,2)
		dwastage = round(dwastage,3)
		damount = round(damount,2)

		if trim(sjewlcode) <> "" and &
				not isnull(sjewlcode) then
			ijewl = 1
		end if

		if sname = "" or &
				isnull(sname) then
			sname = sname2
		end if

		ddmdamt = 0
		ddmdwgt = 0

		if lbcode > 0 then
			select dmdamt , dmdwgt 
			into :ddmdamt, :ddmdwgt
			from barcodedmd
			where bcode = :lbcode;
		end if

		strsreturn[lrow].itemcode = scode
		strsreturn[lrow].itemname = sname
		strsreturn[lrow].rate = drate
		strsreturn[lrow].qty = iqty
		strsreturn[lrow].weight = dweight
		strsreturn[lrow].stonewgt = dstwgt
		strsreturn[lrow].stoneprice = dstprice
		strsreturn[lrow].dmdamt = ddmdamt
		strsreturn[lrow].dmdwgt = ddmdwgt
		strsreturn[lrow].mcharge = dmcharge
		strsreturn[lrow].wastage = dwastage
		strsreturn[lrow].amount = damount
		strsreturn[lrow].itemtype = sitemtype
		strsreturn[lrow].jewlcode = sjewlcode
		strsreturn[lrow].kdm = skdm
		strsreturn[lrow].cost = dcost
		strsreturn[lrow].stkfd = smark
		strsreturn[lrow].stktype = sstktype
		strsreturn[lrow].stkinnos = sstkinnos
		strsreturn[lrow].iqtype = sqtype
		strsreturn[lrow].stktouch = dstktouch
		strsreturn[lrow].wgtamt = dretdisc
		strsreturn[lrow].bcode = lbcode
		strsreturn[lrow].taxperc = dtax5perc
		strsreturn[lrow].taxamt = dtax5
		strsreturn[lrow].ast = dast5
		lrow ++
	end if
loop

close cursorsr;      //sqlca

open cursorp;      //sqlca

if lterows > 0 then
	beof = false
	lrow = 1

	do while not beof
		fetch cursorp into :scode,:sname,:iqty,:drate,:dweight,:dlesswgt,:damount,:sitemtype,:dcost,:dstwgt,:dstprice,:dmud,:sname2,:smark,:sstktype,:sqtype,:dlessperc,:dtouch,:dstktouch,:drate2,:sbatch;      //sqlca

		if sqlca.sqlcode <> 0 then
			beof = true
		end if

		if not beof then
			scode = trim(scode)
			iqty = round(iqty,0)
			dweight = round(dweight,3)
			dlesswgt = round(dlesswgt,3)
			damount = round(damount,2)

			if sname = "" or &
					isnull(sname) then
				sname = sname2
			end if

			strexchange[lrow].itemcode = scode
			strexchange[lrow].itemname = sname
			strexchange[lrow].qty = iqty
			strexchange[lrow].rate = drate
			strexchange[lrow].rate2 = drate2
			strexchange[lrow].weight = dweight
			strexchange[lrow].lesswgt = dlesswgt
			strexchange[lrow].lessperc = dlessperc
			strexchange[lrow].touch = dtouch
			strexchange[lrow].stonewgt = dstwgt
			strexchange[lrow].stoneprice = dstprice
			strexchange[lrow].amount = damount
			strexchange[lrow].itemtype = sitemtype
			strexchange[lrow].cost = dcost
			strexchange[lrow].mud = dmud
			strexchange[lrow].stkfd = smark
			strexchange[lrow].stktype = sstktype
			strexchange[lrow].iqtype = sqtype
			strexchange[lrow].stktouch = dstktouch
			strexchange[lrow].batch = sbatch
			lrow ++
		end if
	loop
end if

close cursorp;      //sqlca

gbok = true

if gicolor = 0 then
	dw_sale.object.datawindow.detail.color = "12632256"
end if

if this.sinodisc = "N" then
	em_discount.enabled = false
end if

em_rcvd.setfocus()
this.balcalc(0)

if scustcode <> "" then
	prevcardcalc(scustcode,date(dtdate),this.lislno,ref dpcpoint,ref dpcamt)
end if

st_pcardpoints.text = string(dpcpoint)
st_pcardamt.text = string(dpcamt)

select count ( code ) 
into :icnt
from userd
where menuitem ='m_tran_sale_edit' and
code = :gsuserid;

if icnt > 0 and &
		ssr <> "T" then
	cb_save.enabled = false
end if

return
end subroutine

public  subroutine  evacalc ();
dec dtamt
dec dtva
dec dvap
dec ddisc

ddisc = dec(em_discount.text)
dvap = 0
dtva = 0
dtamt = 0
dtamt = dec(dw_sale.describe("Evaluate('Sum( if(mcharge > 0, (amount - if(isnull(mcharge),0,mcharge) - if(isnull(stoneprice),0,stoneprice) ),0) )', 0)"))
dtva = dec(dw_sale.describe("Evaluate('Sum( if(mcharge > 0,  if(isnull(mcharge),0,mcharge) ,0 ) )', 0)"))

if dtamt > 0 then
	dvap = ((dtva - ddisc) * 100) / dtamt
end if

st_va.text = string(dtva - ddisc,"#####0.00")
st_vap.text = string(dvap,"###.##") + "%"

return
end subroutine

on w_sales.create
this.st_48=create st_48
this.st_47=create st_47
this.em_dperc=create em_dperc
this.st_46=create st_46
this.em_distance=create em_distance
this.sle_vehno=create sle_vehno
this.st_32=create st_32
this.st_bultouch=create st_bultouch
this.em_tcsamt=create em_tcsamt
this.em_tcsperc=create em_tcsperc
this.st_17=create st_17
this.st_45=create st_45
this.st_42=create st_42
this.em_astperc=create em_astperc
this.sle_tin=create sle_tin
this.st_taxno=create st_taxno
this.st_schemebal=create st_schemebal
this.st_44=create st_44
this.cbx_ccpdc=create cbx_ccpdc
this.st_41=create st_41
this.dw_approvedby=create dw_approvedby
this.em_bcperc=create em_bcperc
this.st_43=create st_43
this.em_redmpoints=create em_redmpoints
this.st_state=create st_state
this.dw_state=create dw_state
this.sle_pan=create sle_pan
this.st_pan=create st_pan
this.sle_pos=create sle_pos
this.st_40=create st_40
this.st_netbalance=create st_netbalance
this.em_netamt=create em_netamt
this.st_39=create st_39
this.st_38=create st_38
this.st_pcardamt=create st_pcardamt
this.st_pcardpoints=create st_pcardpoints
this.st_37=create st_37
this.st_36=create st_36
this.sle_chqno=create sle_chqno
this.dw_chqbank=create dw_chqbank
this.st_35=create st_35
this.cbx_pdc=create cbx_pdc
this.em_chqdate=create em_chqdate
this.em_chqamt=create em_chqamt
this.st_34=create st_34
this.em_schmamt=create em_schmamt
this.st_33=create st_33
this.em_fancyamt=create em_fancyamt
this.st_fancyamt=create st_fancyamt
this.cb_next=create cb_next
this.cb_prev=create cb_prev
this.dw_agent=create dw_agent
this.st_31=create st_31
this.st_bn=create st_bn
this.sle_bn=create sle_bn
this.st_30=create st_30
this.sle_mobno=create sle_mobno
this.st_29=create st_29
this.cbx_sendsms=create cbx_sendsms
this.st_15=create st_15
this.cbx_printwanda=create cbx_printwanda
this.cbx_cst=create cbx_cst
this.cbx_updtsys=create cbx_updtsys
this.st_repair=create st_repair
this.em_rcamt=create em_rcamt
this.cb_rateall=create cb_rateall
this.cbx_ws=create cbx_ws
this.cbx_showwgt=create cbx_showwgt
this.em_advance=create em_advance
this.st_advance=create st_advance
this.cbx_laserprint=create cbx_laserprint
this.em_discperc=create em_discperc
this.em_hmc=create em_hmc
this.st_28=create st_28
this.st_cas=create st_cas
this.em_ccamt=create em_ccamt
this.st_27=create st_27
this.em_bcharge=create em_bcharge
this.st_26=create st_26
this.cbx_addbc=create cbx_addbc
this.dw_print=create dw_print
this.cbx_credit=create cbx_credit
this.st_25=create st_25
this.dw_cashbank=create dw_cashbank
this.cbx_loan=create cbx_loan
this.st_24=create st_24
this.sle_note=create sle_note
this.st_23=create st_23
this.sle_addr=create sle_addr
this.st_vap=create st_vap
this.st_22=create st_22
this.em_ptaxamt=create em_ptaxamt
this.em_ptaxperc=create em_ptaxperc
this.st_rva=create st_rva
this.em_rva=create em_rva
this.st_time=create st_time
this.em_taxperc=create em_taxperc
this.dw_billtype=create dw_billtype
this.st_21=create st_21
this.st_20=create st_20
this.em_grandamt=create em_grandamt
this.st_opwgt=create st_opwgt
this.em_opwgt=create em_opwgt
this.st_billno=create st_billno
this.cbx_manual=create cbx_manual
this.cb_dthlp=create cb_dthlp
this.st_19=create st_19
this.dw_counter=create dw_counter
this.st_18=create st_18
this.em_ast=create em_ast
this.st_netamt=create st_netamt
this.em_netbalance=create em_netbalance
this.st_stktype=create st_stktype
this.cb_cohelp=create cb_cohelp
this.cb_custhelp=create cb_custhelp
this.cbx_updtfr=create cbx_updtfr
this.cb_qtnprint=create cb_qtnprint
this.cb_short=create cb_short
this.dw_co=create dw_co
this.st_16=create st_16
this.em_ob=create em_ob
this.st_ob=create st_ob
this.st_itemcode_m=create st_itemcode_m
this.st_itemname_m=create st_itemname_m
this.st_qty_m=create st_qty_m
this.st_weight_m=create st_weight_m
this.st_stwgt_m=create st_stwgt_m
this.st_stprice_m=create st_stprice_m
this.st_wastage_m=create st_wastage_m
this.st_mc_m=create st_mc_m
this.st_amount_m=create st_amount_m
this.st_rate_m=create st_rate_m
this.st_jewl_m=create st_jewl_m
this.st_itemadj=create st_itemadj
this.st_kdm=create st_kdm
this.dw_smcode=create dw_smcode
this.st_10=create st_10
this.st_jcode=create st_jcode
this.st_va=create st_va
this.st_stock=create st_stock
this.em_sreturn=create em_sreturn
this.st_sreturn=create st_sreturn
this.cb_sreturn=create cb_sreturn
this.cb_exchange=create cb_exchange
this.st_14=create st_14
this.st_13=create st_13
this.st_12=create st_12
this.st_11=create st_11
this.st_9=create st_9
this.st_8=create st_8
this.st_7=create st_7
this.st_6=create st_6
this.st_5=create st_5
this.st_4=create st_4
this.em_duedate=create em_duedate
this.st_3=create st_3
this.st_custname=create st_custname
this.em_staxamt=create em_staxamt
this.st_staxamt=create st_staxamt
this.dw_1=create dw_1
this.em_rate8gm=create em_rate8gm
this.st_2=create st_2
this.em_rate=create em_rate
this.st_1=create st_1
this.cb_delete=create cb_delete
this.em_rcvd=create em_rcvd
this.st_rcvd=create st_rcvd
this.em_balance=create em_balance
this.st_balance=create st_balance
this.em_nettot=create em_nettot
this.st_nettot=create st_nettot
this.em_exchange=create em_exchange
this.st_exchange=create st_exchange
this.em_discount=create em_discount
this.st_discount=create st_discount
this.em_billtotal=create em_billtotal
this.st_billtotal=create st_billtotal
this.st_custcode=create st_custcode
this.em_date=create em_date
this.st_date=create st_date
this.st_bill=create st_bill
this.cb_exit=create cb_exit
this.cb_save=create cb_save
this.cb_add=create cb_add
this.rr_1=create rr_1
this.st_retamt_m=create st_retamt_m
this.st_netamt_m=create st_netamt_m
this.st_balance_m=create st_balance_m
this.st_duedate_m=create st_duedate_m
this.st_rcvdamt_m=create st_rcvdamt_m
this.st_exchamt_m=create st_exchamt_m
this.st_billamt_m=create st_billamt_m
this.st_taxamt_m=create st_taxamt_m
this.st_discount_m=create st_discount_m
this.st_grategm_m=create st_grategm_m
this.st_customer_m=create st_customer_m
this.st_date_m=create st_date_m
this.st_gratepavan_m=create st_gratepavan_m
this.st_smname_m=create st_smname_m
this.dw_sale=create dw_sale
this.Control[]={this.st_48,&
this.st_47,&
this.em_dperc,&
this.st_46,&
this.em_distance,&
this.sle_vehno,&
this.st_32,&
this.st_bultouch,&
this.em_tcsamt,&
this.em_tcsperc,&
this.st_17,&
this.st_45,&
this.st_42,&
this.em_astperc,&
this.sle_tin,&
this.st_taxno,&
this.st_schemebal,&
this.st_44,&
this.cbx_ccpdc,&
this.st_41,&
this.dw_approvedby,&
this.em_bcperc,&
this.st_43,&
this.em_redmpoints,&
this.st_state,&
this.dw_state,&
this.sle_pan,&
this.st_pan,&
this.sle_pos,&
this.st_40,&
this.st_netbalance,&
this.em_netamt,&
this.st_39,&
this.st_38,&
this.st_pcardamt,&
this.st_pcardpoints,&
this.st_37,&
this.st_36,&
this.sle_chqno,&
this.dw_chqbank,&
this.st_35,&
this.cbx_pdc,&
this.em_chqdate,&
this.em_chqamt,&
this.st_34,&
this.em_schmamt,&
this.st_33,&
this.em_fancyamt,&
this.st_fancyamt,&
this.cb_next,&
this.cb_prev,&
this.dw_agent,&
this.st_31,&
this.st_bn,&
this.sle_bn,&
this.st_30,&
this.sle_mobno,&
this.st_29,&
this.cbx_sendsms,&
this.st_15,&
this.cbx_printwanda,&
this.cbx_cst,&
this.cbx_updtsys,&
this.st_repair,&
this.em_rcamt,&
this.cb_rateall,&
this.cbx_ws,&
this.cbx_showwgt,&
this.em_advance,&
this.st_advance,&
this.cbx_laserprint,&
this.em_discperc,&
this.em_hmc,&
this.st_28,&
this.st_cas,&
this.em_ccamt,&
this.st_27,&
this.em_bcharge,&
this.st_26,&
this.cbx_addbc,&
this.dw_print,&
this.cbx_credit,&
this.st_25,&
this.dw_cashbank,&
this.cbx_loan,&
this.st_24,&
this.sle_note,&
this.st_23,&
this.sle_addr,&
this.st_vap,&
this.st_22,&
this.em_ptaxamt,&
this.em_ptaxperc,&
this.st_rva,&
this.em_rva,&
this.st_time,&
this.em_taxperc,&
this.dw_billtype,&
this.st_21,&
this.st_20,&
this.em_grandamt,&
this.st_opwgt,&
this.em_opwgt,&
this.st_billno,&
this.cbx_manual,&
this.cb_dthlp,&
this.st_19,&
this.dw_counter,&
this.st_18,&
this.em_ast,&
this.st_netamt,&
this.em_netbalance,&
this.st_stktype,&
this.cb_cohelp,&
this.cb_custhelp,&
this.cbx_updtfr,&
this.cb_qtnprint,&
this.cb_short,&
this.dw_co,&
this.st_16,&
this.em_ob,&
this.st_ob,&
this.st_itemcode_m,&
this.st_itemname_m,&
this.st_qty_m,&
this.st_weight_m,&
this.st_stwgt_m,&
this.st_stprice_m,&
this.st_wastage_m,&
this.st_mc_m,&
this.st_amount_m,&
this.st_rate_m,&
this.st_jewl_m,&
this.st_itemadj,&
this.st_kdm,&
this.dw_smcode,&
this.st_10,&
this.st_jcode,&
this.st_va,&
this.st_stock,&
this.em_sreturn,&
this.st_sreturn,&
this.cb_sreturn,&
this.cb_exchange,&
this.st_14,&
this.st_13,&
this.st_12,&
this.st_11,&
this.st_9,&
this.st_8,&
this.st_7,&
this.st_6,&
this.st_5,&
this.st_4,&
this.em_duedate,&
this.st_3,&
this.st_custname,&
this.em_staxamt,&
this.st_staxamt,&
this.dw_1,&
this.em_rate8gm,&
this.st_2,&
this.em_rate,&
this.st_1,&
this.cb_delete,&
this.em_rcvd,&
this.st_rcvd,&
this.em_balance,&
this.st_balance,&
this.em_nettot,&
this.st_nettot,&
this.em_exchange,&
this.st_exchange,&
this.em_discount,&
this.st_discount,&
this.em_billtotal,&
this.st_billtotal,&
this.st_custcode,&
this.em_date,&
this.st_date,&
this.st_bill,&
this.cb_exit,&
this.cb_save,&
this.cb_add,&
this.rr_1,&
this.st_retamt_m,&
this.st_netamt_m,&
this.st_balance_m,&
this.st_duedate_m,&
this.st_rcvdamt_m,&
this.st_exchamt_m,&
this.st_billamt_m,&
this.st_taxamt_m,&
this.st_discount_m,&
this.st_grategm_m,&
this.st_customer_m,&
this.st_date_m,&
this.st_gratepavan_m,&
this.st_smname_m,&
this.dw_sale}
end on

on w_sales.destroy
destroy(this.st_48)
destroy(this.st_47)
destroy(this.em_dperc)
destroy(this.st_46)
destroy(this.em_distance)
destroy(this.sle_vehno)
destroy(this.st_32)
destroy(this.st_bultouch)
destroy(this.em_tcsamt)
destroy(this.em_tcsperc)
destroy(this.st_17)
destroy(this.st_45)
destroy(this.st_42)
destroy(this.em_astperc)
destroy(this.sle_tin)
destroy(this.st_taxno)
destroy(this.st_schemebal)
destroy(this.st_44)
destroy(this.cbx_ccpdc)
destroy(this.st_41)
destroy(this.dw_approvedby)
destroy(this.em_bcperc)
destroy(this.st_43)
destroy(this.em_redmpoints)
destroy(this.st_state)
destroy(this.dw_state)
destroy(this.sle_pan)
destroy(this.st_pan)
destroy(this.sle_pos)
destroy(this.st_40)
destroy(this.st_netbalance)
destroy(this.em_netamt)
destroy(this.st_39)
destroy(this.st_38)
destroy(this.st_pcardamt)
destroy(this.st_pcardpoints)
destroy(this.st_37)
destroy(this.st_36)
destroy(this.sle_chqno)
destroy(this.dw_chqbank)
destroy(this.st_35)
destroy(this.cbx_pdc)
destroy(this.em_chqdate)
destroy(this.em_chqamt)
destroy(this.st_34)
destroy(this.em_schmamt)
destroy(this.st_33)
destroy(this.em_fancyamt)
destroy(this.st_fancyamt)
destroy(this.cb_next)
destroy(this.cb_prev)
destroy(this.dw_agent)
destroy(this.st_31)
destroy(this.st_bn)
destroy(this.sle_bn)
destroy(this.st_30)
destroy(this.sle_mobno)
destroy(this.st_29)
destroy(this.cbx_sendsms)
destroy(this.st_15)
destroy(this.cbx_printwanda)
destroy(this.cbx_cst)
destroy(this.cbx_updtsys)
destroy(this.st_repair)
destroy(this.em_rcamt)
destroy(this.cb_rateall)
destroy(this.cbx_ws)
destroy(this.cbx_showwgt)
destroy(this.em_advance)
destroy(this.st_advance)
destroy(this.cbx_laserprint)
destroy(this.em_discperc)
destroy(this.em_hmc)
destroy(this.st_28)
destroy(this.st_cas)
destroy(this.em_ccamt)
destroy(this.st_27)
destroy(this.em_bcharge)
destroy(this.st_26)
destroy(this.cbx_addbc)
destroy(this.dw_print)
destroy(this.cbx_credit)
destroy(this.st_25)
destroy(this.dw_cashbank)
destroy(this.cbx_loan)
destroy(this.st_24)
destroy(this.sle_note)
destroy(this.st_23)
destroy(this.sle_addr)
destroy(this.st_vap)
destroy(this.st_22)
destroy(this.em_ptaxamt)
destroy(this.em_ptaxperc)
destroy(this.st_rva)
destroy(this.em_rva)
destroy(this.st_time)
destroy(this.em_taxperc)
destroy(this.dw_billtype)
destroy(this.st_21)
destroy(this.st_20)
destroy(this.em_grandamt)
destroy(this.st_opwgt)
destroy(this.em_opwgt)
destroy(this.st_billno)
destroy(this.cbx_manual)
destroy(this.cb_dthlp)
destroy(this.st_19)
destroy(this.dw_counter)
destroy(this.st_18)
destroy(this.em_ast)
destroy(this.st_netamt)
destroy(this.em_netbalance)
destroy(this.st_stktype)
destroy(this.cb_cohelp)
destroy(this.cb_custhelp)
destroy(this.cbx_updtfr)
destroy(this.cb_qtnprint)
destroy(this.cb_short)
destroy(this.dw_co)
destroy(this.st_16)
destroy(this.em_ob)
destroy(this.st_ob)
destroy(this.st_itemcode_m)
destroy(this.st_itemname_m)
destroy(this.st_qty_m)
destroy(this.st_weight_m)
destroy(this.st_stwgt_m)
destroy(this.st_stprice_m)
destroy(this.st_wastage_m)
destroy(this.st_mc_m)
destroy(this.st_amount_m)
destroy(this.st_rate_m)
destroy(this.st_jewl_m)
destroy(this.st_itemadj)
destroy(this.st_kdm)
destroy(this.dw_smcode)
destroy(this.st_10)
destroy(this.st_jcode)
destroy(this.st_va)
destroy(this.st_stock)
destroy(this.em_sreturn)
destroy(this.st_sreturn)
destroy(this.cb_sreturn)
destroy(this.cb_exchange)
destroy(this.st_14)
destroy(this.st_13)
destroy(this.st_12)
destroy(this.st_11)
destroy(this.st_9)
destroy(this.st_8)
destroy(this.st_7)
destroy(this.st_6)
destroy(this.st_5)
destroy(this.st_4)
destroy(this.em_duedate)
destroy(this.st_3)
destroy(this.st_custname)
destroy(this.em_staxamt)
destroy(this.st_staxamt)
destroy(this.dw_1)
destroy(this.em_rate8gm)
destroy(this.st_2)
destroy(this.em_rate)
destroy(this.st_1)
destroy(this.cb_delete)
destroy(this.em_rcvd)
destroy(this.st_rcvd)
destroy(this.em_balance)
destroy(this.st_balance)
destroy(this.em_nettot)
destroy(this.st_nettot)
destroy(this.em_exchange)
destroy(this.st_exchange)
destroy(this.em_discount)
destroy(this.st_discount)
destroy(this.em_billtotal)
destroy(this.st_billtotal)
destroy(this.st_custcode)
destroy(this.em_date)
destroy(this.st_date)
destroy(this.st_bill)
destroy(this.cb_exit)
destroy(this.cb_save)
destroy(this.cb_add)
destroy(this.rr_1)
destroy(this.st_retamt_m)
destroy(this.st_netamt_m)
destroy(this.st_balance_m)
destroy(this.st_duedate_m)
destroy(this.st_rcvdamt_m)
destroy(this.st_exchamt_m)
destroy(this.st_billamt_m)
destroy(this.st_taxamt_m)
destroy(this.st_discount_m)
destroy(this.st_grategm_m)
destroy(this.st_customer_m)
destroy(this.st_date_m)
destroy(this.st_gratepavan_m)
destroy(this.st_smname_m)
destroy(this.dw_sale)
end on

event open;string scode
string ssmcode
string spref
string slen
string schk
int icnt
dec dbcomn
long lslno
string ssr
long lbillno
int islno
date dtdate
dec dtaxperc
string sbillno

if profilestring(gsinifile,"Software","SManCodeEntry","N") = "Y" then
	dw_smcode.object.code.dddw.allowedit = "Yes"
end if

schk = "Corruption detected..."

if profilestring(gsinifile,"Software","CoPartySeperate","N") = "Y" then
	dw_co.dataobject = "d_coparty"
end if

if gskeepwgtledger = "Y" then
	cbx_showwgt.checked = true
end if

if profilestring(gsinifile,"Software","DefRate","RTR") = "WSR" then
	cbx_ws.checked = true
end if

if gisysupdt = 0 then
	cbx_updtsys.visible = false
end if

if profilestring(gsinifile,"Software","ShowTTouchInSales","Y") = "N" then
	st_cas.visible = false
end if

if profilestring(gsinifile,"Software","SalesDefCredit","N") = "Y" then
	cbx_credit.checked = true
else
	if profilestring(gsinifile,"Software","BalRcvdToDiscount","N") = "N" then
	end if
end if

this.siallowinsufstock = profilestring(gsinifile,"Software","AllowInsufficientStockSales","N")

select count ( code ) 
into :icnt
from userd
where menuitem ='NOITEMWGT' and
code = :gsuserid;

if icnt > 0 then
	st_stock.visible = false
end if

icnt = 0

select count ( code ) 
into :icnt
from userd
where menuitem ='SHOWPARTYBAL' and
code = :gsuserid;

if icnt = 0 and &
		not isnull(gsuserid) and &
		gsuserid <> "" then
	em_ob.visible = false
	em_netbalance.visible = false
	st_ob.visible = false
	st_netbalance.visible = false
end if

icnt = 0

select count ( code ) 
into :icnt
from userd
where code = :scode and
menuitem ='SHOWAVGPCOSTANDVAINSALES';

if icnt = 0 then
	dw_sale.object.avgvaperc.visible = false
	dw_sale.object.avgvaperc2.visible = false
	dw_sale.object.avgpcostperc.visible = false
end if

icnt = 0

select count ( code ) 
into :icnt
from userd
where code = :gsuserid and
menuitem ='ALLOWBCDETEDITINSALES';

if icnt > 0 then
	this.sialloweditbcdet = "Y"
end if

if profilestring(gsinifile,"Software","StopOnModel","Y") = "Y" then
	this.sistoponmodel = "Y"
else
	this.sistoponmodel = "N"
end if

this.sibulrate = profilestring(gsinifile,"Software","SRateBasedOnBullionRate","N")
this.siratebeftax = profilestring(gsinifile,"Software","SRateBeforeTax","N")

select cvalue 
into :dbcomn
from generald
where code ='BANKCOMN';

em_bcperc.text = string(dbcomn)

if profilestring(gsinifile,"Software","NW","N") = "Y" then
	if this.sibulrate = "Y" then
		scode = "BULRATE"
	else
		scode = "GRATE"
	end if

	select cvalue 
	into :gdgrate
	from generald
	where code = :scode;

	scode = "BULTOUCH"

	select cvalue 
	into :this.dibultouch
	from generald
	where code = :scode;

	if isnull(this.dibultouch) or &
			this.dibultouch = 0 then
		this.dibultouch = 99.5
	end if

	scode = "SRATE"

	select cvalue 
	into :gdsrate
	from generald
	where code = :scode;

	scode = "OSRATE"

	select cvalue 
	into :gdosrate
	from generald
	where code = :scode;

	scode = "OGRATE"

	select cvalue 
	into :gdograte
	from generald
	where code = :scode;

	scode = "THRATE"

	select cvalue 
	into :this.dithrate
	from generald
	where code = :scode;

	gdthrate = this.dithrate
else
	if this.sibulrate = "Y" then
		scode = "BULRATE"
	else
		scode = "GRATE"
	end if

	gdgrate = dec(profilestring(gsinifile,"Rates",scode,"0"))
	this.dibultouch = dec(profilestring(gsinifile,"Software","BulTouch","99.5"))
	scode = "THRATE"
	this.dithrate = dec(profilestring(gsinifile,"Rates",scode,"0"))
	gdthrate = this.dithrate
end if

st_bultouch.text = string(this.dibultouch)

if giaccount = 1 then
	this.sidefstktype = profilestring(gsinifile,"Software","SalesDefStkType","")
else
	this.sidefstktype = profilestring(gsinifile,"Software","SalesDefStkType2","")
end if

if profilestring(gsinifile,"Software","DefSType","") <> "" then
	dw_billtype.setitem(1,1,profilestring(gsinifile,"Software","DefBillType",""))
end if

this.sigrandamttorcvdamt = profilestring(gsinifile,"Software","GrandAmtToRcvdAmt","N")
this.didiscperc = dec(profilestring(gsinifile,"Software","SDiscPerc","0"))
this.sitaxafterdisc = profilestring(gsinifile,"Software","TaxAfterDisc","Y")
this.sistoponmcp = profilestring(gsinifile,"Software","StopOnMcPerc","N")

if profilestring(gsinifile,"Software","AllowSalesBillManual","Y") = "N" then
	cbx_manual.checked = false
	cbx_manual.enabled = false
end if

if profilestring(gsinifile,"Software","ShowRVA","N") = "N" then
	st_rva.visible = false
	em_rva.visible = false
end if

if profilestring(gsinifile,"Software","WSM","N") = "Y" then
	dw_sale.dataobject = "d_sale_ws"
	this.siws = "Y"
else
	this.siws = "N"
end if

if profilestring(gsinifile,"Software","PrinterType","DotMatrix") = "Laser" then
	cbx_laserprint.checked = true
end if

select maxadjwgtbc , maxdiscperc 
into :this.dibcadjustablewgt, :this.dimaxdiscperc
from userm
where code = :gsuserid;

if isnull(this.dibcadjustablewgt) then
	this.dibcadjustablewgt = 0
end if

if isnull(this.dimaxdiscperc) then
	this.dimaxdiscperc = 0
end if

this.sibccompulsory = profilestring(gsinifile,"Software","BCCompulsory","N")

if this.sibccompulsory = "Y" then
	select menuitem 
	into :scode
	from userd
	where code = :gsuserid and
	menuitem ='BCCOMPULSORY';

	if sqlca.sqlcode = 0 then
		this.siuserbccompulsory = "Y"
		dw_sale.object.weight.edit.displayonly = "Yes"
		dw_sale.object.qty.edit.displayonly = "Yes"
		dw_sale.object.stonewgt.edit.displayonly = "Yes"
		dw_sale.object.stoneprice.edit.displayonly = "Yes"
		dw_sale.object.wastage.edit.displayonly = "Yes"
		dw_sale.object.mcharge.edit.displayonly = "Yes"
		dw_sale.object.amount.edit.displayonly = "Yes"
		dw_sale.object.rate.edit.displayonly = "Yes"
		dw_sale.object.vaperc.edit.displayonly = "Yes"
	else
		this.siuserbccompulsory = "N"
	end if
end if

if giaccount = 1 then
	if gseb = "E" then
		cb_save.text = "&Print"
	end if

	if profilestring(gsinifile,"Software","QtnV","N") = "N" or &
			gseb = "E" then
		cb_qtnprint.enabled = false
		cb_qtnprint.visible = false
	end if


else

end if


this.saded = gsaded
this.seb = gseb
this.iieditable = profileint(gsinifile,"Software","Editable",1)
this.diwstgminimum = dec(profilestring(gsinifile,"Sales","WstgMinimum","0"))
this.dimcminimum = dec(profilestring(gsinifile,"Sales","McMinimum","0"))
this.diwstgroundup = dec(profilestring(gsinifile,"Sales","WstgRoundUp","0"))
this.diwstgrounddown = dec(profilestring(gsinifile,"Sales","WstgRoundDown","0"))
this.sivamodel = profilestring(gsinifile,"Software","UseVa","N")
this.siautorearangemcstamt = profilestring(gsinifile,"Software","AutoReArangeMcStAmt","N")
this.dimaxmcperc = dec(profilestring(gsinifile,"Software","MaMCInAutoRearange","0"))

if profilestring(gsinifile,"Software","ShowTaxInEstimate","N") = "Y" or &
		this.seb = "B" then
	this.ditaxperc = gdstax
end if

em_taxperc.text = string(this.ditaxperc)
dw_sale.object.amount.tabsequence = 0
dw_1.settransobject(sqlca)
dw_1.insertrow(0)
dw_smcode.settransobject(sqlca)
dw_smcode.insertrow(0)
dw_cashbank.settransobject(sqlca)
dw_cashbank.insertrow(0)
dw_cashbank.setitem(1,1,"CASH")
dw_chqbank.settransobject(sqlca)
dw_chqbank.insertrow(0)
dw_agent.settransobject(sqlca)
dw_agent.insertrow(0)
dw_approvedby.settransobject(sqlca)
dw_approvedby.insertrow(0)
dw_state.settransobject(sqlca)
dw_state.insertrow(0)
dw_state.setitem(1,1,profilestring(gsinifile,"Company","DefStateCode","32"))

if profilestring(gsinifile,"Software","AlwaysShowSMList","N") = "Y" then
	dw_smcode.object.code.dddw.showlist = "Yes"
end if

dw_co.settransobject(sqlca)
dw_co.insertrow(0)
dw_billtype.settransobject(sqlca)
dw_billtype.insertrow(0)

if profilestring(gsinifile,"Software","DefBillType","") <> "" then
	dw_billtype.setitem(1,1,profilestring(gsinifile,"Software","DefBillType",""))
	dw_billtype.triggerevent(itemchanged!)
end if

if this.seb = "B" then
	em_ptaxperc.text = string(gdptax)
end if

dw_counter.settransobject(sqlca)
dw_counter.insertrow(0)
dw_counter.setitem(1,1,profilestring(gsinifile,"Software","DefCounter",""))
dw_print.settransobject(sqlca)

select menuitem 
into :scode
from userd
where code = :gsuserid and
menuitem ='ITEMADJUSTMENTINSALES';

if sqlca.sqlcode = 0 then
	this.siitemadjinsales = "Y"
else
	this.siitemadjinsales = "N"
end if

select menuitem 
into :scode
from userd
where code = :gsuserid and
menuitem ='ALLOWPREVNEXTBUTTONSINSALES';

if sqlca.sqlcode = 0 then
	cb_prev.visible = true
	cb_next.visible = true
else
	cb_prev.visible = false
	cb_next.visible = false
end if

if profilestring(gsinifile,"Software","CCareSupport","N") = "Y" then
	cbx_sendsms.visible = true
	cbx_sendsms.enabled = true
end if

if profilestring(gsinifile,"Software","ShowAdvanceInSalesEstimate","N") = "N" then
	st_advance.visible = false
	em_advance.visible = false
	em_advance.enabled = false
end if

if profilestring(gsinifile,"Software","SalesEntryEditNo","N") = "N" then
	st_bn.visible = false
	sle_bn.visible = false
end if

st_pan.text = profilestring(gsinifile,"Software","PanLabel","PAN/Adh")
st_state.text = profilestring(gsinifile,"Software","StateLabel","State")
st_taxno.text = profilestring(gsinifile,"Software","TaxNoLabel","GST No")
em_astperc.text = string(gdastperc)
gscs = "C"

if giinfo <> 1496 then
	messagebox("Sorry",schk,stopsign!)
	close(this)

	return
end if

if this.saded = "E" then
	setpointer(hourglass!)
	this.title = "Edit Sales"
	lslno = ::message.doubleparm

	SELECT sr 
	INTO :ssr
	FROM salesm
	WHERE slno = :lslno;

	if profilestring(gsinifile,"Software","EditShortPrintOnly","N") = "Y" and &
			ssr <> "T" and &
			giaccount = 2 then
		messagebox("Access Denied..","You are not permited to edit this document...")
		close(this)

		return
	end if

	if sqlca.sqlcode <> 0 then
		messagebox("Err",sqlca.sqlerrtext)
	end if

	this.filldetails(lslno)
else
	if gsids = "Nj" then
		if not checkdate() then
			close(this)

			return
		end if
	end if

	icount += 1

	if this.saded = "A" then
		if this.seb = "E" then
			this.title = "Enter Sales Estimate Details " + " - " + string(icount,"##")
		else
			this.title = "Enter Sales Bill Details " + " - " + string(icount,"##")
		end if
	end if

	setpointer(hourglass!)
	dw_sale.settransobject(sqlca)
	dw_sale.insertrow(0)
	dw_sale.setitem(1,"stktype",gsdefstktype)
	st_stktype.text = gsdefstktype

	if profilestring(gsinifile,"Software","AlwaysFr","N") = "Y" then
		cbx_updtfr.checked = true
	end if

	if profilestring(gsinifile,"Software","SalesFirstQtnNo","N") = "Y" then
		scode = "QTNNO"
	else
		if profilestring(gsinifile,"Software","ShortPrintOnly","N") = "Y" then
			scode = "TSALES" + this.seb
		else
			scode = "SALES" + this.seb
		end if
	end if

	SELECT cvalue 
	INTO :lbillno
	FROM generali
	WHERE trim ( code ) = :scode;

	if sqlca.sqlcode <> 0 then
		insert into generali ( code , cvalue )
		values (  :scode , 0 );

		commit;

		lbillno = 0
	end if

	if profilestring(gsinifile,"Software","SalesFirstQtnNo","N") = "Y" then
		icnt = 0
		dtdate = today()

		select count ( slno ) 
		into :icnt
		from salesm
		where tdate = :dtdate;

		if icnt = 0 then
			update generali
			set cvalue =0
			where code = :scode;

			commit;

			lbillno = 0
		end if

		st_billno.text = "Q/" + string(today(),"mmdd") + "/" + string(lbillno + 1,"000")
	else
		if profilestring(gsinifile,"Software","ShortPrintOnly","N") = "Y" and &
				this.seb = "E" then
			if this.seb = "B" then
				st_billno.text = "TSB/" + string(lbillno + 1,"00000")
			else
				st_billno.text = "TSE/" + string(lbillno + 1,"00000")
			end if
		else
			if this.seb = "B" then
				if profilestring(gsinifile,"Software","BillTypewiseBillNo","N") = "Y" then
					scode = dw_billtype.gettext()

					select taxperc , prefix 
					into :dtaxperc, :spref
					from salestype
					where code = :scode;

					scode = "SALES" + spref

					select cvalue 
					into :lbillno
					from generali
					where code = :scode;

					if sqlca.sqlcode <> 0 then
						insert into generali ( code , cvalue )
						values (  :scode , 0 );

						lbillno = 0
					end if

					sbillno = spref + string(lbillno + 1,"00000")
					st_billno.text = sbillno
				else
					select cvalue 
					into :spref
					from generals
					where code ='SBPREF';

					if isnull(spref) then
						spref = "SLB/"
					end if

					select cvalue 
					into :slen
					from generals
					where code ='SBLEN';

					if isnull(slen) then
						slen = "5"
					end if

					st_billno.text = spref + string(lbillno + 1,fill("0",integer(slen)))
				end if
			else
				select cvalue 
				into :spref
				from generals
				where code ='SEPREF';

				if isnull(spref) then
					spref = "SLE/"
				end if

				select cvalue 
				into :slen
				from generals
				where code ='SELEN';

				if isnull(slen) then
					slen = "5"
				end if

				st_billno.text = spref + string(lbillno + 1,fill("0",integer(slen)))
			end if
		end if
	end if

	em_rate.text = string(gdgrate)
	em_rate8gm.text = string(round(gdgrate * 8,2))
	st_time.text = string(now(),"HH:MM AM/PM")
	em_date.text = string(today(),"dd/mm/yyyy")
	gbok = true

	if gsids = "Nj" then
		em_date.displayonly = true
	end if
end if

if gicolor = 0 then
	dw_sale.object.datawindow.detail.color = "12632256"
end if

if this.saded = "E" then
	if this.iieditable <> 1 then
		cb_save.enabled = false
	end if
end if

if gilevel = 1 and &
		this.seb = "E" then
	if profilestring(gsinifile,"Software","ShowEstNumbers","N") = "N" then
		st_bill.visible = false
		st_billno.visible = false
	end if
end if

if profilestring(gsinifile,"Software","SalesScr","E") = "M" then
	this.scrtomalayalam()
end if

if profilestring(gsinifile,"Software","FocusOnPartyCode","N") = "Y" then
	dw_1.setfocus()
else
	dw_smcode.setfocus()
end if

rollback;

this.evacalc()

return
end event

event key;string sobject
long lrow
long lcol
graphicobject which_control
int idays

if key = keyf9! then
	if (this.saded = "E" and &
			this.iieditable = 1) or &
			this.saded = "A" then
		if cb_save.enabled then
			cb_save.triggerevent(clicked!)
		end if
	end if
else
	if key = keyescape! then
		cb_exit.postevent(clicked!)
	else
		if key = keyf5! then
			cb_exchange.triggerevent(clicked!)
		else
			if key = keyf6! then
				cb_sreturn.triggerevent(clicked!)
			else
				if key = keyenter! then
					which_control = getfocus()
					sobject = which_control.classname()

					if sobject = "st_billno" then
						dw_counter.setfocus()
					else
						if sobject = "em_discperc" then
							em_discount.setfocus()
						else
							if sobject = "em_discount" then
								em_rcvd.setfocus()
							else
								if sobject = "st_custname" then
									sle_addr.setfocus()
								else
									if sobject = "sle_addr" then
										sle_tin.setfocus()
									else
										if sobject = "sle_tin" then
											sle_pan.setfocus()
										else
											if sobject = "sle_pan" then
												dw_smcode.setfocus()
											else
												if sobject = "sle_mobno" then
													dw_sale.setfocus()
												else
													if sobject = "em_tcsperc" then
														cb_save.setfocus()
													else
														if sobject = "sle_pos" then
															cb_save.setfocus()
														else
															if sobject = "em_advance" then
																dw_sale.setfocus()
															else
																if sobject = "em_taxperc" then
																	em_staxamt.setfocus()
																else
																	if sobject = "em_staxamt" then
																		em_ast.setfocus()
																	else
																		if sobject = "em_ast" then
																			em_hmc.setfocus()
																		else
																			if sobject = "em_rcamt" then
																				em_hmc.setfocus()
																			else
																				if sobject = "em_hmc" then
																					em_discount.setfocus()
																				else
																					if sobject = "sle_note" then
																						cb_save.setfocus()
																					else
																						if sobject = "em_chqamt" then
																							em_chqdate.setfocus()
																						else
																							if sobject = "em_chqdate" then
																								sle_chqno.setfocus()
																							else
																								if sobject = "sle_chqno" then
																									dw_agent.setfocus()
																								else
																									if sobject = "em_rcvd" then
																										if dec(em_nettot.text) - dec(em_discount.text) - dec(em_rcvd.text) <> 0 then
																											em_duedate.setfocus()
																										else
																											cb_save.setfocus()
																										end if
																									else
																										if sobject = "em_duedate" then
																											cb_save.setfocus()
																										else
																											if sobject = "cb_save" then
																												if profilestring(gsinifile,"Software","EnterSave","Y") = "Y" then
																													cb_save.triggerevent(clicked!)
																												end if
																											end if
																										end if
																									end if
																								end if
																							end if
																						end if
																					end if
																				end if
																			end if
																		end if
																	end if
																end if
															end if
														end if
													end if
												end if
											end if
										end if
									end if
								end if
							end if
						end if
					end if
				else
					if key = keyf1! then
						which_control = getfocus()
						sobject = which_control.classname()

						if sobject = "em_duedate" then
							idays = integer(profilestring(gsinifile,"Software","DueDateDays","0"))

							if idays > 0 then
								em_duedate.text = string(relativedate(today(),idays))
							else
								em_duedate.text = string(today())
							end if
						end if
					end if
				end if
			end if
		end if
	end if
end if

return
end event

type st_48 from statictext within w_sales
integer x = 2322
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_47 from statictext within w_sales
integer x = 2057
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type em_dperc from editmask within w_sales
integer x = 805
integer y = 1520
integer width = 183
integer height = 84
integer taborder = 220
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "####0.00"
end type

type st_46 from statictext within w_sales
integer x = 3401
integer y = 2068
integer width = 293
integer height = 76
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Distance"
boolean focusrectangle = false
end type

type em_distance from editmask within w_sales
integer x = 3694
integer y = 2060
integer width = 453
integer height = 84
integer taborder = 440
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = center!
string mask = "#######"
end type

type sle_vehno from singlelineedit within w_sales
integer x = 2235
integer y = 2056
integer width = 663
integer height = 88
integer taborder = 430
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
textcase textcase = upper!
integer limit = 15
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_32 from statictext within w_sales
integer x = 1934
integer y = 2072
integer width = 297
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Veh. No."
boolean focusrectangle = false
end type

type st_bultouch from statictext within w_sales
integer x = 681
integer y = 100
integer width = 146
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean focusrectangle = false
end type

type em_tcsamt from editmask within w_sales
integer x = 1477
integer y = 1696
integer width = 247
integer height = 84
integer taborder = 310
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#####.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type em_tcsperc from editmask within w_sales
integer x = 1330
integer y = 1696
integer width = 146
integer height = 84
integer taborder = 300
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "##0.00#"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_17 from statictext within w_sales
integer x = 1024
integer y = 1708
integer width = 283
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "TCS"
boolean focusrectangle = false
end type

type st_45 from statictext within w_sales
integer x = 2514
integer y = 1268
integer width = 165
integer height = 60
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
string text = "EVA :"
boolean focusrectangle = false
end type

type st_42 from statictext within w_sales
integer x = 1243
integer y = 376
integer width = 5
integer height = 888
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean border = true
boolean focusrectangle = false
end type

type em_astperc from editmask within w_sales
integer x = 1330
integer y = 1432
integer width = 119
integer height = 84
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "##0.##"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;dec dastperc
dec dast
dec dbamt
dec ddisc
dec dtax

dbamt = dec(parent.em_billtotal.text)
ddisc = dec(parent.em_discount.text)
dtax = dec(parent.em_staxamt.text)
dastperc = dec(parent.em_astperc.text)

if profilestring(gsinifile,"Software","CessIsBasedOnBillAmt","Y") = "Y" then
	if parent.sitaxafterdisc = "Y" then
		dast = ((dbamt - ddisc) * dastperc) / 100
	else
		dast = (dbamt * dastperc) / 100
	end if
else
	dast = (dtax * dastperc) / 100
end if

if dec(parent.em_staxamt.text) = 0 then
	dast = 0
end if

dast = round(dast,2)
parent.em_ast.text = string(dast)
parent.balcalc(1)
end event

type sle_tin from singlelineedit within w_sales
integer x = 2021
integer y = 188
integer width = 663
integer height = 88
integer taborder = 60
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
textcase textcase = upper!
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_taxno from statictext within w_sales
integer x = 1806
integer y = 200
integer width = 233
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Tax  No"
boolean focusrectangle = false
end type

type st_schemebal from statictext within w_sales
integer x = 2235
integer y = 2152
integer width = 453
integer height = 84
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_44 from statictext within w_sales
integer x = 1934
integer y = 2164
integer width = 297
integer height = 76
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Scheme Bal"
boolean focusrectangle = false
end type

type cbx_ccpdc from checkbox within w_sales
integer x = 1349
integer y = 2052
integer width = 352
integer height = 76
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "CCard PDC ?"
end type

event clicked;
parent.balcalc(1)
end event

type st_41 from statictext within w_sales
integer y = 2060
integer width = 334
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Approved by"
boolean focusrectangle = false
end type

type dw_approvedby from datawindow within w_sales
event u_key pbm_dwnkey
integer x = 343
integer y = 2052
integer width = 882
integer height = 88
integer taborder = 460
string dataobject = "d_staff_approval_sel"
boolean border = false
boolean livescroll = true
end type

event u_key;
if key = keyenter! then
	parent.cb_save.setfocus()
end if
end event

event itemchanged;
parent.balcalc(1)
end event

type em_bcperc from editmask within w_sales
integer x = 2738
integer y = 1788
integer width = 146
integer height = 84
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#####.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_43 from statictext within w_sales
integer x = 2688
integer y = 1340
integer width = 247
integer height = 124
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "Redeem Points"
alignment alignment = right!
boolean focusrectangle = false
end type

type em_redmpoints from editmask within w_sales
integer x = 2962
integer y = 1348
integer width = 165
integer height = 84
integer taborder = 200
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = right!
string mask = "#######"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_state from statictext within w_sales
integer x = 3401
integer y = 1980
integer width = 293
integer height = 76
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "State"
boolean focusrectangle = false
end type

type dw_state from datawindow within w_sales
event u_key pbm_dwnkey
integer x = 3694
integer y = 1964
integer width = 567
integer height = 88
integer taborder = 420
string dataobject = "d_state_sel"
boolean border = false
boolean livescroll = true
end type

event u_key;
if key = keyenter! then
	parent.cb_save.setfocus()
end if
end event

type sle_pan from singlelineedit within w_sales
integer x = 2021
integer y = 280
integer width = 663
integer height = 88
integer taborder = 70
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
textcase textcase = upper!
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_pan from statictext within w_sales
integer x = 1806
integer y = 288
integer width = 233
integer height = 80
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "ID No"
boolean focusrectangle = false
end type

type sle_pos from singlelineedit within w_sales
integer x = 3694
integer y = 1876
integer width = 567
integer height = 88
integer taborder = 410
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
integer limit = 60
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_40 from statictext within w_sales
integer x = 3401
integer y = 1896
integer width = 293
integer height = 76
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Supply Place :"
boolean focusrectangle = false
end type

type st_netbalance from statictext within w_sales
integer x = 2633
integer y = 1616
integer width = 96
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "CB :"
alignment alignment = right!
boolean focusrectangle = false
end type

type em_netamt from editmask within w_sales
integer x = 2235
integer y = 1608
integer width = 393
integer height = 84
integer taborder = 210
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "########.00"
string displaydata = ""
end type

event getfocus;//Omitted: the default "return"
end event

event losefocus;
parent.balcalc(0)
end event

type st_39 from statictext within w_sales
integer x = 3319
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_38 from statictext within w_sales
integer x = 3401
integer y = 1796
integer width = 265
integer height = 84
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "PC Amt"
boolean focusrectangle = false
end type

type st_pcardamt from statictext within w_sales
integer x = 3694
integer y = 1788
integer width = 453
integer height = 84
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_pcardpoints from statictext within w_sales
integer x = 3694
integer y = 1696
integer width = 453
integer height = 88
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = center!
boolean border = true
boolean focusrectangle = false
end type

type st_37 from statictext within w_sales
integer x = 3401
integer y = 1696
integer width = 265
integer height = 84
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "PC Points"
boolean focusrectangle = false
end type

type st_36 from statictext within w_sales
integer x = 1934
integer y = 1980
integer width = 297
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Chq. No"
boolean focusrectangle = false
end type

type sle_chqno from singlelineedit within w_sales
integer x = 2235
integer y = 1964
integer width = 663
integer height = 88
integer taborder = 400
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
textcase textcase = upper!
integer limit = 20
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type dw_chqbank from datawindow within w_sales
event u_key pbm_dwnkey
integer x = 343
integer y = 1876
integer width = 882
integer height = 88
integer taborder = 370
string dataobject = "d_cashbankcode"
boolean border = false
boolean livescroll = true
end type

event u_key;
if key = keyenter! then
	parent.em_chqamt.setfocus()
end if
end event

event itemchanged;
parent.balcalc(1)
end event

type st_35 from statictext within w_sales
integer y = 1972
integer width = 315
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Agent"
boolean focusrectangle = false
end type

type cbx_pdc from checkbox within w_sales
integer x = 2926
integer y = 1972
integer width = 178
integer height = 76
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "PDC"
end type

event clicked;
parent.balcalc(1)
end event

type em_chqdate from editmask within w_sales
integer x = 2738
integer y = 1876
integer width = 389
integer height = 84
integer taborder = 390
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yy"
string displaydata = ""
boolean dropdowncalendar = true
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
if date(parent.em_chqdate.text) > date(parent.em_date.text) then
	parent.cbx_pdc.checked = true
else
	parent.cbx_pdc.checked = false
end if
end event

type em_chqamt from editmask within w_sales
integer x = 2235
integer y = 1876
integer width = 393
integer height = 84
integer taborder = 380
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#########.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_34 from statictext within w_sales
integer x = 1934
integer y = 1888
integer width = 306
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Chq.Amt/ Dt"
boolean focusrectangle = false
end type

type em_schmamt from editmask within w_sales
integer x = 1330
integer y = 1608
integer width = 393
integer height = 84
integer taborder = 250
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "########.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_33 from statictext within w_sales
integer x = 1024
integer y = 1620
integer width = 306
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Schm Less"
boolean focusrectangle = false
end type

type em_fancyamt from editmask within w_sales
integer x = 1330
integer y = 1520
integer width = 393
integer height = 84
integer taborder = 190
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#####.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_fancyamt from statictext within w_sales
integer x = 1024
integer y = 1532
integer width = 283
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Fancy Amt"
boolean focusrectangle = false
end type

type cb_next from commandbutton within w_sales
integer x = 1906
integer width = 101
integer height = 88
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = ">"
end type

event clicked;string sbillno
string ssr
long lslno
long lslno2
str_tran strstmp[]

sbillno = trim(parent.st_billno.text)

SELECT slno , sr 
INTO :lslno, :ssr
FROM salesm
WHERE billno = :sbillno and
control <=  :gisemi;

if sqlca.sqlcode <> 0 then
else
	select min ( slno ) 
	into :lslno2
	from salesm
	WHERE slno >  :lslno and
	control <=  :gisemi and
	orderno is null;
end if

if isnull(lslno2) then
	lslno2 = 0
end if

if lslno = lslno2 or &
		lslno2 = 0 then
	parent.saded = "A"
	parent.title = "Enter the Sales Details"
	parent.initsalemodule()
	parent.cb_save.enabled = true
	lslno2 = 0
end if

if lslno2 > 0 then
	parent.strexchange[] = strstmp[]
	parent.strsreturn[] = strstmp[]
	parent.strisales[] = strstmp[]
	parent.saded = "E"
	parent.filldetails(lslno2)
end if
end event

type cb_prev from commandbutton within w_sales
integer x = 1810
integer width = 101
integer height = 88
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "<"
end type

event clicked;string sbillno
string ssr
long lslno
str_tran strstmp[]

sbillno = trim(parent.st_billno.text)

SELECT slno , sr 
INTO :lslno, :ssr
FROM salesm
WHERE billno = :sbillno and
control <=  :gisemi;

if sqlca.sqlcode <> 0 then
	select max ( slno ) 
	into :lslno
	from salesm
	WHERE control <=  :gisemi and
	orderno is null;
else
	select max ( slno ) 
	into :lslno
	from salesm
	WHERE slno <  :lslno and
	control <=  :gisemi and
	orderno is null;
end if

if lslno > 0 then
	parent.strexchange[] = strstmp[]
	parent.strsreturn[] = strstmp[]
	parent.strisales[] = strstmp[]
	parent.saded = "E"
	parent.filldetails(lslno)
end if
end event

type dw_agent from datawindow within w_sales
event u_key pbm_dwnkey
integer x = 343
integer y = 1964
integer width = 882
integer height = 88
integer taborder = 450
string dataobject = "d_agent_sel"
boolean border = false
boolean livescroll = true
end type

event u_key;
if key = keyenter! then
	parent.dw_approvedby.setfocus()
end if
end event

event itemchanged;
parent.balcalc(1)
end event

type st_31 from statictext within w_sales
integer y = 1884
integer width = 315
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Chq Bank"
boolean focusrectangle = false
end type

type st_bn from statictext within w_sales
integer x = 1097
integer y = 8
integer width = 238
integer height = 64
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "Edit BNo"
boolean focusrectangle = false
end type

type sle_bn from singlelineedit within w_sales
integer x = 1358
integer width = 654
integer height = 88
integer taborder = 110
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
textcase textcase = upper!
integer limit = 10
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;string sbillno
string ssr
long lslno

sbillno = trim(parent.sle_bn.text)

SELECT slno , sr 
INTO :lslno, :ssr
FROM salesm
WHERE billno = :sbillno and
control <=  :gisemi;

if profilestring(gsinifile,"Software","EditShortPrintOnly","N") = "Y" and &
		ssr <> "T" and &
		giaccount = 2 then
	messagebox("Access Denied..","You are not permited to edit this document...")

	return
end if

if sqlca.sqlcode <> 0 then
	if sbillno <> "" then
		messagebox("Invalid Bill..","This bill number does not exist....")
	end if

	parent.saded = "A"
	parent.title = "Enter the Sales Details"
	parent.initsalemodule()
else
	parent.saded = "E"
	parent.filldetails(lslno)
end if
end event

type st_30 from statictext within w_sales
integer x = 1723
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type sle_mobno from singlelineedit within w_sales
integer x = 3685
integer y = 280
integer width = 672
integer height = 88
integer taborder = 120
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
textcase textcase = upper!
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;string smob
string sname
string saddr
string scode
long lslno

if trim(parent.sle_mobno.text) <> "" then
	if profilestring(gsinifile,"Software","MobileNoBasedSearch","N") = "Y" then
		smob = trim(parent.sle_mobno.text)

		select code 
		into :scode
		from clients
		where mobile = :smob or
		telephone = :smob;

		if isnull(scode) then
			scode = ""
		end if

		if scode <> "" then
			select max ( slno ) 
			into :lslno
			from salesm
			where mobno = :smob;

			if lslno > 0 then
				select custcode , custname , addr 
				into :scode, :sname, :saddr
				from salesm
				where slno = :lslno;
			end if
		end if

		if isnull(scode) then
			scode = ""
		end if

		if isnull(sname) then
			sname = ""
		end if

		if scode <> "" then
			parent.dw_1.setitem(1,1,scode)
			parent.dw_1.triggerevent(itemchanged!)
		else
			if sname <> "" then
				parent.st_custname.text = sname
				parent.sle_addr.text = saddr
			end if
		end if
	end if
end if
end event

type st_29 from statictext within w_sales
integer x = 3410
integer y = 292
integer width = 274
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Mob No"
boolean focusrectangle = false
end type

type cbx_sendsms from checkbox within w_sales
boolean visible = false
integer x = 3703
integer y = 2160
integer width = 402
integer height = 68
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean enabled = false
string text = "Send Sms"
end type

type st_15 from statictext within w_sales
integer x = 4082
integer y = 376
integer width = 5
integer height = 880
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type cbx_printwanda from checkbox within w_sales
integer x = 4443
integer y = 1988
integer width = 581
integer height = 88
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Print Wgt and Amt Bal"
end type

type cbx_cst from checkbox within w_sales
integer x = 1349
integer y = 1792
integer width = 361
integer height = 84
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "Interstate"
end type

event clicked;
parent.dw_sale.postevent(losefocus!)
end event

type cbx_updtsys from checkbox within w_sales
integer x = 4375
integer width = 187
integer height = 76
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "Sys"
end type

type st_repair from statictext within w_sales
integer x = 1024
integer y = 1352
integer width = 283
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Repair"
boolean focusrectangle = false
end type

type em_rcamt from editmask within w_sales
integer x = 1330
integer y = 1344
integer width = 393
integer height = 84
integer taborder = 220
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#####.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type cb_rateall from commandbutton within w_sales
integer x = 4375
integer y = 296
integer width = 215
integer height = 76
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Rate All"
end type

event clicked;long lrow
long ltrow

ltrow = parent.dw_sale.rowcount()
lrow = 1

do while lrow <= ltrow
	parent.dw_sale.setrow(lrow)
	parent.dw_sale.setcolumn("itemcode")
	parent.dw_sale.triggerevent(itemchanged!)
	lrow ++
loop
end event

type cbx_ws from checkbox within w_sales
integer x = 4375
integer y = 200
integer width = 411
integer height = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "WS              "
end type

event rbuttondown;
if parent.cbx_ws.checked then
	setprofilestring(gsinifile,"Software","DefRate","WSR")
else
	setprofilestring(gsinifile,"Software","DefRate","RTR")
end if
end event

type cbx_showwgt from checkbox within w_sales
integer x = 4443
integer y = 2072
integer width = 553
integer height = 88
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Show Wgt in Ledger"
end type

type em_advance from editmask within w_sales
integer x = 2939
integer y = 280
integer width = 407
integer height = 88
integer taborder = 80
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = right!
string mask = "#########.00"
string displaydata = "x4"
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_advance from statictext within w_sales
integer x = 2697
integer y = 296
integer width = 233
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Prev.Adv"
boolean focusrectangle = false
end type

type cbx_laserprint from checkbox within w_sales
integer x = 4443
integer y = 1912
integer width = 402
integer height = 80
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Laser Print"
end type

type em_discperc from editmask within w_sales
integer x = 343
integer y = 1520
integer width = 123
integer height = 84
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "###.##"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;dec ddiscperc
dec ddisc

ddiscperc = dec(parent.em_discperc.text)

if profilestring(gsinifile,"Software","DiscBasedOnNetAmt","N") = "Y" then
	ddisc = (dec(parent.em_nettot.text) * ddiscperc) / 100
else
	ddisc = (dec(parent.em_billtotal.text) * ddiscperc) / 100
end if

parent.em_discount.text = string(ddisc,"######0")
parent.em_discount.triggerevent(modified!)
parent.em_dperc.text = string((dec(parent.em_discount.text) * 100) / dec(parent.em_billtotal.text))
end event

type em_hmc from editmask within w_sales
integer x = 2235
integer y = 1432
integer width = 393
integer height = 84
integer taborder = 170
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#####.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_28 from statictext within w_sales
integer x = 1934
integer y = 1444
integer width = 270
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "HMC"
boolean focusrectangle = false
end type

type st_cas from statictext within w_sales
integer x = 498
integer y = 1188
integer width = 503
integer height = 64
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type em_ccamt from editmask within w_sales
integer x = 2235
integer y = 1788
integer width = 393
integer height = 84
integer taborder = 340
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#########.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_27 from statictext within w_sales
integer x = 1934
integer y = 1800
integer width = 270
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "CCardAmt"
boolean focusrectangle = false
end type

type em_bcharge from editmask within w_sales
integer x = 2885
integer y = 1788
integer width = 242
integer height = 84
integer taborder = 360
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#####.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_26 from statictext within w_sales
integer x = 2633
integer y = 1792
integer width = 96
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "BC :"
alignment alignment = right!
boolean focusrectangle = false
end type

type cbx_addbc from checkbox within w_sales
integer x = 1349
integer y = 1968
integer width = 311
integer height = 72
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Add BC"
end type

event clicked;
parent.balcalc(1)
end event

type dw_print from datawindow within w_sales
boolean visible = false
integer x = 855
integer y = 1700
integer width = 87
integer height = 76
string title = "none"
string dataobject = "d_saleprint_thermal"
boolean livescroll = true
end type

type cbx_credit from checkbox within w_sales
integer x = 2738
integer y = 1516
integer width = 242
integer height = 76
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "&Credit"
end type

event clicked;
if parent.cbx_credit.checked and &
		parent.cbx_credit.visible then
	parent.em_rcvd.text = ""
end if

parent.balcalc(1)
end event

event rbuttondown;
if parent.cbx_credit.checked then
	setprofilestring(gsinifile,"Software","SalesDefCredit","Y")
else
	setprofilestring(gsinifile,"Software","SalesDefCredit","N")
end if
end event

type st_25 from statictext within w_sales
integer y = 1796
integer width = 315
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Cash/Bank"
boolean focusrectangle = false
end type

type dw_cashbank from datawindow within w_sales
event u_key pbm_dwnkey
integer x = 343
integer y = 1784
integer width = 882
integer height = 88
integer taborder = 330
string dataobject = "d_cashbankcode"
boolean border = false
boolean livescroll = true
end type

event u_key;
if key = keyenter! then
	parent.cb_save.setfocus()
end if
end event

event itemchanged;
parent.balcalc(1)
end event

type cbx_loan from checkbox within w_sales
integer x = 1349
integer y = 1880
integer width = 233
integer height = 80
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "Loan"
end type

type st_24 from statictext within w_sales
integer x = 1934
integer y = 1708
integer width = 270
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Note"
boolean focusrectangle = false
end type

type sle_note from singlelineedit within w_sales
integer x = 2235
integer y = 1696
integer width = 896
integer height = 88
integer taborder = 320
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
integer limit = 30
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_23 from statictext within w_sales
integer x = 5
integer y = 292
integer width = 256
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Address"
boolean focusrectangle = false
end type

type sle_addr from singlelineedit within w_sales
integer x = 265
integer y = 280
integer width = 1513
integer height = 88
integer taborder = 50
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
integer limit = 60
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_vap from statictext within w_sales
integer x = 2949
integer y = 1272
integer width = 165
integer height = 60
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
boolean focusrectangle = false
end type

type st_22 from statictext within w_sales
integer y = 1708
integer width = 315
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Purch.Tax"
boolean focusrectangle = false
end type

type em_ptaxamt from editmask within w_sales
integer x = 471
integer y = 1696
integer width = 325
integer height = 84
integer taborder = 290
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "########.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type em_ptaxperc from editmask within w_sales
integer x = 343
integer y = 1696
integer width = 123
integer height = 84
integer taborder = 280
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "###.##"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;dec dptaxperc
dec dptax
dec dexamt

dexamt = dec(parent.em_exchange.text)
dptaxperc = dec(parent.em_ptaxperc.text)
dptax = round((dexamt * dptaxperc) / 100,0)
parent.em_ptaxamt.text = string(dptax)
end event

type st_rva from statictext within w_sales
integer x = 2697
integer y = 12
integer width = 146
integer height = 64
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "RVA%"
boolean focusrectangle = false
end type

type em_rva from editmask within w_sales
integer x = 2939
integer width = 407
integer height = 88
integer textsize = -10
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
string text = "0"
alignment alignment = right!
string mask = "##.##"
end type

type st_time from statictext within w_sales
integer x = 4119
integer width = 261
integer height = 80
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
boolean focusrectangle = false
end type

type em_taxperc from editmask within w_sales
integer x = 343
integer y = 1432
integer width = 123
integer height = 84
integer taborder = 140
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "###.##"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.ditaxperc = dec(parent.em_taxperc.text)
parent.dw_sale.triggerevent(losefocus!)
parent.balcalc(1)
end event

type dw_billtype from datawindow within w_sales
event ukey pbm_dwnkey
integer x = 2258
integer width = 425
integer height = 88
integer taborder = 10
string dataobject = "d_billtypecode"
boolean border = false
boolean livescroll = true
end type

event ukey;
if key = keyenter! then
	parent.dw_1.setfocus()
end if
end event

event itemchanged;string scode
string spref
string scode2
string sbillno
dec dtaxperc
long lbillno

scode = this.gettext()

if profilestring(gsinifile,"Software","BillTypewiseBillNo","N") = "Y" and &
		parent.seb = "B" then
	select taxperc , prefix 
	into :dtaxperc, :spref
	from salestype
	where code = :scode;

	scode2 = "SALES" + spref

	select cvalue 
	into :lbillno
	from generali
	where code = :scode2;

	if sqlca.sqlcode <> 0 then
		insert into generali ( code , cvalue )
		values (  :scode2 , 0 );

		lbillno = 0
	end if

	sbillno = spref + string(lbillno + 1,"00000")
	parent.st_billno.text = sbillno
end if

if parent.seb = "B" or &
		profilestring(gsinifile,"Software","TaxBillTypeWise","N") = "Y" then
	select taxperc , prefix 
	into :dtaxperc, :spref
	from salestype
	where code = :scode;

	parent.ditaxperc = dtaxperc
	parent.em_taxperc.text = string(parent.ditaxperc)
end if

parent.dw_sale.postevent(losefocus!)
end event

event rbuttondown;string scode

scode = this.gettext()

if not isnull(scode) and &
		scode <> "" then
	setprofilestring(gsinifile,"Software","DefBillType",scode)
end if
end event

type st_21 from statictext within w_sales
integer x = 2043
integer y = 8
integer width = 219
integer height = 76
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Bill Type"
boolean focusrectangle = false
end type

type st_20 from statictext within w_sales
integer y = 1608
integer width = 315
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Grand Amt"
boolean focusrectangle = false
end type

type em_grandamt from editmask within w_sales
integer x = 343
integer y = 1608
integer width = 453
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "#########.00"
end type

type st_opwgt from statictext within w_sales
integer x = 2697
integer y = 108
integer width = 206
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Op.Wgt"
boolean focusrectangle = false
end type

type em_opwgt from editmask within w_sales
integer x = 2939
integer y = 96
integer width = 407
integer height = 88
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
string mask = "######.000"
string displaydata = "x4"
end type

type st_billno from singlelineedit within w_sales
integer x = 265
integer width = 663
integer height = 88
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean autohscroll = false
boolean displayonly = true
end type

event modified;string sbillno
long lslno

sbillno = trim(parent.st_billno.text)

select slno 
into :lslno
from salesm
where billno = :sbillno;

if sqlca.sqlcode = 0 then
	messagebox("Duplicate","This Bill Number already exist...")
	parent.st_billno.text = ""
else
	select count ( slno ) 
	into :lslno
	from salesm
	where billno = :sbillno;

	if lslno > 0 then
		messagebox("Duplicate","This Bill Number already exist...")
		parent.st_billno.text = ""
	end if
end if
end event

type cbx_manual from checkbox within w_sales
integer x = 965
integer y = 4
integer width = 87
integer height = 80
integer textsize = -8
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
end type

event clicked;string stype
string scode
string sbillno
string spref
string slen
long lbillno
long lbillno2

if parent.cbx_manual.checked then
	parent.st_billno.displayonly = false
	parent.st_billno.setfocus()
else
	parent.st_billno.displayonly = true

	if profilestring(gsinifile,"Software","ShortPrintOnly","N") = "Y" and &
			parent.seb = "E" then
		stype = "T"
	else
		stype = "S"
	end if

	if stype = "T" then
		scode = "TSALES" + parent.seb
	else
		scode = "SALES" + parent.seb
	end if

	SELECT cvalue 
	INTO :lbillno
	FROM generali
	WHERE trim ( code ) = :scode;

	if giaccount = 2 and &
			gifupdt = 1 and &
			parent.cbx_updtfr.checked and &
			parent.seb = "B" then
		SELECT cvalue 
		INTO :lbillno2
		FROM generali
		WHERE trim ( code ) = :scode 
		using transtmp;

		if lbillno < lbillno2 then
			lbillno = lbillno2
		end if
	end if

	if stype = "T" then
		if parent.seb = "B" then
			sbillno = "TSB/" + string(lbillno + 1,"00000")
		else
			sbillno = "TSE/" + string(lbillno + 1,"00000")
		end if
	else
		if parent.seb = "B" then
			select cvalue 
			into :spref
			from generals
			where code ='SBPREF';

			if isnull(spref) then
				spref = "SLB/"
			end if

			select cvalue 
			into :slen
			from generals
			where code ='SBLEN';

			if isnull(slen) then
				slen = "5"
			end if

			sbillno = spref + string(lbillno + 1,fill("0",integer(slen)))
		else
			select cvalue 
			into :spref
			from generals
			where code ='SEPREF';

			if isnull(spref) then
				spref = "SLE/"
			end if

			select cvalue 
			into :slen
			from generals
			where code ='SELEN';

			if isnull(slen) then
				slen = "5"
			end if

			sbillno = spref + string(lbillno + 1,fill("0",integer(slen)))
		end if
	end if

	parent.st_billno.text = sbillno
end if
end event

type cb_dthlp from commandbutton within w_sales
integer x = 4087
integer y = 1608
integer width = 59
integer height = 84
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "^"
end type

event clicked;
open(w_calander2)

if message.stringparm <> "" then
	parent.em_duedate.text = message.stringparm
end if

parent.em_duedate.setfocus()
end event

type st_19 from statictext within w_sales
integer x = 859
integer y = 100
integer width = 247
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Counter"
boolean focusrectangle = false
end type

type dw_counter from datawindow within w_sales
event ukey pbm_dwnkey
integer x = 1120
integer y = 92
integer width = 658
integer height = 88
integer taborder = 20
string dataobject = "d_countercode"
boolean border = false
boolean livescroll = true
end type

event ukey;
if key = keyenter! then
	parent.dw_1.setfocus()
end if
end event

type st_18 from statictext within w_sales
integer x = 1024
integer y = 1444
integer width = 283
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Cess"
boolean focusrectangle = false
end type

type em_ast from editmask within w_sales
integer x = 1449
integer y = 1432
integer width = 274
integer height = 84
integer taborder = 160
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "#####.00"
string displaydata = ""
end type

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

event modified;
parent.balcalc(1)
end event

type st_netamt from statictext within w_sales
integer x = 1934
integer y = 1620
integer width = 270
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Net Amt"
boolean focusrectangle = false
end type

type em_netbalance from editmask within w_sales
integer x = 2738
integer y = 1608
integer width = 389
integer height = 84
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "#########.00"
end type

type st_stktype from statictext within w_sales
integer x = 567
integer y = 1184
integer width = 215
integer height = 64
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 65535
long backcolor = 553648127
boolean enabled = false
boolean focusrectangle = false
end type

type cb_cohelp from commandbutton within w_sales
string tag = "Press This Button for Help or F12 for New Customer"
integer x = 2418
integer y = 100
integer width = 78
integer height = 84
integer textsize = -8
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "^"
end type

event clicked;string scode

if profilestring(gsinifile,"Software","CoPartySeperate","N") = "Y" then
	gscs = "A"
	openwithparm(w_clientshelp,"COONLY")
else
	gscs = "A"
	openwithparm(w_cbachdhelp,parent.dw_co.gettext())
end if

scode = message.stringparm

if scode <> "" then
	parent.dw_co.settext(scode)
	parent.dw_co.triggerevent(itemchanged!)
end if

parent.dw_co.setfocus()
end event

type cb_custhelp from commandbutton within w_sales
string tag = "Press This Button for Help or F12 for New Customer"
integer x = 667
integer y = 188
integer width = 64
integer height = 88
integer textsize = -8
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "^"
end type

event clicked;string scode

gscs = "C"

if profilestring(gsinifile,"Software","ShowAllClientsInSale","N") = "Y" then
	gsgenparm = "All"
end if

openwithparm(w_clientshelp,parent.dw_1.gettext())
gsgenparm = ""
scode = message.stringparm

if scode <> "" then
	parent.dw_1.settext(scode)
	parent.dw_1.triggerevent(itemchanged!)
end if

parent.dw_1.setfocus()
end event

type cbx_updtfr from checkbox within w_sales
integer x = 4128
integer y = 92
integer width = 357
integer height = 76
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
string text = "co part"
end type

type cb_qtnprint from commandbutton within w_sales
integer x = 4434
integer y = 1804
integer width = 485
integer height = 84
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "&Qtn Print"
end type

event clicked;long ljob
long lterows
long lpos
long lrow
long ltrow
long lbillno
long lbcode
dec damt
date dtdate
date dtduedate
string sdocno
string ssmcode
string scustcode
string scode
string sname
string sregional
string sjcode
time dttime
int iret
int iprnlang
int ibillform
int iprintok
int icontrol
int iform2form
int iqty
string scondense
string srateprint
string sbheadenglish
string sfooterinmalayalam
string sbold
string sdeprhead
string sesthead
string scustname
string snetamt
string sprintzero
string sprinttotalwgt
string sprintnetwgt
string swstginnetwgt
string sprintwastage
string sheadenglish
dec dgrate
dec dsrate
dec dexamt
dec dsretamt
dec dtaxamt
dec dtaxperc
dec ddisc
dec dround
dec dtamt
dec dbalance
dec drcvd
dec dbamt
dec dob
dec dtotogwgt
dec dtotwstg
dec dtstwgt
dec dtnetwgt
dec dweight
dec drate
dec dstwgt
dec dtotal
dec dast
dec dwgt
dec dnetamt
dec dadv
dec dretamt
dec dnetwgt
dec dstprice
dec dmcharge
dec dwastage
dec dvaladd
dec damount
dec dtnwgtg
dec dtnwgts
dec dtvaladd
dec dva
dec dtmp
string sitemtype
string skdm
string stmp
string spurity
string sstcode
string sprintvap
int istone
int ijewl
int ifooterskip
int i
int irow
int ilines
str_tran strsales[]
string smod
string sdate

declare cur2 cursor for
 select sttype , pcs , carats , rate , amount from barcode_dmddet where bcode = :lbcode order by sno ;

sprintvap = profilestring(gsinifile,"Software","PrintVAPercInBill","N")
dbamt = dec(parent.em_billtotal.text)
dexamt = dec(parent.em_exchange.text)
dsretamt = dec(parent.em_sreturn.text)

if dbamt <= 0 and &
		dexamt <= 0 and &
		dsretamt <= 0 then
	messagebox("Incomplete entries","Nothing to print...")

	return
end if

sdocno = trim(parent.st_billno.text)

if giaccount = 1 then
	scode = "SALESE"

	SELECT cvalue 
	INTO :lbillno
	FROM generali
	WHERE trim ( code ) = :scode;

	update generali
	SET cvalue = :lbillno + 1
	WHERE trim ( code ) = :scode;

	commit;

	sdocno = "SLE/" + string(lbillno + 1,"00000") + "."
end if

lrow = 1
ltrow = parent.dw_sale.rowcount()

do while lrow <= ltrow
	scode = parent.dw_sale.getitemstring(lrow,"itemcode")

	if isnull(scode) or &
			trim(scode) = "" then
		parent.dw_sale.deleterow(lrow)
	else
		scode = trim(scode)
		ijewl = parent.dw_sale.getitemnumber(lrow,"jewl")
		strsales[lrow].itemcode = scode
		strsales[lrow].itemname = parent.dw_sale.getitemstring(lrow,"itemname")
		strsales[lrow].qty = parent.dw_sale.getitemnumber(lrow,"qty")
		strsales[lrow].rate = parent.dw_sale.getitemdecimal(lrow,"rate")
		strsales[lrow].weight = parent.dw_sale.getitemdecimal(lrow,"weight")
		strsales[lrow].wastage = parent.dw_sale.getitemdecimal(lrow,"wastage")
		strsales[lrow].mcharge = parent.dw_sale.getitemdecimal(lrow,"mcharge")
		strsales[lrow].stoneprice = parent.dw_sale.getitemdecimal(lrow,"stoneprice")
		strsales[lrow].stonewgt = parent.dw_sale.getitemdecimal(lrow,"stonewgt")
		strsales[lrow].amount = parent.dw_sale.getitemdecimal(lrow,"amount")
		strsales[lrow].itemtype = parent.dw_sale.getitemstring(lrow,"itemtype")
		strsales[lrow].jewlcode = parent.dw_sale.getitemstring(lrow,"jewlcode")
		strsales[lrow].kdm = parent.dw_sale.getitemstring(lrow,"kdm")
		strsales[lrow].cost = parent.dw_sale.getitemdecimal(lrow,"cost")
		strsales[lrow].adjitem = parent.dw_sale.getitemstring(lrow,"adjitem")
		strsales[lrow].adjwgt = parent.dw_sale.getitemdecimal(lrow,"adjwgt")
		strsales[lrow].adjqty = parent.dw_sale.getitemnumber(lrow,"adjqty")
		strsales[lrow].jrate = parent.dw_sale.getitemnumber(lrow,"jrate")
		strsales[lrow].jva = parent.dw_sale.getitemnumber(lrow,"jva")
		strsales[lrow].bcode = parent.dw_sale.getitemnumber(lrow,"bcode")

		if isnull(strsales[lrow].weight) then
			strsales[lrow].weight = 0
		end if

		if isnull(strsales[lrow].wastage) then
			strsales[lrow].wastage = 0
		end if

		if isnull(strsales[lrow].mcharge) then
			strsales[lrow].mcharge = 0
		end if

		if isnull(strsales[lrow].stoneprice) then
			strsales[lrow].stoneprice = 0
		end if

		if isnull(strsales[lrow].stonewgt) then
			strsales[lrow].stonewgt = 0
		end if

		if isnull(strsales[lrow].weight) then
			strsales[lrow].weight = 0
		end if

		if isnull(strsales[lrow].rate) then
			strsales[lrow].rate = 0
		end if

		if isnull(strsales[lrow].qty) then
			strsales[lrow].qty = 0
		end if

		if isnull(strsales[lrow].cost) then
			strsales[lrow].cost = 0
		end if

		if isnull(strsales[lrow].adjitem) then
			strsales[lrow].adjitem = ""
		end if

		if isnull(strsales[lrow].adjqty) then
			strsales[lrow].adjqty = 0
		end if

		if isnull(strsales[lrow].adjwgt) then
			strsales[lrow].adjwgt = 0
		end if

		if isnull(strsales[lrow].jewlcode) then
			strsales[lrow].jewlcode = ""
		end if

		if isnull(strsales[lrow].jva) then
			strsales[lrow].jva = 0
		end if

		if isnull(strsales[lrow].jrate) then
			strsales[lrow].jrate = 0
		end if

		if isnull(strsales[lrow].bcode) then
			strsales[lrow].bcode = 0
		end if

		if isnull(ijewl) or &
				ijewl = 0 then
			strsales[lrow].jewlcode = ""
			strsales[lrow].jrate = 0
			strsales[lrow].jva = 0
		end if
	end if

	lrow += 1
loop

scondense = profilestring(gsinifile,"Software","Condense","N")
srateprint = profilestring(gsinifile,"Software","Rateprint","Y")
sbheadenglish = profilestring(gsinifile,"Software","BHeadEnglish","N")
sfooterinmalayalam = profilestring(gsinifile,"Software","FooterInMalayalam","N")
sbold = profilestring(gsinifile,"Software","Bold","N")
sdeprhead = profilestring(gsinifile,"Software","DepreciationHead","N")
sesthead = profilestring(gsinifile,"Software","EstimateHead","ESTIMATE")
sprintzero = profilestring(gsinifile,"Software","PrintZeros","N")
sprinttotalwgt = profilestring(gsinifile,"Software","PrintTotalWgt","N")
sprintnetwgt = profilestring(gsinifile,"Software","PrintNetWgt","Y")
iform2form = profileint(gsinifile,"Software","PrintForm2Form",1)
swstginnetwgt = profilestring(gsinifile,"Software","WastageInNetWgt","Y")
ifooterskip = profileint(gsinifile,"Software","FooterSkip",8)

if profilestring(gsinifile,"Software","PrintWastage","Y") = "Y" then
	sprintwastage = "Y"
else
	sprintwastage = "N"
end if

dtdate = date(parent.em_date.text)
dttime = now()
dbamt = dec(parent.em_billtotal.text)
damt = dec(parent.em_nettot.text)
dexamt = dec(parent.em_exchange.text)
dsretamt = dec(parent.em_sreturn.text)
ddisc = dec(parent.em_discount.text)
dtaxamt = dec(parent.em_staxamt.text)
dtaxperc = dec(parent.em_taxperc.text)
dast = dec(parent.em_ast.text)
drcvd = dec(parent.em_rcvd.text)
scustname = trim(parent.st_custname.text)
ssmcode = trim(parent.dw_smcode.getitemstring(1,1))

if isnull(ssmcode) then
	ssmcode = ""
end if

dgrate = gdgrate
dsrate = gdsrate
dround = damt - (dbamt - dexamt - dsretamt - ddisc + dtaxamt)
dnetamt = damt
dadv = 0

if profilestring(gsinifile,"Software","SalesBillPrintForm","") = "Diamonde" then
	ilines = integer(profilestring(gsinifile,"Software","MaxItemsB","6"))
	parent.dw_print.dataobject = "d_diamond_sales_print_diamonde"
	parent.dw_print.object.t_taxinvoice.text = "QUOTATION"
	parent.dw_print.object.t_kvatr.visible = false
	parent.dw_print.object.t_formno.visible = false
	lrow = 1
	ltrow = upperbound(strsales)
	i = 0

	do while lrow <= ltrow
		scode = trim(strsales[lrow].itemcode)
		sname = trim(strsales[lrow].itemname)
		iqty = strsales[lrow].qty
		dwgt = strsales[lrow].weight
		dstwgt = strsales[lrow].stonewgt
		drate = strsales[lrow].rate
		dva = strsales[lrow].mcharge
		damt = strsales[lrow].amount
		lbcode = strsales[lrow].bcode
		dstprice = strsales[lrow].stoneprice

		if scode <> "" and &
				damt > 0 then
			irow = parent.dw_print.insertrow(0)
			i ++

			select qtype 
			into :spurity
			from barcode
			where bcode = :lbcode;

			if isnull(spurity) then
				spurity = ""
			end if

			select name 
			into :sname
			from items
			where code = :scode;

			parent.dw_print.setitem(irow,"sno",string(i,"####"))
			parent.dw_print.setitem(irow,"purity",spurity)
			parent.dw_print.setitem(irow,"itemname",sname)
			parent.dw_print.setitem(irow,"nos",iqty)
			parent.dw_print.setitem(irow,"weight",dwgt)
			parent.dw_print.setitem(irow,"stwgt",dstwgt)
			parent.dw_print.setitem(irow,"netwgt",dwgt - dstwgt)
			parent.dw_print.setitem(irow,"rate",drate)
			parent.dw_print.setitem(irow,"va",dva)
			parent.dw_print.setitem(irow,"amount",(dwgt - dstwgt) * drate + dva + dstprice)
			parent.dw_print.setitem(irow,"salesm_billamt",dbamt)
			parent.dw_print.setitem(irow,"salesm_netamt",dnetamt)
			parent.dw_print.setitem(irow,"salesm_staxamt",dtaxamt)
			parent.dw_print.setitem(irow,"salesm_staxperc",dtaxperc)
			parent.dw_print.setitem(irow,"salesm_astamt",dast)
			parent.dw_print.setitem(irow,"salesm_discount",ddisc)
			parent.dw_print.setitem(irow,"salesm_advance",0)
			parent.dw_print.setitem(irow,"salesm_sretamt",dretamt)
			parent.dw_print.setitem(irow,"salesm_custname",scustname)
			parent.dw_print.setitem(irow,"salesm_billno","QTN")
			parent.dw_print.setitem(irow,"salesm_smcode",ssmcode)
			parent.dw_print.setitem(irow,"salesm_tdate",dtdate)

			open cur2;      //sqlca

			fetch cur2 into :sstcode,:iqty,:dstwgt,:drate,:damt;      //sqlca

			do while sqlca.sqlcode = 0
				select name 
				into :sname
				from items
				where code = :sstcode;

				irow = parent.dw_print.insertrow(0)
				parent.dw_print.setitem(irow,"sno","")
				parent.dw_print.setitem(irow,"purity","")
				parent.dw_print.setitem(irow,"itemname",sname)
				parent.dw_print.setitem(irow,"nos",iqty)
				parent.dw_print.setitem(irow,"weight",0)
				parent.dw_print.setitem(irow,"stwgt",dstwgt)
				parent.dw_print.setitem(irow,"netwgt",0)
				parent.dw_print.setitem(irow,"rate",drate)
				parent.dw_print.setitem(irow,"va",0)
				parent.dw_print.setitem(irow,"amount",damt)
				parent.dw_print.setitem(irow,"salesm_billamt",dbamt)
				parent.dw_print.setitem(irow,"salesm_netamt",dnetamt)
				parent.dw_print.setitem(irow,"salesm_staxamt",dtaxamt)
				parent.dw_print.setitem(irow,"salesm_staxperc",dtaxperc)
				parent.dw_print.setitem(irow,"salesm_astamt",dast)
				parent.dw_print.setitem(irow,"salesm_discount",ddisc)
				parent.dw_print.setitem(irow,"salesm_advance",0)
				parent.dw_print.setitem(irow,"salesm_sretamt",dsretamt)

				fetch cur2 into :sstcode,:iqty,:dstwgt,:drate,:damt;      //sqlca
			loop

			close cur2;      //sqlca
		end if

		lrow ++
	loop

	if irow < ilines then
		for i = lrow to ilines
			lrow = parent.dw_print.insertrow(0)
			parent.dw_print.setitem(lrow,"salesm_billamt",dbamt)
			parent.dw_print.setitem(lrow,"salesm_netamt",dnetamt)
			parent.dw_print.setitem(lrow,"salesm_staxamt",dtaxamt)
			parent.dw_print.setitem(lrow,"salesm_staxperc",dtaxperc)
			parent.dw_print.setitem(lrow,"salesm_astamt",dast)
			parent.dw_print.setitem(lrow,"salesm_discount",ddisc)
			parent.dw_print.setitem(lrow,"salesm_advance",dadv)
			parent.dw_print.setitem(lrow,"salesm_sretamt",dsretamt)
		next
	end if

	parent.dw_print.print()

	return
end if

openwithparm(w_printcheck,"S")
iret = ::message.doubleparm
icontrol = 2

if iret = 1 or &
		iret = 2 then
	iprnlang = 1
else
	iprnlang = 2
end if

if iret = 1 or &
		iret = 3 then
	ibillform = 1
else
	ibillform = 2
end if

if iret = 0 then
	iprintok = 0
else
	iprintok = 1
end if

if iprintok = 0 then
	return
end if

prn.open()

if profilestring(gsinifile,"Software","ShowPreviewBeforePrint","N") = "Y" then
	prn.bpreview = true
end if

prn.print(0," ",0)

if icontrol = 1 then
	prn.print(38,"BILL",0)
else
	sesthead = "[ " + sesthead + " ]"
	prn.print((80 - len(sesthead)) / 2,sesthead,0)
end if

if isnull(scustname) then
	scustname = "."
end if

if isnull(ssmcode) then
	ssmcode = "."
end if

prn.print(0," ",0)

if gsids = "Nj" then
	prn.print(0,"Gold Purity 916 Rate : " + string(dgrate,"###0.00"),50)
	prn.print(0,"Time     : " + string(dttime,"h:mm:ss AM/PM"),0)
	prn.print(0,"Silver Rate /10 gm   : " + string(round(dsrate * 10,2),"###0.00"),0)
	prn.print(0,scustname,50)
else
	if gsids = "Ga" then
		prn.print(0,"Gold Rate/ gm      : " + string(dgrate,"###0.00"),50)
		prn.print(0,"Time     : " + string(dttime,"h:mm:ss AM/PM"),0)
		prn.print(0,"Silver Rate /10 gm : " + string(round(dsrate * 10,2),"###0.00"),0)
		prn.print(0,scustname,50)
	else
		prn.print(0," ",0)
		prn.print(0,"Date     : " + string(dtdate,"dd/mm/yyyy"),50)

		if profilestring(gsinifile,"Software","PrintSilverRate","Y") = "Y" then
			prn.print(0,"Gold Rate/gm     : " + string(dgrate),0)
			prn.print(0,"Time     : " + string(dttime,"h:mm:ss AM/PM"),50)
			prn.print(0,"Silver Rate/10gm : " + string(round(dsrate * 10,2)),0)
		else
			prn.print(0," ",0)
			prn.print(0,"Time     : " + string(dttime,"h:mm:ss AM/PM"),50)
			prn.print(0,"Gold Rate/gm     : " + string(dgrate),0)
		end if

		prn.print(0,"Customer : " + scustname,50)
	end if
end if

prn.print(0,"T" + sdocno + gsids + "  " + ssmcode,0)

if dbamt > 0 then
	sprintshead_dos(ibillform,scondense,sheadenglish,srateprint,"S",0)
	dtotwstg = 0
	dtnetwgt = 0
	dtstwgt = 0
	lrow = 1
	ltrow = upperbound(strsales)

	do while lrow <= ltrow
		scode = trim(strsales[lrow].itemcode)
		sname = trim(strsales[lrow].itemname)
		sjcode = trim(strsales[lrow].jewlcode)
		iqty = strsales[lrow].qty
		dweight = strsales[lrow].weight
		dstwgt = strsales[lrow].stonewgt
		dstprice = strsales[lrow].stoneprice
		dmcharge = strsales[lrow].mcharge
		dwastage = strsales[lrow].wastage
		damount = strsales[lrow].amount
		drate = strsales[lrow].rate
		skdm = strsales[lrow].kdm

		select regionalname , itype 
		into :sregional, :sitemtype
		from items
		where code = :scode;

		sregional = trim(sregional)

		if isnull(sjcode) then
			sjcode = ""
		end if

		sjcode = trim(sjcode)

		if iprnlang = 2 then
			sname = sregional

			if ibillform = 1 then
				printsetfont(ljob,1)
			else
				printsetfont(ljob,5)
			end if
		end if

		if ibillform = 1 then
			iqty = round(iqty,0)

			if isnull(dweight) then
				dweight = 0
			end if

			dweight = round(dweight,3)

			if isnull(drate) then
				drate = 0
			end if

			drate = round(drate,2)
			dstwgt = round(dstwgt,3)
			dnetwgt = round(dweight - dstwgt,3)
			dstprice = round(dstprice,2)
			dmcharge = round(dmcharge,2)
			dwastage = round(dwastage,3)
			dvaladd = round(dwastage * drate + dmcharge,2)
			damount = round(damount,2)

			if sitemtype = "G" then
				dtnwgtg += dweight
				dtnetwgt += dnetwgt
			else
				if sitemtype = "S" then
					dtnwgts += dweight
				end if
			end if

			if skdm = "Y" then
				if iprnlang = 1 then
					sname = trim(sname) + "[KDM]"
				else
					sname = trim(sname) + "(sI.Un.Fw.)"
				end if
			else
				if skdm = "9" then
					sname = trim(sname) + "(916)"
				end if
			end if

			if sjcode <> "" then
				if iprnlang = 1 then
					sname = trim(sname) + "[" + sjcode + "]"
				else
					sname = trim(sname) + " *"
				end if
			end if

			if srateprint = "Y" or &
					stmp = "SO" or &
					(drate <> dgrate and &
					sitemtype = "G") or &
					(drate <> dsrate and &
					sitemtype = "S") then
				sname = trim(left(sname,16))
				prn.print(0,sname,17)
			else
				sname = trim(left(sname,23))
				prn.print(0,sname,24)
			end if

			if srateprint = "Y" or &
					stmp = "SO" or &
					(drate <> dgrate and &
					sitemtype = "G") or &
					(drate <> dsrate and &
					sitemtype = "S") then
				prn.print(0,ftrans(drate,6,2),25)
			end if

			prn.print(25,ftrans(iqty,3,0),29)
			prn.print(0,ftrans(dweight,7,3),37)

			if dstwgt > 0 then
				prn.print(0,ftrans(dstwgt,6,3),44)
				dtstwgt += dstwgt
			else
				if sprintzero = "Y" then
					prn.print(0,ftrans(dstwgt,6,3),44)
				end if
			end if

			if istone > 0 then
				prn.print(45,ftrans(dnetwgt,8,3),55)
			else
				if sprintzero = "Y" or &
						sprinttotalwgt = "Y" then
					prn.print(45,ftrans(dnetwgt,8,3),55)
				else
					prn.print(45," ",55)
				end if
			end if

			if dstprice > 0 then
				prn.print(0,ftrans(dstprice,6,2),62)
			else
				if sprintzero = "Y" then
					prn.print(0,ftrans(dstprice,6,2),62)
				end if
			end if

			if sprintvap = "Y" then
				dtmp = (dvaladd * 100) / (damount - dvaladd - dstprice)
				prn.print(62,ftrans(dtmp,7,2) + "%",70)
			else
				if profilestring(gsinifile,"Software","PrintVAPerGm","N") = "Y" and &
						dnetwgt > 0 then
					prn.print(62,ftrans(dvaladd / dnetwgt,8,2),70)
				else
					prn.print(62,ftrans(dvaladd,8,2),70)
				end if
			end if

			prn.print(0,ftrans(damount,10,2),0)

			if isnull(dvaladd) then
				dvaladd = 0
			end if

			dtvaladd += dvaladd
			dtamt += damount
		else
			if ibillform = 2 then
				iqty = round(iqty,0)

				if isnull(dweight) then
					dweight = 0
				end if

				dweight = round(dweight,3)

				if isnull(drate) then
					drate = 0
				end if

				drate = round(drate,2)
				dstwgt = round(dstwgt,3)

				if swstginnetwgt = "Y" then
					dnetwgt = round(dweight - dstwgt + dwastage,3)
				else
					dnetwgt = round(dweight - dstwgt,3)
				end if

				dstprice = round(dstprice,2)
				dmcharge = round(dmcharge,2)
				dwastage = round(dwastage,3)

				if sprintwastage = "Y" and &
						sprintnetwgt = "Y" and &
						iform2form = 1 then
					dvaladd = round(dmcharge + dstprice,2)
				else
					dvaladd = round(dmcharge,2)
				end if

				damount = round(damount,2)

				if sitemtype = "G" then
					dtnwgtg += dweight
					dtnetwgt += dnetwgt
				else
					if sitemtype = "S" then
						dtnwgts += dweight
					end if
				end if

				if skdm = "Y" then
					if iprnlang = 1 then
						sname = trim(sname) + "[KDM]"
					else
						sname = trim(sname) + "(sI.Un.Fw.)"
					end if
				else
					if skdm = "9" then
						sname = trim(sname) + "(916)"
					end if
				end if

				if sjcode <> "" then
					sname = sname + " *"
				end if

				if srateprint = "Y" then
					sname = trim(left(sname,12))
					prn.print(0,sname,12)
				else
					sname = trim(left(sname,18))
					prn.print(0,sname,18)
				end if

				if srateprint = "Y" then
					prn.print(0,ftrans(drate,6,2),18)
				end if

				prn.print(18,ftrans(iqty,3,0),21)

				if iform2form = 2 then
					prn.print(0,ftrans(dweight,8,3),30)
				else
					prn.print(0,ftrans(dweight,8,3),30)
				end if

				if dstwgt > 0 then
					prn.print(0,ftrans(dstwgt,6,3),37)
					dtstwgt += dstwgt
				else
					if sprintzero = "Y" then
						prn.print(0,ftrans(dstwgt,6,3),37)
					end if
				end if

				if iform2form = 2 then
					if swstginnetwgt = "Y" then
						prn.print(37,ftrans(dwastage,6,3),45)
						prn.print(0,ftrans(dnetwgt,8,3),54)
					else
						prn.print(37,ftrans(dnetwgt,8,3),47)
						prn.print(0,ftrans(dwastage,6,3),54)
					end if
				else
					if sprintwastage = "Y" then
						prn.print(37,ftrans(dwastage,6,3),45)
					else
						if dstprice > 0 or &
								sprintzero = "Y" then
							prn.print(37,ftrans(dstprice,7,2),45)
						else
							prn.print(37," ",45)
						end if
					end if

					if sprintnetwgt = "Y" then
						prn.print(0,ftrans(dnetwgt,8,3),54)
					else
						prn.print(0,ftrans(dstprice,8,2),54)
					end if
				end if

				if iform2form = 2 then
					if dstprice > 0 or &
							sprintzero = "Y" then
						prn.print(0,ftrans(dstprice,7,2),62)
					else
						prn.print(0," ",62)
					end if

					prn.print(0,ftrans(dvaladd,8,2),70)
				else
					prn.print(0,ftrans(dnetwgt * drate,9,2),64)
					prn.print(0,ftrans(dvaladd,7,2),71)
				end if

				prn.print(0,ftrans(damount,10,2),0)

				if isnull(dvaladd) then
					dvaladd = 0
				end if

				dtvaladd += dvaladd
				dtamt += damount
				dtotwstg += dwastage
			end if
		end if

		lrow ++
	loop

	prn.print(0,fill("-",80),0)

	if iprnlang = 2 and &
			sheadenglish <> "Y" then
		printsetfont(ljob,1)

		if ibillform = 1 then
			prn.print(0,"BsI       : ",26)
		else
			prn.print(0,"BsI       : ",20)
		end if
	else
		if ibillform = 1 then
			prn.print(0,"Total    : ",26)
		else
			prn.print(0,"Total    : ",20)
		end if
	end if

	if ibillform = 1 then
		if istone > 0 or &
				sprintzero = "Y" or &
				sprinttotalwgt = "Y" then
			prn.print(0,ftrans(dtnwgtg,10,3),45)
			prn.print(0,ftrans(dtnetwgt,8,3),61)
		else
			prn.print(0,ftrans(dtnwgtg,10,3),61)
		end if

		if profilestring(gsinifile,"Software","PrintTotalVA","Y") = "Y" then
			prn.print(0,ftrans(dtvaladd,9,2),70)
		else
			prn.print(0,"",70)
		end if

		prn.print(0,ftrans(dtamt,10,2),0)
	else
		if scondense <> "Y" and &
				iform2form = 1 then
		end if

		if profilestring(gsinifile,"Software","PrintTotalWastage","Y") = "Y" then
			if swstginnetwgt = "Y" then
				prn.print(0,ftrans(dtnwgtg,9,3),36)

				if sprintwastage = "Y" then
					prn.print(0,ftrans(dtotwstg,7,3),44)
				else
					prn.print(0," ",44)
				end if

				if profilestring(gsinifile,"Software","PrintTotTotalWgt","Y") = "Y" then
					prn.print(0,ftrans(dtnetwgt,9,3),63)
				else
					prn.print(0," ",63)
				end if
			else
				prn.print(0,ftrans(dtnwgtg,9,3),36)

				if profilestring(gsinifile,"Software","PrintTotTotalWgt","Y") = "Y" then
					prn.print(0,ftrans(dtnetwgt,9,3),46)
				else
					prn.print(0," ",46)
				end if

				if sprintwastage = "Y" then
					prn.print(0,ftrans(dtotwstg,7,3),63)
				else
					prn.print(0,"",63)
				end if
			end if
		else
			if swstginnetwgt = "Y" then
				prn.print(0,ftrans(dtnwgtg,9,3),44)

				if profilestring(gsinifile,"Software","PrintTotTotalWgt","Y") = "Y" then
					prn.print(0,ftrans(dtnetwgt,9,3),63)
				else
					prn.print(0,"",63)
				end if
			else
				prn.print(0,ftrans(dtnwgtg,9,3),36)

				if profilestring(gsinifile,"Software","PrintTotTotalWgt","Y") = "Y" then
					prn.print(0,ftrans(dtnetwgt,9,3),63)
				else
					prn.print(0,"",63)
				end if
			end if
		end if

		if profilestring(gsinifile,"Software","PrintTotalMC","Y") = "Y" then
			if iform2form = 2 then
				prn.print(0,ftrans(dtvaladd,7,2),70)
			else
				prn.print(0,ftrans(dtvaladd,8,2),70)
			end if
		else
			prn.print(0,"",70)
		end if

		if iform2form = 2 then
			prn.print(0,ftrans(dtamt,10,2),0)
		else
			prn.print(71,ftrans(dtamt,10,2),0)
		end if
	end if

	if dtnwgts > 0 then
		if iprnlang = 2 and &
				sheadenglish <> "Y" then
			if ibillform = 1 then
				prn.print(10,"sh~hC5n Xq~hA1w",23)
			else
				prn.print(7,"sh~hC5n Xq~hA1w",21)
			end if
		else
			if ibillform = 1 then
				prn.print(10,"Silver wgt",24)
			else
				prn.print(7,"Silver wgt",20)

				if scondense <> "Y" and &
						iform2form = 1 then
				end if
			end if
		end if

		prn.print(0,ftrans(dtnwgts,9,3),0)
	end if

	dtotal += dtamt
end if

ltrow = upperbound(parent.strsreturn)

if ltrow > 0 then
	dtamt = parent.qtnprint_sreturn(ljob,iprnlang,ibillform,scondense,sbheadenglish,srateprint,0,dtamt,"","E")
end if

ltrow = upperbound(parent.strexchange)

if ltrow > 0 then
	dtamt = parent.qtnprint_exchange(ljob,iprnlang,ibillform,scondense,sbheadenglish,srateprint,0,dtamt,"","E")
end if

if dexamt > 0 or &
		dsretamt > 0 then
	if iprnlang = 2 and &
			sbheadenglish <> "Y" then
		prn.print(0,"_m~hA1n XpI    : ",60)
	else
		prn.print(0,"Net Amount  : ",60)
	end if

	prn.print(70,ftrans(dtamt,10,2),0)
end if

prn.print(0," ",0)

if isnull(dtaxamt) then
	dtaxamt = 0
end if

if sbheadenglish = "Y" then
	iprnlang = 1
end if

if iprnlang = 2 then
	if dtaxamt > 0 then
		prn.print(55,"\nIpXn(" + string(gdstax,"##.##") + "%)",70)
	else
		prn.print(55,"\nIpXn",70)
	end if
else
	if dtaxamt > 0 then
		prn.print(50,"Tax(" + string(dtaxperc,"##.##") + "%)",70)
	else
		prn.print(50,"Tax",70)
	end if
end if

prn.print(0,ftrans(dtaxamt,10,2),0)
dtamt += dtaxamt

if ddisc <> 0 then
	if iprnlang = 2 then
		if icontrol = 1 or &
				gircvdmode <> 3 then
			prn.print(55,"Ingnhv         :",70)
		else
			prn.print(55,"-",70)
		end if
	else
		if icontrol = 1 or &
				gircvdmode <> 3 then
			prn.print(50,"Discount : ",70)
		else
			prn.print(50,"-",70)
		end if
	end if

	prn.print(0,ftrans(ddisc,10,2),0)
end if

dtamt += dround

if iprnlang = 2 then
	prn.print(55,"BsI XpI  :",70)
else
	if sbold = "Y" and &
			scondense <> "Y" then
		lpos = 70

		if dtamt - ddisc > 0 then
			prn.print(50,"Net",lpos)
		else
			prn.print(50,"Refund",lpos)
		end if
	else
		if dtamt - ddisc > 0 then
			prn.print(50,"Net      : ",70)
		else
			prn.print(50,"Refund   : ",70)
		end if
	end if
end if

prn.print(0,ftrans(dtamt - ddisc,10,2),0)
dbalance = dbamt + dtaxamt - dexamt - dsretamt - ddisc - drcvd + dround

if icontrol = 1 or &
		dbalance <> 0 then
	prn.print(50,"Received : ",70)
	prn.print(0,ftrans(drcvd,10,2),0)

	if dbalance <> 0 then
		if sbold = "Y" and &
				scondense <> "Y" then
			lpos = 0
			prn.print(50,"Balance",lpos)
		else
			prn.print(50,"Balance  : ",70)
		end if

		prn.print(0,ftrans(dbalance,10,2),0)

		if year(dtduedate) > 1900 then
			prn.print(50,"Duedate  : ",70)
			prn.print(0,string(dtduedate,"dd/mm/yyyy"),0)
		end if
	end if
end if

if profilestring(gsinifile,"Software","PrintOldBalance","N") = "Y" and &
		scustcode <> "ORDC" then
	if dob <> 0 then
		prn.print(0," ",0)
		prn.print(50,"Old Bal  : ",70)
		prn.print(0,ftrans(dob,10,2),0)
		printsetfont(ljob,7)
		prn.print(50,"Net Bal  : ",70)
		prn.print(0,ftrans(dob + dbalance,10,2),0)
	end if
end if

snetamt = stramount(abs(dtamt - ddisc))
prn.print(0,snetamt,0)
prn.print(0,fill("=",80),0)
smod = trim(profilestring(gsinifile,"Software","ThanksE","Thanks. Come again."))
prn.print(0,smod,64)

if trim(gsholidaye) <> "" then
	prn.print(0,gsholidaye + " Holiday.",0)
else
	prn.print(0,".",0)
end if

smod = trim(profilestring(gsinifile,"Software","EstimateFooterE",""))

if smod <> "" and &
		icontrol > 1 then
	prn.print(0,smod,64)
end if

if gsids = "Nj" or &
		gsids = "Ga" then
	sdate = string(day(date(dtdate)),"00") + string(month(date(dtdate)),"00") & 
			+ string(year(date(dtdate)),"0000")
	sdate = string(100000000 - long(sdate),"###00000")

	if lterows > 1 then
		prn.print(50,sdate,62)
		prn.print(0,trim(string(dtotogwgt,"####0")) + "/" + mid(string(dtotogwgt,".###"),2,3),0)
	else
		prn.print(0,sdate,0)
	end if
end if

smod = profilestring(gsinifile,"Software","MOD","")

if smod <> "" then
	prn.print(0,smod,0)
end if

printfooter_dos("E")

for icontrol = 0 to ifooterskip
	prn.print(0," ",0)
next

prn.close()

return
end event

event rbuttondown;
parent.em_rate.displayonly = false
end event

type cb_short from commandbutton within w_sales
integer x = 4434
integer y = 1712
integer width = 485
integer height = 92
integer taborder = 530
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Short &Print"
end type

event clicked;long ljob
long lrow
long ltrow
long iqty
dec dnetamt
dec dwgt
dec dtwgt
dec dexamt
dec dretamt
dec dbamt
dec dstwgt
dec dstamt
dec damt
dec dtax
dec ddmdamt
dec dgrate
dec dmc
dec dwastage
dec drate
dec dadvance
dec dvaperc
dec dexchwgt
dec dexchstwgt
dec dsretwgt
dec dsretstwgt
date dtdate
string sdocno
string sparty
string ssmcode
string sitem
string spartyaddr
string scode
time dttime
int i
int ifooterskip

ifooterskip = profileint(gsinifile,"Software","FooterSkip",8)
dtdate = date(parent.em_date.text)
dttime = now()
sdocno = trim(parent.st_billno.text)
dbamt = dec(parent.em_billtotal.text)
dexamt = dec(parent.em_exchange.text)
dretamt = dec(parent.em_sreturn.text)
dnetamt = dec(parent.em_nettot.text)
dtax = dec(parent.em_staxamt.text)
dgrate = dec(parent.em_rate.text)
sparty = trim(parent.st_custname.text)
spartyaddr = trim(parent.sle_addr.text)
ssmcode = trim(parent.dw_smcode.getitemstring(1,1))

if isnull(ssmcode) then
	ssmcode = ""
end if

dadvance = 0

if profilestring(gsinifile,"Software","SalesFirstPrint","") <> "Thermal" then
	prn.open()

	if profilestring(gsinifile,"Software","ShortPrintCondense","N") = "Y" then
		prn.print(0,char(15),0)
	end if

	prn.print(0,"Date : " + string(dtdate,"dd/mm/yyyy") + " " & 
			+ string(dttime,"hh:mm am/pm"),0)
	prn.print(0,sdocno + "    " + ssmcode,0)

	if sparty <> "" then
		prn.print(0,"Party : " + sparty,0)
	end if

	prn.print(0,"Item",15)
	prn.print(0,"Qty",19)
	prn.print(0," Weight",28)
	prn.print(0,"St.Wgt",36)
	prn.print(0,"Tot.Wgt",44)
	prn.print(0," St.Amt",52)
	prn.print(0,"  Tot.Amt",0)
	prn.print(0,fill("-",62),0)
else
	parent.dw_print.reset()
	dexchwgt = 0
	dexchstwgt = 0

	for i = 1 to upperbound(parent.strexchange)
		dexchwgt += parent.strexchange[i].weight
		dexchstwgt += parent.strexchange[i].stonewgt
	next

	dsretwgt = 0
	dsretstwgt = 0

	for i = 1 to upperbound(parent.strsreturn)
		dsretwgt += parent.strsreturn[i].weight
		dsretstwgt += parent.strsreturn[i].stonewgt
	next
end if

ltrow = parent.dw_sale.rowcount()
lrow = 1
dtwgt = 0

do while lrow <= ltrow
	sitem = parent.dw_sale.getitemstring(lrow,"itemname")
	scode = parent.dw_sale.getitemstring(lrow,"itemcode")
	iqty = parent.dw_sale.getitemnumber(lrow,"qty")
	dwgt = parent.dw_sale.getitemnumber(lrow,"weight")
	dstwgt = parent.dw_sale.getitemnumber(lrow,"stonewgt")
	dstamt = parent.dw_sale.getitemnumber(lrow,"stoneprice")
	ddmdamt = parent.dw_sale.getitemnumber(lrow,"dmdamt")
	damt = parent.dw_sale.getitemnumber(lrow,"amount")
	dmc = parent.dw_sale.getitemnumber(lrow,"mcharge")
	dwastage = parent.dw_sale.getitemnumber(lrow,"wastage")
	drate = parent.dw_sale.getitemnumber(lrow,"rate")
	dvaperc = parent.dw_sale.getitemnumber(lrow,"vaperc")

	if isnull(iqty) then
		iqty = 0
	end if

	if isnull(dwgt) then
		dwgt = 0
	end if

	if iqty > 0 or &
			dwgt > 0 then
		if profilestring(gsinifile,"Software","SalesFirstPrint","") = "Thermal" then
			lrow = parent.dw_print.insertrow(0)
			parent.dw_print.setitem(lrow,"salesm_tdate",dtdate)
			parent.dw_print.setitem(lrow,"salesm_ttime",dttime)
			parent.dw_print.setitem(lrow,"salesm_grate",dgrate)
			parent.dw_print.setitem(lrow,"salesm_billno",sdocno)
			parent.dw_print.setitem(lrow,"salesm_custname",sparty)
			parent.dw_print.setitem(lrow,"salesm_addr",spartyaddr)
			parent.dw_print.setitem(lrow,"salesm_billamt",dbamt)
			parent.dw_print.setitem(lrow,"salesm_eamt",dexamt)
			parent.dw_print.setitem(lrow,"salesm_sretamt",dretamt)
			parent.dw_print.setitem(lrow,"salesm_staxamt",dtax)
			parent.dw_print.setitem(lrow,"salesm_netamt",dnetamt)
			parent.dw_print.setitem(lrow,"salesm_smcode",ssmcode)
			parent.dw_print.setitem(lrow,"salesm_advance",dadvance)
			parent.dw_print.setitem(lrow,"salesd_name",sitem)
			parent.dw_print.setitem(lrow,"items_name",sitem)
			parent.dw_print.setitem(lrow,"salesd_code",scode)
			parent.dw_print.setitem(lrow,"salesd_qty",iqty)
			parent.dw_print.setitem(lrow,"salesd_weight",dwgt)
			parent.dw_print.setitem(lrow,"salesd_stonewgt",dstwgt)
			parent.dw_print.setitem(lrow,"salesd_stoneprice",dstamt)
			parent.dw_print.setitem(lrow,"dmdamt",ddmdamt)
			parent.dw_print.setitem(lrow,"salesd_vaperc",dvaperc)
			parent.dw_print.setitem(lrow,"salesd_mcharge",dmc)
			parent.dw_print.setitem(lrow,"salesd_wastage",dwastage)
			parent.dw_print.setitem(lrow,"salesd_rate",drate)
			parent.dw_print.setitem(lrow,"salesd_amount",damt)
			parent.dw_print.setitem(lrow,"exchwgt",dexchwgt)
			parent.dw_print.setitem(lrow,"exchstwgt",dexchstwgt)
			parent.dw_print.setitem(lrow,"sretwgt",dsretwgt)
			parent.dw_print.setitem(lrow,"sretstwgt",dsretstwgt)
		else
			sitem = left(sitem,14)
			prn.print(0,sitem,15)
			prn.print(0,ftrans(iqty,3,0),19)
			prn.print(0,ftrans(dwgt,7,3),28)
			prn.print(0,ftrans(dstwgt,6,3),36)
			prn.print(0,ftrans(dwgt - dstwgt,7,3),44)
			prn.print(0,ftrans(dstamt,7,2),52)
			prn.print(0,ftrans(damt,9,2),0)
			dtwgt += dwgt
		end if
	end if

	lrow ++
loop

if profilestring(gsinifile,"Software","SalesFirstPrint","") <> "Thermal" then
	prn.print(0,fill("-",62),0)
	prn.print(0,"Total    :",19)
	prn.print(0,ftrans(dtwgt,7,3),51)
	prn.print(0,ftrans(dbamt,10,2),0)

	if dexamt > 0 then
		prn.print(0,"Exchange",0)
		prn.print(0,"Item",15)
		prn.print(0,"Qty",19)
		prn.print(0," Weight",28)
		prn.print(0,"  Rate",36)
		prn.print(0,"  Tot.Amt",0)
		prn.print(0,fill("-",46),0)
		ltrow = upperbound(parent.strexchange)
		lrow = 1

		do while lrow <= ltrow
			sitem = left(parent.strexchange[lrow].itemname,14)
			prn.print(0,sitem,15)
			prn.print(0,ftrans(parent.strexchange[lrow].qty,3,0),19)
			prn.print(0,ftrans(parent.strexchange[lrow].weight - parent.strexchange[lrow].mud,7,3),28)
			prn.print(0,ftrans(parent.strexchange[lrow].rate,6,2),36)
			prn.print(0,ftrans(parent.strexchange[lrow].amount,9,2),0)
			lrow ++
		loop

		prn.print(0,fill("-",46),0)
		prn.print(0,"Exch Amt : ",51)
		prn.print(0,ftrans(dexamt,10,2),0)
	end if

	if dretamt > 0 then
		prn.print(0,"Return",0)
		prn.print(0,"Item",15)
		prn.print(0,"Qty",19)
		prn.print(0," Weight",28)
		prn.print(0,"St.Wgt",36)
		prn.print(0,"Tot.Wgt",44)
		prn.print(0," St.Amt",52)
		prn.print(0,"  Tot.Amt",0)
		prn.print(0,fill("-",62),0)
		ltrow = upperbound(parent.strsreturn)
		lrow = 1
		dtwgt = 0

		do while lrow <= ltrow
			sitem = left(parent.strsreturn[lrow].itemname,14)
			prn.print(0,sitem,15)
			prn.print(0,ftrans(parent.strsreturn[lrow].qty,3,0),19)
			prn.print(0,ftrans(parent.strsreturn[lrow].weight,7,3),28)
			prn.print(0,ftrans(parent.strsreturn[lrow].stonewgt,6,3),36)
			prn.print(0,ftrans(parent.strsreturn[lrow].weight - parent.strsreturn[lrow].stonewgt,7,3),44)
			prn.print(0,ftrans(parent.strsreturn[lrow].stoneprice,7,2),52)
			prn.print(0,ftrans(parent.strsreturn[lrow].amount,9,2),0)
			lrow ++
		loop

		prn.print(0,fill("-",62),0)
		prn.print(0,"SRet Amt : ",51)
		prn.print(0,ftrans(dretamt,10,2),0)
	end if

	prn.print(0,"Net Amt  : ",51)
	prn.print(0,ftrans(dnetamt,10,2),0)
	prn.print(0,fill("-",62),0)

	for i = 0 to ifooterskip
		prn.print(0," ",0)
	next

	prn.close()
end if

if profilestring(gsinifile,"Software","SalesFirstPrint","") = "Thermal" then
	if profilestring(gsinifile,"Software","ThermalPrinter","") <> "" then
		parent.dw_print.object.datawindow.printer = profilestring(gsinifile,"Software","ThermalPrinter","")
	end if

	if messagebox("Print?","Print Start ?",question!,yesno!,1) = 1 then
		parent.dw_print.print()

		rollback;
	end if
end if

return
end event

type dw_co from datawindow within w_sales
event uekey pbm_dwnkey
integer x = 2021
integer y = 96
integer width = 402
integer height = 88
integer taborder = 90
string dataobject = "d_cust"
boolean border = false
boolean livescroll = true
end type

event uekey;string scode

if key = keyenter! then
	parent.dw_1.setfocus()
else
	if key = keyf1! then
		parent.cb_cohelp.triggerevent(clicked!)
	end if
end if
end event

event itemchanged;string sname
string scode
string stype
int iret

scode = trim(parent.dw_co.gettext())
sname = ""
iret = 0

if isnull(scode) then
	scode = ""
end if

if profilestring(gsinifile,"Software","CoCustomersOnly","N") = "Y" then
	select name 
	into :sname
	from clients
	where code = :scode;
else
	select name 
	into :sname
	from accountm
	where trim ( accode ) = :scode;
end if

if sqlca.sqlcode <> 0 and &
		scode <> "" then
	this.setfocus()
	this.settext("")
	this.setitem(1,1,"")
	messagebox("Error","Invalid Customer",exclamation!,ok!)
	iret = 1
end if

return iret
end event

event itemerror;
return 1
end event

event getfocus;//Omitted: the default "return"
end event

type st_16 from statictext within w_sales
integer x = 1806
integer y = 104
integer width = 110
integer height = 76
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "C/o"
boolean focusrectangle = false
end type

type em_ob from editmask within w_sales
integer x = 2939
integer y = 188
integer width = 407
integer height = 88
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
string mask = "#########.00"
string displaydata = "x4"
end type

type st_ob from statictext within w_sales
integer x = 2697
integer y = 200
integer width = 165
integer height = 76
integer textsize = -9
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "OB"
boolean focusrectangle = false
end type

type st_itemcode_m from statictext within w_sales
boolean visible = false
integer x = 37
integer y = 384
integer width = 242
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "B`cWw tImUv"
boolean focusrectangle = false
end type

type st_itemname_m from statictext within w_sales
boolean visible = false
integer x = 416
integer y = 392
integer width = 471
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "B`cWw t]cv"
boolean focusrectangle = false
end type

type st_qty_m from statictext within w_sales
boolean visible = false
integer x = 2354
integer y = 384
integer width = 114
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "F w"
alignment alignment = center!
boolean focusrectangle = false
end type

type st_weight_m from statictext within w_sales
boolean visible = false
integer x = 2514
integer y = 388
integer width = 242
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "Xqw {Kmw"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_stwgt_m from statictext within w_sales
boolean visible = false
integer x = 2807
integer y = 392
integer width = 219
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "Iv Xqw"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_stprice_m from statictext within w_sales
boolean visible = false
integer x = 3351
integer y = 392
integer width = 224
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "Iv hne"
boolean focusrectangle = false
end type

type st_wastage_m from statictext within w_sales
boolean visible = false
integer x = 3598
integer y = 388
integer width = 279
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "]Wnpdhv"
boolean focusrectangle = false
end type

type st_mc_m from statictext within w_sales
boolean visible = false
integer x = 4114
integer y = 392
integer width = 261
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "]Wnqen"
boolean focusrectangle = false
end type

type st_amount_m from statictext within w_sales
boolean visible = false
integer x = 4434
integer y = 392
integer width = 297
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "XpI"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_rate_m from statictext within w_sales
boolean visible = false
integer x = 4782
integer y = 388
integer width = 192
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "hne"
alignment alignment = right!
boolean focusrectangle = false
end type

type st_jewl_m from statictext within w_sales
boolean visible = false
integer x = 4978
integer y = 388
integer width = 137
integer height = 112
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long textcolor = 16777215
long backcolor = 32768
boolean enabled = false
string text = "Pzdn"
boolean focusrectangle = false
end type

type st_itemadj from statictext within w_sales
integer x = 4160
integer y = 1268
integer width = 306
integer height = 60
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type st_kdm from statictext within w_sales
integer x = 4178
integer y = 1184
integer width = 174
integer height = 64
integer textsize = -8
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
boolean focusrectangle = false
end type

type dw_smcode from datawindow within w_sales
event ue_key pbm_dwnkey
integer x = 3685
integer y = 188
integer width = 677
integer height = 88
integer taborder = 100
string dataobject = "d_smancode"
boolean border = false
boolean livescroll = true
end type

event ue_key;
if key = keyenter! then
	if trim(this.gettext()) = "" and &
			profilestring(gsinifile,"Software","SMCompulsary","N") = "Y" then
		this.setfocus()
	else
		parent.sle_mobno.setfocus()
	end if
end if
end event

event itemchanged;string scode
string sname

scode = trim(data)

select name 
into :sname
from sman
where code = :scode;

if sqlca.sqlcode <> 0 then
	this.setitem(1,1,"")
	this.settext("")
	messagebox("Invalid Code","Please Check code")
end if
end event

event losefocus;
this.accepttext()
end event

type st_10 from statictext within w_sales
integer x = 3410
integer y = 200
integer width = 274
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "SM Name"
boolean focusrectangle = false
end type

type st_jcode from statictext within w_sales
integer x = 4384
integer y = 1184
integer width = 123
integer height = 56
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
alignment alignment = right!
boolean focusrectangle = false
end type

type st_va from statictext within w_sales
integer x = 2702
integer y = 1272
integer width = 238
integer height = 60
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
boolean focusrectangle = false
end type

type st_stock from statictext within w_sales
integer x = 1906
integer y = 1272
integer width = 402
integer height = 60
integer textsize = -8
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
boolean focusrectangle = false
end type

type em_sreturn from editmask within w_sales
integer x = 3694
integer y = 1344
integer width = 453
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "#####0.00"
end type

type st_sreturn from statictext within w_sales
integer x = 3401
integer y = 1352
integer width = 288
integer height = 64
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Sales Ret."
boolean focusrectangle = false
end type

type cb_sreturn from commandbutton within w_sales
integer x = 4434
integer y = 1436
integer width = 485
integer height = 84
integer taborder = 500
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Sales Retur&n"
end type

event clicked;
gsgenparm = parent.em_billtotal.text
gstrexchange[] = parent.strsreturn[]
openwithparm(w_sreturn,parent.classname())
parent.strsreturn[] = gstrexchange[]
parent.bchkentry = true
parent.dw_sale.triggerevent(losefocus!)
parent.dw_sale.setfocus()
end event

type cb_exchange from commandbutton within w_sales
integer x = 4434
integer y = 1352
integer width = 485
integer height = 84
integer taborder = 510
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "&Exchange"
end type

event clicked;dec dtwgt

dtwgt = 0

if parent.dw_sale.rowcount() > 0 then
	dtwgt = parent.dw_sale.getitemnumber(1,"netwgt")
end if

gsgenparm = string(dtwgt) + "|" + parent.em_billtotal.text
gstrexchange[] = parent.strexchange[]
openwithparm(w_exchange,parent.classname())
parent.strexchange[] = gstrexchange[]
parent.bchkentry = true
parent.dw_sale.triggerevent(losefocus!)
parent.dw_sale.setfocus()
end event

type st_14 from statictext within w_sales
integer x = 398
integer y = 376
integer width = 5
integer height = 804
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_13 from statictext within w_sales
integer x = 4983
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_12 from statictext within w_sales
integer x = 4745
integer y = 380
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_11 from statictext within w_sales
integer x = 4398
integer y = 376
integer width = 5
integer height = 880
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_9 from statictext within w_sales
integer x = 3904
integer y = 376
integer width = 5
integer height = 880
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_8 from statictext within w_sales
integer x = 3593
integer y = 376
integer width = 5
integer height = 880
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_7 from statictext within w_sales
integer x = 3045
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_6 from statictext within w_sales
integer x = 2802
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_5 from statictext within w_sales
integer x = 2510
integer y = 376
integer width = 5
integer height = 876
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean focusrectangle = false
end type

type st_4 from statictext within w_sales
integer x = 1435
integer y = 376
integer width = 5
integer height = 884
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 0
boolean enabled = false
boolean border = true
boolean focusrectangle = false
end type

type em_duedate from editmask within w_sales
integer x = 3694
integer y = 1608
integer width = 389
integer height = 84
integer taborder = 270
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yy"
string displaydata = ""
boolean dropdowncalendar = true
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_3 from statictext within w_sales
integer x = 3401
integer y = 1608
integer width = 297
integer height = 80
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Due Date"
boolean focusrectangle = false
end type

type st_custname from singlelineedit within w_sales
integer x = 731
integer y = 188
integer width = 1047
integer height = 88
integer taborder = 40
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
integer limit = 30
end type

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type em_staxamt from editmask within w_sales
integer x = 471
integer y = 1432
integer width = 325
integer height = 84
integer taborder = 150
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
alignment alignment = right!
string mask = "##########.00"
string displaydata = ""
end type

event modified;
parent.balcalc(1)
end event

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_staxamt from statictext within w_sales
integer y = 1440
integer width = 315
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Tax Amt"
boolean focusrectangle = false
end type

type dw_1 from datawindow within w_sales
event uekey pbm_dwnkey
integer x = 265
integer y = 188
integer width = 402
integer height = 88
integer taborder = 30
string dataobject = "d_cust"
boolean border = false
boolean livescroll = true
end type

event uekey;string scode

if key = keyenter! and &
		parent.bok then
	scode = trim(this.gettext())

	if trim(scode) = "" then
		parent.st_custname.setfocus()
	else
		parent.dw_smcode.setfocus()
	end if
else
	if key = keyf1! then
		gscs = "C"

		if profilestring(gsinifile,"Software","ShowAllClientsInSale","N") = "Y" then
			gsgenparm = "All"
		end if

		openwithparm(w_clientshelp,this.gettext())
		scode = message.stringparm

		if scode <> "" then
			this.settext(scode)
		end if
	else
		if key = keyf12! then
			openwithparm(w_sucu,"C")
			scode = message.stringparm

			if scode <> "" then
				this.settext(scode)
			end if
		end if
	end if
end if
end event

event itemchanged;string sname
string scode
string stype
string scocode
string sblocked
string saddr1
string saddr2
string smob
string span
string scode2
string stin
string sstate
int iret
int idistance
dec dbal
dec dtmp
dec dopwgt
dec dpcpoint = 0
dec dpcamt = 0
dec dbal2
date dtdate
string snm
string sfin

scode = trim(parent.dw_1.gettext())
sname = ""
scocode = ""
parent.bok = true
iret = 0
dbal = 0

if isnull(scode) then
	scode = ""
end if

select blocked 
into :sblocked
from accountm
where accode = :scode;

if sblocked = "Y" then
	messagebox("Blocked A/c","Customer is blocked...Sorry....",exclamation!,ok!)
	parent.dw_1.setfocus()
	parent.dw_1.settext("")
	parent.bok = false
	iret = 1

	return 1
end if

select name , addr1 , addr2 , ctype , cocode , mobile , panadhar , ( opweight + opdepwgtbal ) , tin , state , distance 
into :sname, :saddr1, :saddr2, :stype, :scocode, :smob, :span, :dopwgt, :stin, :sstate, :idistance
from clients
where code = :scode;

if sqlca.sqlcode <> 0 and &
		scode <> "" then
	parent.bok = false
	iret = 1
	messagebox("Error","Invalid Customer" + sqlca.sqlerrtext,exclamation!,ok!)
	parent.dw_1.settext("")
	parent.dw_1.setitem(1,1,"")
	parent.dw_1.setfocus()
else
	if scode <> "" then
		select code 
		into :scode2
		from clients_kuridet
		where custlinkac = :scode;

		if isnull(scode2) then
			scode2 = ""
		end if

		if stype = "J" then
			parent.bijewl = true
		else
			parent.bijewl = false
		end if

		if profilestring(gsinifile,"Software","ShowOldBalance","N") = "Y" then
			select menuitem 
			into :snm
			from userd
			where code = :gsuserid and
			menuitem ='NOPARTYBALINSEMI';

			if sqlca.sqlcode = 0 and &
					gilevel = 1 then
			else
				select menuitem 
				into :snm
				from userd
				where code = :gsuserid and
				menuitem ='NOSTAFFBAL';

				if sqlca.sqlcode <> 0 or &
						stype <> "F" then
					dtdate = date(parent.em_date.text)
					dopwgt = 0
					dtmp = 0

					select sum ( weight ) 
					into :dtmp
					from wgtrcptpmnt
					where pcode = :scode and
					control <=  :gisemi and
					tdate <=  :dtdate and
					ttype ='R';

					if isnull(dtmp) then
						dtmp = 0
					end if

					dopwgt += dtmp

					select sum ( weight ) 
					into :dtmp
					from wgtrcptpmnt
					where pcode = :scode and
					control <=  :gisemi and
					tdate <=  :dtdate and
					ttype ='P';

					if isnull(dtmp) then
						dtmp = 0
					end if

					dopwgt -= dtmp
					dtmp = 0

					if gisemi = 1 then
						select finished , opwgt 
						into :sfin, :dtmp
						from clients_kuridet
						where code = :scode;
					else
						select finished , opwgtb 
						into :sfin, :dtmp
						from clients_kuridet
						where code = :scode;
					end if

					if isnull(dtmp) then
						dtmp = 0
					end if

					if sfin = "Y" then
						dopwgt += dtmp
						dtmp = 0

						select sum ( wgt ) 
						into :dtmp
						from kuricolln
						where code = :scode;

						if isnull(dtmp) then
							dtmp = 0
						end if

						dopwgt += dtmp
					end if

					if parent.saded = "E" then
						dbal = acbalance2(scode,parent.lislno)
					else
						dbal = acbalance2(scode,0)
					end if
				end if

				if abs(dbal) > 0 then
					parent.em_ob.text = string((-dbal))
				else
					parent.em_ob.text = ""
				end if

				parent.em_opwgt.text = string(dopwgt)
				parent.balcalc(0)
			end if

			if scode2 <> "" then
				if parent.saded = "E" then
					dbal2 = acbalance2(scode2,parent.lislno)
				else
					dbal2 = acbalance2(scode2,0)
				end if
			end if

			parent.st_schemebal.text = string(dbal2,"#######0.00")
		end if

		dtdate = date(parent.em_date.text)
		prevcardcalc(scode,dtdate,parent.lislno,ref dpcpoint,ref dpcamt)
	end if
end if

if isnull(scocode) then
	scocode = ""
end if

if saddr2 <> "" and &
		saddr1 <> "" then
	saddr1 = saddr1 + ", " + saddr2
end if

parent.st_custname.text = sname
parent.sle_addr.text = saddr1
parent.sle_mobno.text = smob
parent.sle_pan.text = span
parent.sle_tin.text = stin
parent.em_distance.text = string(idistance)

if isnull(sstate) or &
		sstate = "" then
else
	parent.dw_state.setitem(1,1,sstate)
end if

parent.em_ob.text = string((-dbal))
parent.st_pcardpoints.text = string(dpcpoint)
parent.st_pcardamt.text = string(dpcamt)
parent.dw_co.settext(scocode)

return iret
end event

event itemerror;
return 1
end event

event losefocus;
this.accepttext()
end event

event getfocus;
parent.bok = true
end event

type em_rate8gm from editmask within w_sales
integer x = 3685
integer y = 92
integer width = 421
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "####0.00"
string displaydata = ""
end type

type st_2 from statictext within w_sales
integer x = 3410
integer y = 104
integer width = 274
integer height = 68
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Rate/8 gm"
boolean focusrectangle = false
end type

type em_rate from editmask within w_sales
integer x = 265
integer y = 96
integer width = 402
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "###0.00"
string displaydata = ""
end type

type st_1 from statictext within w_sales
integer x = 5
integer y = 100
integer width = 256
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Rate/gm"
boolean focusrectangle = false
end type

type cb_delete from commandbutton within w_sales
integer x = 256
integer y = 1180
integer width = 229
integer height = 80
integer taborder = 490
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "&Delete"
end type

event clicked;int ircount
int icrow
string sitem

ircount = parent.dw_sale.rowcount()

if ircount > 0 then
	icrow = parent.dw_sale.getrow()
	sitem = parent.dw_sale.getitemstring(icrow,1)

	if isnull(sitem) then
		parent.dw_sale.deleterow(0)
		parent.dw_sale.setfocus()
	else
		if messagebox("Warning","You are going to delete the item " + sitem & 
				+ " Please confirm...",exclamation!,okcancel!) = 1 then
			parent.dw_sale.deleterow(0)
			parent.dw_sale.setfocus()
		end if
	end if
end if
end event

type em_rcvd from editmask within w_sales
integer x = 2235
integer y = 1520
integer width = 393
integer height = 84
integer taborder = 260
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = right!
string mask = "########.00"
string displaydata = ""
end type

event losefocus;
this.backcolor = rgb(255,255,255)
parent.balcalc(0)
end event

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event modified;dec dbamt
dec dtaxperc
dec ddisc
dec drcvd
dec dnet
dec dtaxamt
dec dttaxperc
dec dast
dec dnbamt

if parent.sitaxafterdisc = "Y" and &
		parent.cbx_credit.checked = false and &
		profilestring(gsinifile,"Software","BalRcvdToDiscount","N") = "Y" then
	dbamt = dec(parent.em_billtotal.text)
	drcvd = dec(parent.em_rcvd.text)
	dnet = dec(parent.em_nettot.text)
	dtaxamt = dec(parent.em_staxamt.text)
	dast = dec(parent.em_ast.text)
	dnbamt = dbamt - dec(parent.em_exchange.text) - dec(parent.em_sreturn.text)
	dtaxperc = dec(parent.em_taxperc.text)

	if dtaxperc > 0 then
		dttaxperc = dtaxperc

		if parent.cbx_cst.checked = false then
			dttaxperc += gdastperc
		end if

		ddisc = (dnbamt + (dttaxperc * dbamt) / 100 - drcvd) / (1 + dttaxperc / 100)
		dtaxamt = ((dbamt - ddisc) * dtaxperc) / 100

		if parent.cbx_cst.checked = false then
			dast = ((dbamt - ddisc) * gdastperc) / 100
		end if
	else
		ddisc = dnet - drcvd
	end if

	parent.em_discount.text = string(round(ddisc,0))

	if dbamt > 0 then
		parent.em_dperc.text = string((round(ddisc,0) * 100) / dbamt)
	end if

	parent.em_staxamt.text = string(dtaxamt)
	parent.em_ast.text = string(dast)
	parent.balcalc(0)
end if
end event

type st_rcvd from statictext within w_sales
integer x = 1934
integer y = 1528
integer width = 270
integer height = 64
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Tot.Rcvd"
boolean focusrectangle = false
end type

type em_balance from editmask within w_sales
integer x = 3694
integer y = 1520
integer width = 453
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "#########.00"
end type

type st_balance from statictext within w_sales
integer x = 3401
integer y = 1528
integer width = 288
integer height = 64
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Balance"
boolean focusrectangle = false
end type

type em_nettot from editmask within w_sales
integer x = 3694
integer y = 1432
integer width = 453
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "#########.00"
end type

type st_nettot from statictext within w_sales
integer x = 3401
integer y = 1440
integer width = 288
integer height = 84
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Net Total"
boolean focusrectangle = false
end type

type em_exchange from editmask within w_sales
integer x = 2235
integer y = 1344
integer width = 393
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "#####0.00"
end type

type st_exchange from statictext within w_sales
integer x = 1934
integer y = 1352
integer width = 270
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Exchange"
boolean focusrectangle = false
end type

type em_discount from editmask within w_sales
integer x = 471
integer y = 1520
integer width = 325
integer height = 84
integer taborder = 240
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = right!
string mask = "#######.00"
string displaydata = ""
end type

event losefocus;
this.backcolor = rgb(255,255,255)
parent.balcalc(1)
end event

event getfocus;
this.selecttext(1,len(this.text))
this.backcolor = rgb(255,150,0)
end event

event modified;dec ddisc
dec dbamt
dec dtax
dec dast
dec dtaxperc
dec dastperc

dbamt = dec(parent.em_billtotal.text)
ddisc = dec(parent.em_discount.text)
dtaxperc = dec(parent.em_taxperc.text)
dastperc = dec(parent.em_astperc.text)
dtax = dec(parent.em_staxamt.text)

if dtax > 0 then
	if parent.sitaxafterdisc = "Y" then
		dtax = ((dbamt - ddisc) * dtaxperc) / 100

		if profilestring(gsinifile,"Software","CessIsBasedOnBillAmt","Y") = "Y" then
			dast = ((dbamt - ddisc) * dastperc) / 100
		else
			dast = (dtax * dastperc) / 100
		end if

		dtax = round(dtax,2)
		dast = round(dast,2)
		parent.em_staxamt.text = string(dtax)
		parent.em_ast.text = string(dast)
	end if
end if

if dbamt > 0 then
	parent.em_dperc.text = string((dec(parent.em_discount.text) * 100) / dbamt)
end if

parent.evacalc()
parent.balcalc(1)
end event

type st_discount from statictext within w_sales
integer y = 1524
integer width = 315
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Discount"
boolean focusrectangle = false
end type

type em_billtotal from editmask within w_sales
integer x = 343
integer y = 1344
integer width = 453
integer height = 84
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
alignment alignment = right!
boolean displayonly = true
string mask = "#########.00"
string displaydata = ""
end type

type st_billtotal from statictext within w_sales
integer y = 1352
integer width = 315
integer height = 68
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Bill Total"
boolean focusrectangle = false
end type

type st_custcode from statictext within w_sales
integer x = 5
integer y = 200
integer width = 256
integer height = 76
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Customer"
boolean focusrectangle = false
end type

type em_date from editmask within w_sales
integer x = 3685
integer width = 421
integer height = 80
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
alignment alignment = center!
maskdatatype maskdatatype = datemask!
string mask = "dd/mm/yyyy"
string displaydata = ""
end type

event constructor;//Omitted: the default "return"
end event

event getfocus;
this.backcolor = rgb(255,150,0)
end event

event losefocus;
this.backcolor = rgb(255,255,255)
end event

type st_date from statictext within w_sales
integer x = 3410
integer y = 12
integer width = 274
integer height = 64
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Date"
boolean focusrectangle = false
end type

type st_bill from statictext within w_sales
integer x = 5
integer y = 16
integer width = 256
integer height = 56
integer textsize = -9
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean enabled = false
string text = "Bill No"
boolean focusrectangle = false
end type

type cb_exit from commandbutton within w_sales
integer x = 4434
integer y = 1616
integer width = 485
integer height = 84
integer taborder = 520
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "E&xit"
end type

event clicked;
if messagebox("Exit","You want to exit ? ",question!,yesno!,1) = 1 then
	icount -= 1
	close(parent)
end if
end event

type cb_save from commandbutton within w_sales
event ue_wsadd pbm_custom01
integer x = 4434
integer y = 1532
integer width = 485
integer height = 84
integer taborder = 470
integer textsize = -10
integer weight = 700
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string pointer = "handapst.ani"
string text = "&Save "
end type

event clicked;long lslno
int icount2
int icontrol
string stmp
string scode
string scbcode
dec dtdmdamt = 0
dec dtdmdwgt = 0
dec dadisc
dec dtwgt
dec dmaxdisc
dec ddisc
dec ddperc
dec dbamt
string snm
dec dmaxcredit
dec damt
dec damt2
string stell
dec dnetamt
dec dbal
dec damt11
string smobile
string smsg
string sparm

if gsro2 = "Y" then
	messagebox("Sorry...","You are not permited to enter Details. Only to view..~nSorry.......",stopsign!,ok!)

	return
else
	if gsro = "Y" and &
			parent.saded = "A" then
		messagebox("Sorry...","You are not permited to enter new sales in this computer.~nYou can edit or cancel sales but not new entry...~nSorry.......",stopsign!,ok!)

		return
	end if
end if

if chkdate(date(parent.em_date.text)) = false then
	return
end if

if trim(parent.dw_smcode.gettext()) = "" and &
		gsids = "Nj" then
	messagebox("Warning","Enter Sales Man ...",stopsign!,ok!)
	parent.dw_smcode.setfocus()
	parent.cb_save.enabled = true

	return
end if

if trim(parent.dw_smcode.gettext()) = "" and &
		profilestring(gsinifile,"Software","SMCompulsary","N") = "Y" then
	messagebox("Warning","SM Code empty. You can't save...")
	parent.dw_smcode.setfocus()
	parent.cb_save.enabled = true

	return
end if

if (trim(parent.st_custname.text) = "" or &
		trim(parent.sle_addr.text) = "" or &
		trim(parent.sle_mobno.text) = "") and &
		profilestring(gsinifile,"Software","CustNameAddrCompulsary","N") = "Y" then
	messagebox("Warning","Customer Name,Addr,Mobile are compulsory. You can't save...")
	parent.st_custname.setfocus()
	parent.cb_save.enabled = true

	return
end if

scbcode = trim(parent.dw_cashbank.getitemstring(1,1))
scode = trim(parent.dw_1.gettext())

if scode <> "" then
	select name 
	into :stmp
	from clients
	where code = :scode;

	if sqlca.sqlcode <> 0 then
		messagebox("Warning","Invalid Customer Code. You can't save...")
		parent.dw_1.setfocus()
		parent.cb_save.enabled = true

		return
	end if
end if

if parent.cbx_manual.checked and &
		trim(parent.st_billno.text) = "" then
	messagebox("Empty Bill No","Check Bill No.~nYou can't Contunue..~nSorry.......",stopsign!,ok!)
	parent.st_billno.setfocus()
	parent.cb_save.enabled = true

	return
end if

ddisc = dec(parent.em_discount.text)

if ddisc > 0 then
	select maxdisc 
	into :dmaxdisc
	from userm
	where code = :gsuserid;

	if isnull(dmaxdisc) then
		dmaxdisc = 0
	end if

	if dmaxdisc > 0 then
		dtwgt = parent.dw_sale.getitemdecimal(1,"twgt")
		dadisc = round(dtwgt * dmaxdisc,0)

		if ddisc > dadisc then
			messagebox("Sorry","Discount is more than allowed amt.~nYou can't Contunue..~nSorry.......",stopsign!,ok!)
			parent.em_discount.setfocus()
			parent.cb_save.enabled = true

			return
		end if
	end if

	dbamt = dec(parent.em_billtotal.text)

	if parent.dimaxdiscperc > 0 and &
			dbamt > 0 then
		ddperc = (ddisc * 100) / dbamt

		if ddperc > parent.dimaxdiscperc then
			messagebox("Sorry","Discount is more than allowed amt.~nYou can't Contunue..~nSorry.......",stopsign!,ok!)
			parent.em_discount.setfocus()
			parent.cb_save.enabled = true

			return
		end if
	end if
end if

if dec(parent.em_balance.text) > 0 then
	select menuitem 
	into :snm
	from userd
	where code = :gsuserid and
	menuitem ='CREDIT';

	if sqlca.sqlcode = 0 then
		messagebox("Sorry...","You are not permited to enter Credit in sales...~nSorry.......",stopsign!,ok!)
		parent.em_rcvd.setfocus()
		parent.cb_save.enabled = true

		return
	end if

	select maxcredit 
	into :dmaxcredit
	from userm
	where code = :gsuserid;

	if isnull(dmaxcredit) then
		dmaxcredit = 0
	end if

	if dec(parent.em_balance.text) > dmaxcredit and &
			dmaxcredit > 0 then
		messagebox("Sorry...","Credit is out of limit. ~nYou can't save.......",stopsign!,ok!)
		parent.em_rcvd.setfocus()
		parent.cb_save.enabled = true

		return
	end if

	if profilestring(gsinifile,"Software","CreditBillCoCompulsory","N") = "Y" then
		if trim(parent.dw_co.gettext()) = "" then
			messagebox("Sorry...","Credit bill without C/o Code. ~nYou can't save.......",stopsign!,ok!)
			parent.dw_co.setfocus()
			parent.cb_save.enabled = true

			return
		end if
	end if

	if profilestring(gsinifile,"Software","CheckCoPartyCreditLimit","N") = "Y" then
		scode = trim(parent.dw_co.gettext())

		select maxamt 
		into :damt2
		from copartylimit
		where code = :scode;

		if isnull(damt2) then
			damt2 = 0
		end if

		damt = copartybal(scode)
		damt = (-damt)

		if parent.saded = "A" then
			damt += dec(parent.em_balance.text)
		end if

		if damt > damt2 and &
				damt2 > 0 then
			messagebox("Sorry","C/o Party Maximum Credit limit exceeded. ~nYou can't  credit more...~nYou can't save....",stopsign!)
			parent.cb_save.enabled = true

			return
		end if
	end if
end if

if gisound = 1 then
	dnetamt = dec(parent.em_nettot.text)
	dbal = dec(parent.em_balance.text)
	stell = "Net, Amount, "

	if profilestring(gsinifile,"Sound","AmtToStr","N") = "Y" then
		stell += stramount2(dnetamt)

		if dbal > 0 then
			stell = stell + ". Balance, " + stramount2(dbal)
		end if
	else
		stell += amttotext(dnetamt)

		if dbal > 0 then
			stell = stell + ". Balance, " + amttotext(dbal)
		end if
	end if

	stell = stell + ". OK?"
	speak(stell)
end if

if dec(parent.em_ccamt.text) + dec(parent.em_chqamt.text) > 0 and &
		scbcode = "CASH" then
	messagebox("Sorry...","Please select bank account for card/cheque payment...~nSorry.......",stopsign!,ok!)
	parent.cb_save.enabled = true

	return
end if

damt11 = dec(parent.em_rcvd.text) - dec(parent.em_ccamt.text) - dec(parent.em_chqamt.text)
amtchk(damt11,"R")

if (profilestring(gsinifile,"Software","ShortPrintOnly","N") = "Y" or &
		profilestring(gsinifile,"Software","EstimateConfirmModel","N") = "Y") and &
		(parent.seb = "E" or &
		profilestring(gsinifile,"Software","ConfirmAll","N") = "Y") then
	lslno = parent.saveproc("T")
else
	lslno = parent.saveproc("S")
end if

if lslno = 0 then
	parent.cb_save.enabled = true

	return
end if

if profilestring(gsinifile,"Software","SalesFirstPrint","") = "Thermal" then
	if lslno > 0 then
		parent.dw_print.retrieve(lslno)

		if profilestring(gsinifile,"Software","ThermalPrinter","") <> "" then
			parent.dw_print.object.datawindow.printer = profilestring(gsinifile,"Software","ThermalPrinter","")
		end if

		if messagebox("Print?","Print Start ?",question!,yesno!,1) = 1 then
			parent.dw_print.print()
		end if

		if profilestring(gsinifile,"Software","ThermalPrintNos","1") = "2" then
			if messagebox("Print 2nd ?","Print 2nd Start ?",question!,yesno!,1) = 1 then
				parent.dw_print.print()
			end if
		end if
	end if
else
	if lslno > 0 then
		if parent.cbx_loan.checked then
			openwithparm(w_loanentry,lslno)
		end if

		select sum ( dmdamt ) , sum ( dmdwgt ) 
		into :dtdmdamt, :dtdmdwgt
		from spdmddet
		where slno = :lslno;

		if parent.cbx_laserprint.checked then
			if (dtdmdamt > 0 or &
					dtdmdwgt > 0) and &
					profilestring(gsinifile,"Software","DmdPrintGraphics","N") = "Y" and &
					profilestring(gsinifile,"Software","DmdPrintForm","") <> "GST" then
				openwithparm(w_diamond_sales_print,lslno)
			else
				openwithparm(w_sales_view,lslno)
			end if
		else
			if (profilestring(gsinifile,"Software","SP","N") = "Y" or &
					profilestring(gsinifile,"Software","ShortPrintOnly","N") = "Y") and &
					parent.seb = "E" then
				if messagebox("Short Print","Do you want Short print ?",question!,yesno!,2) = 1 then
					parent.cb_short.triggerevent(clicked!)
				end if

				if profilestring(gsinifile,"Software","FullPrint","Y") = "Y" or &
						parent.seb = "B" then
					if profilestring(gsinifile,"Software","SalesBillPrintForm","") = "Avathar" and &
							parent.seb = "B" then
						salesprint_avathar(lslno,1)
					else
						if profilestring(gsinifile,"Software","PrintDosType","N") = "Y" then
							salesprint_dos(lslno,1,1)
						else
							salesprint(lslno,1,1)
						end if
					end if
				end if
			else
				salesprint_func(lslno)
			end if
		end if
	end if
end if

if gsshowfbdiff = "Y" and &
		giaccount = 2 and &
		lslno > 0 then
	showfbstkdiff()
end if

if profilestring(gsinifile,"Software","CCareSupport","N") = "Y" and &
		parent.cbx_sendsms.checked and &
		lslno > 0 then
	smobile = trim(parent.sle_mobno.text)

	if smobile = "" then
		select mobile 
		into :smobile
		from clients
		where code = :scode;
	end if

	if isnull(smobile) then
		smobile = ""
	end if

	if smobile <> "" then
		smsg = profilestring(gsinifile,"Software","SmsMsgSales","")
		sparm = "[BillNo]"

		if pos(smsg,sparm) > 0 then
			smsg = replace(smsg,pos(smsg,sparm),len(sparm),parent.st_billno.text)
		end if

		sparm = "[PartyName]"

		if pos(smsg,sparm) > 0 then
			smsg = replace(smsg,pos(smsg,sparm),len(sparm),parent.st_custname.text)
		end if

		sparm = "[NetAmt]"

		if pos(smsg,sparm) > 0 then
			smsg = replace(smsg,pos(smsg,sparm),len(sparm),parent.em_netamt.text)
		end if

		sparm = "[RcvdAmt]"

		if pos(smsg,sparm) > 0 then
			smsg = replace(smsg,pos(smsg,sparm),len(sparm),parent.em_rcvd.text)
		end if

		sparm = "[OB]"

		if pos(smsg,sparm) > 0 then
			smsg = replace(smsg,pos(smsg,sparm),len(sparm),parent.em_ob.text)
		end if

		sparm = "[CB]"

		if pos(smsg,sparm) > 0 then
			smsg = replace(smsg,pos(smsg,sparm),len(sparm),parent.em_netbalance.text)
		end if

		if smsg = "" then
			smsg = smobile + "|Thank You for shopping..."
		else
			smsg = smobile + "|" + smsg
		end if

		smsg += profilestring(gsinifile,"Software","SmsMsgFooter","")
		sendmsgtoccare(smsg)
	end if
end if

if parent.saded = "E" then
	close(parent)

	return
end if

parent.initsalemodule()
parent.cb_save.enabled = true
parent.dw_1.setfocus()

return
end event

type cb_add from commandbutton within w_sales
integer x = 27
integer y = 1180
integer width = 224
integer height = 80
integer taborder = 480
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "&Add"
end type

event clicked;
parent.addnew()
end event

type rr_1 from roundrectangle within w_sales
long linecolor = 255
integer linethickness = 9
long fillcolor = 12639424
integer x = 4416
integer y = 1344
integer width = 512
integer height = 560
integer cornerheight = 41
integer cornerwidth = 42
end type

type st_retamt_m from statictext within w_sales
boolean visible = false
integer x = 3401
integer y = 1360
integer width = 288
integer height = 56
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "aSw :"
boolean focusrectangle = false
end type

type st_netamt_m from statictext within w_sales
boolean visible = false
integer x = 3401
integer y = 1448
integer width = 288
integer height = 76
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "samw XpI :"
boolean focusrectangle = false
end type

type st_balance_m from statictext within w_sales
boolean visible = false
integer x = 3401
integer y = 1528
integer width = 288
integer height = 68
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "_mn :"
boolean focusrectangle = false
end type

type st_duedate_m from statictext within w_sales
boolean visible = false
integer x = 3401
integer y = 1616
integer width = 288
integer height = 76
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "U} tUv :"
boolean focusrectangle = false
end type

type st_rcvdamt_m from statictext within w_sales
boolean visible = false
integer x = 1934
integer y = 1528
integer width = 270
integer height = 76
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "InnbXv :"
boolean focusrectangle = false
end type

type st_exchamt_m from statictext within w_sales
boolean visible = false
integer x = 1934
integer y = 1352
integer width = 270
integer height = 100
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "]gbXv :"
boolean focusrectangle = false
end type

type st_billamt_m from statictext within w_sales
boolean visible = false
integer y = 1352
integer width = 315
integer height = 76
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "XpI :"
boolean focusrectangle = false
end type

type st_taxamt_m from statictext within w_sales
boolean visible = false
integer y = 1448
integer width = 315
integer height = 76
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "SmIvkv :"
boolean focusrectangle = false
end type

type st_discount_m from statictext within w_sales
boolean visible = false
integer y = 1532
integer width = 315
integer height = 76
integer textsize = -12
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "Unkvuv :"
boolean focusrectangle = false
end type

type st_grategm_m from statictext within w_sales
boolean visible = false
integer x = 9
integer y = 112
integer width = 247
integer height = 76
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "kzhne :"
boolean focusrectangle = false
end type

type st_customer_m from statictext within w_sales
boolean visible = false
integer x = 9
integer y = 204
integer width = 288
integer height = 76
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "Ikva :"
boolean focusrectangle = false
end type

type st_date_m from statictext within w_sales
boolean visible = false
integer x = 3410
integer y = 16
integer width = 274
integer height = 76
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "Znhkw :"
boolean focusrectangle = false
end type

type st_gratepavan_m from statictext within w_sales
boolean visible = false
integer x = 3410
integer y = 112
integer width = 274
integer height = 76
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "]hhne :"
boolean focusrectangle = false
end type

type st_smname_m from statictext within w_sales
boolean visible = false
integer x = 3410
integer y = 204
integer width = 274
integer height = 68
integer textsize = -10
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = decorative!
string facename = "ML-Karthika"
long backcolor = 12632256
boolean enabled = false
string text = "tkevkvam :"
boolean focusrectangle = false
end type

type dw_sale from datawindow within w_sales
event uedkey pbm_dwnkey
integer x = 14
integer y = 376
integer width = 5257
integer height = 964
integer taborder = 130
string dataobject = "d_sale"
boolean vscrollbar = true
boolean livescroll = true
end type

event uedkey;string sobject
string stype
string skdm
string scolname[]  = {"itemcode","itemname","qty","weight","stonewgt","stoneprice","wastage","mcharge","amount","rate"}
int icolact[]  = {1,0,1,1,1,1,1,1,1,1,1,1,0,1}
int inumber
int icolno
int i
string scolnm
string scode
string sjcode
string sname
string scolr
int irow
int ifr
dec dmcharge
dec drate = 0
dec dvaperc
dec dweight
dec dstonewgt
dec dnetwgt
dec dmcperc = 0
dec dstwgt = 0
string srmno
string sstkfd
string sret
string scode1
string scode2
string stype3
str_wstgcalc str_wstg
dec dwstge = 0
long lbcode3
str_itemadj stradj
dec dwgt2
int irow2
int itrow2
dec dtmp2
dec dtmp3
dec dvap2
long lbcode5
str_mccalc str_mc
str_dmddet strdmddet
dec dmc
dec dtmp
dec dwstg
str_mccalc strva
int iret
string sstkinnos
string stype7
long lbcode
string scode3
string stype4
string sstktype
string sqtype
string sparm
string srmno2
string sstkfd2
string sret2
string stype6

parent.bdone = false
sobject = this.classname()

if key = keyf9! then
	if profilestring(gsinifile,"Software","SalesF9ToRcvdAmt","N") = "Y" then
		parent.em_rcvd.setfocus()
	else
		parent.em_discount.setfocus()
	end if
else
	if key = keyf5! then
		this.triggerevent(losefocus!)
		parent.cb_exchange.postevent(clicked!)
		parent.bchkentry = true
	else
		if key = keyf12! then
			scolnm = this.getcolumnname()

			if scolnm = "weight" and &
					parent.siuserbccompulsory = "N" then
				dweight = getwgtfromwm()

				if dweight > 0 then
					this.setitem(this.getrow(),"weight",dweight)
				end if
			else
				parent.stktypechk()
			end if
		else
			if key = keyf6! then
				this.triggerevent(losefocus!)
				parent.cb_sreturn.postevent(clicked!)
				parent.bchkentry = true
			else
				if key = keyf7! then
					parent.bchkentry = false
					scolnm = this.getcolumnname()

					if scolnm = "mcharge" then
						if parent.siuserbccompulsory = "N" then
							irow = this.getrow()
							open(w_mcharge_perc)
							dmcperc = message.doubleparm

							if dmcperc <> 0 then
								dweight = this.getitemnumber(irow,"weight")
								dstwgt = this.getitemnumber(irow,"stonewgt")
								drate = this.getitemnumber(irow,"rate")

								if isnull(dweight) then
									dweight = 0
								end if

								if isnull(dstwgt) then
									dstwgt = 0
								end if

								if isnull(drate) then
									drate = 0
								end if

								dweight -= dstwgt

								if dweight < 0 then
									dweight = 0
								end if

								dmcharge = (dweight * drate * dmcperc) / 100

								if isnull(dmcharge) then
									dmcharge = 0
								end if

								this.setitem(irow,"mcharge",dmcharge)
								this.setitem(irow,"wastage",0)
								this.postevent(itemchanged!)
							end if
						end if
					else
						if giaccount = 2 then
							if parent.cbx_updtfr.visible then
								irow = this.getrow()
								srmno = this.getitemstring(irow,"rmno")
								sstkfd = this.getitemstring(irow,"stkfd")

								if isnull(srmno) then
									srmno = ""
								end if

								if isnull(sstkfd) then
									sstkfd = "N"
								end if

								sret = srmno + "|" + sstkfd
								openwithparm(w_rmno,sret)
								sret = message.stringparm

								if sret <> "" then
									srmno = left(sret,pos(sret,"|") - 1)
									sstkfd = mid(sret,pos(sret,"|") + 1,1)
									this.setitem(irow,"rmno",srmno)
									this.setitem(irow,"stkfd",sstkfd)
								end if
							end if
						end if
					end if

					parent.bchkentry = true
				else
					if key = keyf1! then
						parent.bchkentry = false
						scolnm = this.getcolumnname()

						if scolnm = "itemcode" and &
								parent.siuserbccompulsory = "N" then
							openwithparm(w_itemhelp,this.gettext())
							scode1 = message.stringparm

							if scode1 <> "" then
								this.setitem(this.getrow(),"itemcode",scode1)
								this.postevent(itemchanged!)
							end if
						else
							if scolnm = "itemname" then
								scode2 = this.getitemstring(this.getrow(),"itemcode")

								if isnull(scode2) then
									scode2 = ""
								end if

								openwithparm(w_itemtmphelp,scode2)
								scode2 = message.stringparm
								stype3 = ""

								if scode2 <> "" then
									if pos(scode2,"|") > 0 then
										stype3 = mid(scode2,pos(scode2,"|") + 1,10)
										scode2 = left(scode2,pos(scode2,"|") - 1)
									end if

									this.setitem(this.getrow(),"iqtype",stype3)
									this.setitem(this.getrow(),"itemname",scode2)
								end if
							else
								if scolnm = "wastage" and &
										parent.siuserbccompulsory = "N" then
									if keyflags = 1 then
										drate = this.getitemdecimal(this.getrow(),"wstgrate")
										openwithparm(w_wstgmclist,"W|" + string(drate,"####0.00"))
									else
										irow = this.getrow()
										str_wstg.weight = this.getitemnumber(irow,"weight")
										str_wstg.wstgrate = this.getitemnumber(irow,"wstgrate")
										str_wstg.stonewgt = this.getitemnumber(irow,"stonewgt")
										openwithparm(w_wastage,str_wstg)
										dwstge = message.doubleparm

										if dwstge <> 0 then
											this.setitem(this.getrow(),"Wastage",dwstge)
											this.postevent(itemchanged!)
										end if
									end if
								else
									if scolnm = "weight" and &
											parent.siitemadjinsales = "Y" then
										irow = this.getrow()
										dweight = this.getitemnumber(irow,"weight")

										if isnull(dweight) then
											dweight = 0
										end if

										stradj.code = this.getitemstring(irow,"adjitem")
										stradj.qty = this.getitemnumber(irow,"adjqty")
										stradj.weight = this.getitemnumber(irow,"adjwgt")
										stradj.fromto = this.getitemstring(irow,"adjtype")

										if isnull(stradj.weight) then
											stradj.weight = 0
										end if

										if isnull(stradj.fromto) then
											stradj.fromto = ""
										end if

										if stradj.fromto = "To" then
											stradj.totwgt = dweight + stradj.weight
										else
											if stradj.fromto = "From" then
												stradj.totwgt = dweight - stradj.weight
											else
												stradj.totwgt = dweight
											end if
										end if

										openwithparm(w_itemadjpopup,stradj)
										stradj = message.powerobjectparm
										this.setitem(irow,"adjitem",stradj.code)
										this.setitem(irow,"adjqty",stradj.qty)
										this.setitem(irow,"adjwgt",stradj.weight)
										this.setitem(irow,"adjtype",stradj.fromto)

										if stradj.fromto = "To" then
											dweight = stradj.totwgt
										else
											if stradj.fromto = "From" then
												dweight = stradj.totwgt
											end if
										end if

										this.setitem(irow,"weight",dweight)
										lbcode3 = this.getitemnumber(irow,"bcode")

										if lbcode3 > 0 then
											dstonewgt = this.getitemnumber(irow,"stonewgt")
											drate = this.getitemnumber(irow,"rate")

											select weight , vap 
											into :dwgt2, :dvaperc
											from barcode
											where bcode = :lbcode3;

											if dweight <> dwgt2 then
												if dvaperc > 0 then
													dmcharge = round(((dweight - dstonewgt) * drate * dvaperc) / 100,0)
													this.setitem(irow,"mcharge",dmcharge)
												end if
											end if
										end if

										parent.st_itemadj.text = trim(stradj.code) + " " + trim(string(stradj.qty,"###")) & 
												+ "/" & 
												+ trim(string(stradj.weight,"####.###"))
										this.postevent(itemchanged!)
									else
										if scolnm = "mcharge" and &
												parent.siuserbccompulsory = "N" then
											irow = this.getrow()

											if keyflags = 1 then
												drate = this.getitemdecimal(this.getrow(),"mcrate")
												openwithparm(w_wstgmclist,"M|" + string(drate,"####0.00"))
											else
												if parent.sivamodel = "Y" then
													dvaperc = this.getitemnumber(irow,"vaperc")
													gsgenparm = ""
													openwithparm(w_vaperc,dvaperc)
													dvaperc = message.doubleparm

													if left(gsgenparm,3) = "All" then
														dtmp2 = dec(mid(gsgenparm,4,10))
													else
														if gsgenparm <> "" then
															dtmp2 = dec(gsgenparm)
														else
															dtmp2 = 0
														end if
													end if

													if dvaperc <> 0 or &
															dtmp2 <> 0 then
														if left(gsgenparm,3) = "All" then
															itrow2 = this.rowcount()
															irow2 = 1

															do while irow2 <= itrow2
																dweight = this.getitemnumber(irow2,"weight")
																drate = this.getitemnumber(irow2,"rate")
																dstonewgt = this.getitemnumber(irow2,"stonewgt")
																dmcharge = this.getitemnumber(irow2,"mcharge")
																lbcode5 = this.getitemnumber(irow2,"bcode")

																if isnull(dweight) then
																	dweight = 0
																end if

																if isnull(drate) then
																	drate = 0
																end if

																if isnull(dstonewgt) then
																	dstonewgt = 0
																end if

																if isnull(dmcharge) then
																	dmcharge = 0
																end if

																if isnull(lbcode5) then
																	lbcode5 = 0
																end if

																if lbcode5 > 0 then
																	select vap 
																	into :dvap2
																	from barcode
																	where bcode = :lbcode5;

																	if dvaperc < dvap2 then
																		dtmp2 = 0
																		dvaperc = dvap2
																	end if
																end if

																dnetwgt = dweight - dstonewgt

																if dtmp2 <> 0 then
																	if dnetwgt > 0 then
																		dtmp3 = (dmcharge * 100) / (dnetwgt * drate)
																		dtmp3 += dtmp2

																		if lbcode5 > 0 and &
																				dtmp3 < dvap2 then
																		else
																			dmcharge = (dnetwgt * drate * dtmp3) / 100
																			dvaperc = dtmp3
																		end if
																	end if
																else
																	dmcharge = (dnetwgt * drate * dvaperc) / 100
																end if

																this.setitem(irow2,"vaperc",dvaperc)
																this.setitem(irow2,"mcharge",dmcharge)
																this.setrow(irow2)
																this.triggerevent(itemchanged!)
																irow2 ++
															loop

															this.setrow(irow)
														else
															dweight = this.getitemnumber(irow,"weight")
															drate = this.getitemnumber(irow,"rate")
															dstonewgt = this.getitemnumber(irow,"stonewgt")
															lbcode5 = this.getitemnumber(irow,"bcode")

															if isnull(dweight) then
																dweight = 0
															end if

															if isnull(drate) then
																drate = 0
															end if

															if isnull(dstonewgt) then
																dstonewgt = 0
															end if

															if isnull(lbcode5) then
																lbcode5 = 0
															end if

															if lbcode5 > 0 then
																select vap 
																into :dvap2
																from barcode
																where bcode = :lbcode5;

																if dvaperc < dvap2 then
																	dvaperc = dvap2
																end if
															end if

															dnetwgt = dweight - dstonewgt
															dmcharge = (dnetwgt * drate * dvaperc) / 100
															this.setitem(this.getrow(),"vaperc",dvaperc)
															this.setitem(this.getrow(),"mcharge",dmcharge)
															this.postevent(itemchanged!)
														end if
													end if
												else
													dstonewgt = this.getitemnumber(irow,"stonewgt")
													dweight = this.getitemnumber(irow,"weight")

													if isnull(dstonewgt) then
														dstonewgt = 0
													end if

													str_mc.weight = dweight - dstonewgt
													str_mc.mcrate = this.getitemnumber(irow,"mcrate")
													openwithparm(w_mcharge,str_mc)
													dmcharge = message.doubleparm

													if dmcharge <> 0 then
														this.setitem(this.getrow(),"mcharge",dmcharge)
														this.postevent(itemchanged!)
													end if
												end if
											end if
										end if
									end if
								end if
							end if
						end if

						parent.bchkentry = true
					else
						if key = keyf11! then
							irow = this.getrow()
							strdmddet.dmdnos = this.getitemnumber(irow,"dmdnos")
							strdmddet.dmdwgt = this.getitemnumber(irow,"dmdwgt")
							strdmddet.dmdunit = this.getitemstring(irow,"dmdunit")
							strdmddet.dmdamt = this.getitemnumber(irow,"dmdamt")
							strdmddet.barcode = this.getitemnumber(irow,"bcode")
							strdmddet.va = this.getitemnumber(irow,"mcharge")
							openwithparm(w_dmdpopup,strdmddet)
							strdmddet = message.powerobjectparm
							this.setitem(irow,"dmdnos",strdmddet.dmdnos)
							this.setitem(irow,"dmdwgt",strdmddet.dmdwgt)
							this.setitem(irow,"dmdunit",strdmddet.dmdunit)
							this.setitem(irow,"dmdamt",strdmddet.dmdamt)
							this.setitem(irow,"mcharge",strdmddet.va)
							this.postevent(itemchanged!)
						else
							if key = keyf8! then
								scolnm = this.getcolumnname()

								if scolnm = "wastage" or &
										scolnm = "mcharge" then
									if parent.siuserbccompulsory = "N" then
										irow = this.getrow()
										drate = this.getitemnumber(irow,"rate")
										dmc = this.getitemnumber(irow,"mcharge")
										dwstg = this.getitemnumber(irow,"wastage")

										if isnull(drate) then
											drate = 0
										end if

										if isnull(dmc) then
											dmc = 0
										end if

										strva.weight = drate
										strva.mcrate = dmc
										strva.wastage = dwstg
										openwithparm(w_vachange,strva)
										strva = message.powerobjectparm

										if strva.wastage > 0 or &
												strva.mcrate > 0 then
											dwstg = strva.wastage
											dmc = strva.mcrate

											if isnull(dmc) then
												dmc = 0
											end if

											if isnull(dwstg) then
												dwstg = 0
											end if

											this.setitem(irow,"wastage",dwstg)
											this.setitem(irow,"mcharge",dmc)
										end if
									end if
								else
									if giaccount = 2 then
										if parent.cbx_updtfr.visible then
											ifr = this.getitemnumber(this.getrow(),"fr")

											if isnull(ifr) then
												ifr = 0
											end if

											if ifr = 0 then
												this.setitem(this.getrow(),"fr",1)
											else
												this.setitem(this.getrow(),"fr",0)
											end if
										end if
									end if
								end if
							else
								if key = keyenter! then
									parent.bdone = true
									scolnm = this.getcolumnname()
									icolno = this.getcolumn()
									scode = trim(this.gettext())
									parent.bok = true

									if parent.siws = "Y" then
										icolact[13] = 1
									end if

									if parent.sistoponmcp = "N" then
										icolact[9] = 0
									end if

									if parent.sistoponmodel = "N" then
										icolact[3] = 0
									end if

									irow = this.getrow()

									if scolnm = "mcharge" then
										if dec(this.gettext()) <= 0 and &
												(trim(this.gettext()) = "" or &
												trim(this.gettext()) = "0") then
											scode = trim(this.getitemstring(irow,"itemcode"))

											select itype 
											into :stype7
											from items
											where code = :scode;

											if stype7 = "G" then
												return 1
											end if
										end if
									end if

									if scolnm = "vaperc" then
										if dec(this.gettext()) > 0 then
											parent.addnew()

											return
										end if
									end if

									if scolnm = "itemcode" then
										if profilestring(gsinifile,"Software","StopOnItemName","N") = "Y" then
											icolact[2] = 1
										end if

										iret = 0

										if scode = "" then
											if profilestring(gsinifile,"Software","CodeEmptyGoToAmtPart","N") = "Y" then
												parent.em_rcvd.setfocus()

												return
											else
												parent.bok = false
											end if
										end if

										if parent.sibccompulsory = "Y" and &
												scode <> "" then
											this.triggerevent(itemchanged!)
										end if

										scode = trim(this.gettext())
										lbcode = this.getitemnumber(irow,"bcode")

										if isnull(lbcode) then
											lbcode = 0
										end if

										if profilestring(gsinifile,"Software","AutoPopupTmpName","N") = "Y" and &
												scode <> "" then
											select count ( name ) 
											into :icount
											from itemstmp
											where code = :scode;

											if icount > 0 then
												openwithparm(w_itemtmphelp,scode)
												scode3 = message.stringparm
												stype4 = ""

												if scode3 <> "" then
													if pos(scode3,"|") > 0 then
														stype4 = mid(scode3,pos(scode3,"|") + 1,10)
														scode3 = left(scode3,pos(scode3,"|") - 1)
													end if

													if stype4 <> "" then
														this.setitem(this.getrow(),"iqtype",stype4)
													end if

													this.setitem(irow,"itemname",scode3)
												else
													this.setcolumn("itemname")
													this.selecttext(20,0)
													parent.bok = false
												end if
											end if
										end if

										if profilestring(gsinifile,"Software","AutoPopupStktype","N") = "Y" and &
												scode <> "" and &
												lbcode = 0 then
											sstktype = this.getitemstring(irow,"stktype")
											sqtype = this.getitemstring(irow,"iqtype")

											if isnull(sstktype) then
												sstktype = ""
											end if

											if isnull(sqtype) then
												sqtype = ""
											end if

											sparm = sstktype

											if sqtype <> "" then
												sparm = sstktype + "|" + sqtype
											end if

											openwithparm(w_stktypeqtype,sparm)
											sparm = message.stringparm
											sstktype = ""
											sqtype = ""

											if pos(sparm,"|") > 0 then
												sstktype = left(sparm,pos(sparm,"|") - 1)
												sqtype = mid(sparm,pos(sparm,"|") + 1,10)
											else
												if sparm <> "" then
													sstktype = trim(sparm)
												end if
											end if

											if sparm <> "" then
												this.setitem(irow,"stktype",sstktype)
												this.setitem(irow,"iqtype",sqtype)
												parent.st_stktype.text = sstktype
												parent.st_kdm.text = sqtype
											end if
										end if

										if sstktype = "R" then
											srmno2 = this.getitemstring(this.getrow(),"rmno")
											sstkfd2 = this.getitemstring(this.getrow(),"stkfd")

											if isnull(srmno2) then
												srmno2 = ""
											end if

											if isnull(sstkfd2) then
												sstkfd2 = "N"
											end if

											sret2 = srmno2 + "|" + sstkfd2
											openwithparm(w_rmno,sret2)
											sret2 = message.stringparm

											if sret2 <> "" then
												srmno2 = left(sret2,pos(sret2,"|") - 1)
												sstkfd2 = mid(sret2,pos(sret2,"|") + 1,1)
												this.setitem(this.getrow(),"rmno",srmno2)
												this.setitem(this.getrow(),"stkfd",sstkfd2)
											end if
										end if
									else
										if scolnm = "jewlcode" then
											select name 
											into :sname
											from clients
											where trim ( code ) = :scode and
											ctype ='J';

											if sqlca.sqlcode <> 0 then
												if scode <> "" then
													messagebox("Error","Invalid jewellery",exclamation!,ok!)
													this.setitem(this.getrow(),"jewlcode","")
													this.accepttext()
												end if

												parent.bok = false
											end if
										end if
									end if

									if scolnm = "weight" then
										if dec(this.gettext()) = 0 then
											sstkinnos = parent.dw_sale.getitemstring(this.getrow(),"stkinnos")

											if sstkinnos <> "Y" then
												if messagebox("Warning","Weight is not entered. ~nDo you want to correct...",question!,yesno!,1) = 1 then
													parent.bok = false
												end if
											end if
										end if

										if parent.bok then
											stype = this.getitemstring(this.getrow(),"itemtype")

											if stype = "S" then
												if profilestring(gsinifile,"Software","GoToMcWstgInSilverSales","N") = "N" then
													parent.cb_add.postevent(clicked!)
												else
													if profilestring(gsinifile,"Software","StopOnStwgt","N") = "Y" then
														this.setcolumn("stonewgt")
													else
														if profilestring(gsinifile,"Software","StopOnWastage","N") = "Y" then
															this.setcolumn("wastage")
														else
															this.setcolumn("mcharge")
														end if
													end if
												end if

												this.setfocus()
											else
												if profilestring(gsinifile,"Software","StopOnStwgt","N") = "Y" then
													this.setcolumn("stonewgt")
												else
													if profilestring(gsinifile,"Software","StopOnWastage","N") = "Y" then
														this.setcolumn("wastage")
													else
														this.setcolumn("mcharge")
													end if
												end if

												this.setfocus()
											end if
										end if
									else
										if scolnm = "qty" then
											stype6 = this.getitemstring(this.getrow(),"itemtype")

											if dec(this.gettext()) = 0 and &
													stype6 = "G" then
												if profilestring(gsinifile,"Software","QtyWarning","Y") = "Y" then
													if messagebox("Warning","Qty is not entered. ~nDo you want to correct...",question!,yesno!,1) = 1 then
														parent.bok = false
													end if
												end if
											end if
										end if
									end if

									if parent.bok then
										for i = icolno + 1 to upperbound(icolact)
											if icolact[i] = 1 then
												this.setcolumn(i)
												this.setfocus()
												exit
											end if
										next
									end if

									if parent.bok then
										sstkinnos = parent.dw_sale.getitemstring(this.getrow(),"stkinnos")

										if i = upperbound(icolact) or &
												scolnm = "jewlcode" or &
												(scolnm = "rate" and &
												parent.siws = "N") or &
												(scolnm = "mcharge" and &
												sstkinnos <> "Y" and &
												parent.siws = "N") or &
												scolnm = "stktouch" then
											parent.cb_add.postevent(clicked!)
										end if
									end if

									return 1
								end if
							end if
						end if
					end if
				end if
			end if
		end if
	end if
end if

if keyflags = 2 then
	icolno = this.getcolumn()
	parent.bok = true

	for i = icolno - 1 to 1 step -1
		if icolact[i] = 1 then
			this.setcolumn(i)
			this.setfocus()
			exit
		end if
	next
else
	if keyflags = 2 and &
			key = keyrightarrow! then
		icolno = this.getcolumn()
		parent.bok = true

		for i = icolno + 1 to upperbound(icolact)
			if icolact[i] = 1 then
				this.setcolumn(i)
				this.setfocus()
				exit
			end if
		next
	end if
end if

return
end event

event itemerror;string scolname
string stmp
dec dwgt
dec dstwgt
dec dnetwgt
dec dmcrate
dec dmcharge
dec dwastage
dec drate
dec dqty
dec dvap
string sstkinnos
int iqty
string stmp5
dec drate5
dec damt5
dec dwgt5
dec dtaxperc5
dec drate6
dec dtaxperc
string scode6
string staxint

scolname = dwo.name

if scolname = "mcharge" or &
		scolname = "wastage" then
	dwgt = this.getitemnumber(row,"weight")
	dstwgt = this.getitemnumber(row,"stonewgt")
	dwastage = this.getitemnumber(row,"wastage")
	drate = this.getitemnumber(row,"rate")
	sstkinnos = this.getitemstring(row,"stkinnos")
	iqty = this.getitemnumber(row,"qty")

	if isnull(dwgt) then
		dwgt = 0
	end if

	if isnull(dstwgt) then
		dstwgt = 0
	end if

	if isnull(dwastage) then
		dwastage = 0
	end if

	if isnull(iqty) then
		iqty = 0
	end if

	dvap = 0
	stmp = trim(this.gettext())

	if pos(stmp,"*") > 0 then
		if scolname = "mcharge" then
			dmcrate = dec(left(stmp,pos(stmp,"*") - 1))
			dqty = dec(mid(stmp,pos(stmp,"*") + 1,10))

			if isnull(dqty) then
				dqty = 0
			end if

			dnetwgt = dwgt - dstwgt

			if parent.sivamodel = "Y" then
				if sstkinnos = "Y" then
					dmcharge = (iqty * drate * dmcrate) / 100
				else
					if gimcwstgadd = 1 then
						dmcharge = ((dnetwgt + dwastage) * drate * dmcrate) / 100
					else
						dmcharge = (dnetwgt * drate * dmcrate) / 100
					end if
				end if

				dvap = dmcrate
			else
				if sstkinnos = "Y" then
					if dqty = 0 then
						dmcharge = iqty * dmcrate
					else
						dmcharge = dqty * dmcrate
					end if
				else
					if dqty = 0 then
						if gimcwstgadd = 1 then
							dmcharge = (dnetwgt + dwastage) * dmcrate
						else
							dmcharge = dnetwgt * dmcrate
						end if
					else
						dmcharge = dqty * dmcrate
					end if
				end if
			end if

			this.setitem(row,"mcharge",dmcharge)
			this.setitem(row,"mcrate",dmcrate)
			this.setitem(row,"vaperc",dvap)
		else
			if scolname = "wastage" then
				dmcrate = dec(left(stmp,pos(stmp,"*") - 1))
				dnetwgt = dwgt - dstwgt
				dwastage = (dnetwgt * dmcrate) / 8
				this.setitem(row,"wastage",dwastage)
				this.setitem(row,"wstgrate",dmcrate)
			end if
		end if

		this.triggerevent(itemchanged!)
	else
		if pos(stmp,"%") > 0 or &
				pos(stmp,"/") > 0 or &
				pos(stmp,"P") > 0 or &
				pos(stmp,"G") > 0 then
			if scolname = "wastage" then
				dmcrate = dec(left(stmp,pos(stmp,"%") - 1))
				dnetwgt = dwgt - dstwgt
				dwastage = (dnetwgt * dmcrate) / 100
				this.setitem(row,"wastage",dwastage)

				if dnetwgt > 0 then
					this.setitem(row,"wstgrate",dwastage / dnetwgt * 8)
				end if
			else
				if scolname = "mcharge" then
					if pos(stmp,"%") > 0 then
						dmcrate = dec(left(stmp,pos(stmp,"%") - 1))
					else
						if pos(stmp,"/") > 0 then
							dmcrate = dec(left(stmp,pos(stmp,"/") - 1))
						else
							if pos(stmp,"P") > 0 then
								dmcrate = dec(left(stmp,pos(stmp,"P") - 1))
							else
								if pos(stmp,"G") > 0 then
									dmcrate = dec(left(stmp,pos(stmp,"G") - 1))
								end if
							end if
						end if
					end if

					dnetwgt = dwgt - dstwgt

					if pos(stmp,"G") > 0 then
						dmcharge = dnetwgt * dmcrate
					else
						if gimcwstgadd = 1 then
							dmcharge = ((dnetwgt + dwastage) * drate * dmcrate) / 100
							dvap = dmcrate
						else
							dmcharge = (dnetwgt * drate * dmcrate) / 100
							dvap = dmcrate
						end if
					end if

					this.setitem(row,"mcharge",dmcharge)

					if dnetwgt > 0 then
						this.setitem(row,"mcrate",dmcharge / dnetwgt)
					end if

					this.setitem(row,"vaperc",dvap)
				end if
			end if

			this.triggerevent(itemchanged!)
		else
			if pos(stmp,"+") > 0 and &
					scolname = "mcharge" then
				dmcrate = dec(left(stmp,pos(stmp,"+") - 1))
				dnetwgt = dwgt - dstwgt
				dmcharge = dnetwgt * dmcrate - dwastage * drate
				dmcrate = dmcharge / dnetwgt
				this.setitem(row,"mcharge",dmcharge)
				this.setitem(row,"mcrate",dmcrate)
				this.triggerevent(itemchanged!)
			end if
		end if
	end if
else
	if scolname = "weight" then
		stmp5 = trim(this.gettext())

		if pos(stmp5,"+") > 0 then
			drate5 = this.getitemnumber(row,"rate")
			damt5 = dec(left(stmp5,pos(stmp5,"+") - 1))
			dtaxperc5 = dec(parent.em_taxperc.text)
			dwgt5 = damt5 / (drate5 * (1 + dtaxperc5 / 100 + (dtaxperc5 * gdastperc) / 10000))

			if dwgt5 > 0 then
				this.setitem(row,"weight",dwgt5)
				this.triggerevent(itemchanged!)
			end if
		end if
	else
		if scolname = "rate" then
			stmp = this.gettext()

			if pos(stmp,"+") > 0 then
				scode6 = trim(this.getitemstring(row,"itemcode"))

				select taxinternal 
				into :staxint
				from items
				where code = :scode6;

				if staxint = "Y" then
					drate6 = dec(left(stmp,pos(stmp,"+") - 1))
					dtaxperc = dec(parent.em_taxperc.text)
					drate6 = (drate6 * 10000) / (10000 + 100 * dtaxperc + dtaxperc * 0)
					this.setitem(row,"rate",drate6)
					this.triggerevent(itemchanged!)
				end if
			end if
		end if
	end if
end if

return 1
end event

event itemchanged;string scolname
string scode
string sname
string stype
string sjcode
string stmp
string sstkinnos
string sqtype
string squnit
string svachange
string sbtype
string sstktype
string sstkinnos2
string spart
string staxint
string sstkinnos3
string ssubgrp
string sbcitem
string svaoffer
int irow
int icol
dec dwgt
dec drate
dec damount
dec dstwgt
dec dstprice
dec dmcharge
dec dwastage
dec dwastage1
dec dwsrate
dec dnetwgt
dec dwstgrate
dec dmcrate
dec dvaperc
dec ddmdamt
dec dvaperqty
dec dtaxperc
dec dstktouch
dec dcost = 0
dec dstkwgta
dec dstkwgtb
dec dtmp
dec drate2
dec drate3
dec dbcmcamt
dec dtamt
dec dastperc
int istkqtya
int istkqtyb
int iqty
int idefqty
int iret
int idis
longlong lbcode
int iwrno
string sparm
dec djrate
dec dva
int ipos1
int ipos2
dec dwgt2
dec dvap
dec dvap2

parent.bchkentry = false
drate = gdgrate
irow = parent.dw_sale.getrow()
icol = parent.dw_sale.getcolumn()
scolname = parent.dw_sale.getcolumnname()
dastperc = gdastperc

if parent.cbx_cst.checked then
	dastperc = 0
end if

svachange = this.getitemstring(irow,"vachange")

if isnull(svachange) then
	svachange = ""
end if

if profilestring(gsinifile,"Software","ConfirmVaChange","N") = "Y" and &
		svachange = "" and &
		parent.saded = "E" then
	if messagebox("Confirm","Do you want to change VA ?",question!,yesno!,2) = 1 then
		svachange = "Y"
	else
		svachange = "N"
	end if

	this.setitem(irow,"vachange",svachange)
end if

if svachange = "" then
	svachange = "Y"
end if

parent.bok = true

if scolname = "itemcode" then
	scode = trim(parent.dw_sale.gettext())
	iret = 0

	if parent.sibccompulsory = "Y" and &
			scode <> "" then
		iret = parent.bcodechk(irow)

		if iret = 0 then
			lbcode = this.getitemnumber(irow,"bcode")

			if isnull(lbcode) then
				lbcode = 0
			end if

			if lbcode = 0 then
				select menuitem 
				into :sstktype
				from userd
				where code = :gsuserid and
				menuitem ='BCCOMPULSORY';

				if sqlca.sqlcode = 0 then
					messagebox("Warning","Barcode is Compulsory.~nYou can't sale without barcode...",stopsign!)
					parent.dw_sale.setitem(irow,"itemcode","")
					parent.bok = false
				else
					messagebox("Warning","Barcode is Compulsory.~nPlease Confirm...")
				end if
			end if
		else
			scode = trim(parent.dw_sale.gettext())
		end if
	else
		if scode <> "" then
			if len(scode) > 3 then
				iret = parent.bcodechk(irow)
				scode = trim(parent.dw_sale.gettext())
			end if
		end if
	end if

	spart = ""
	sbcitem = this.getitemstring(irow,"bcitem")

	if isnull(sbcitem) then
		sbcitem = ""
	end if

	if sbcitem <> scode then
		lbcode = 0
		this.setitem(irow,"bcode",0)
	end if

	lbcode = this.getitemnumber(irow,"bcode")

	if lbcode > 0 then
		sstkinnos2 = this.getitemstring(irow,"stkinnos")

		select part 
		into :spart
		from barcode
		where bcode = :lbcode;

		if isnull(spart) then
			spart = ""
		end if

		if isnull(sstkinnos2) then
			sstkinnos2 = ""
		end if
	end if

	select name , itype , wastage , mcharge , cost , qty , weight , qtyb , weightb , vaperc , stkinnos , defqty , disabled , defstktype , defquality , vaperqty , rate , wsrate , taxinternal , billtype , stktouch , vaoffer 
	into :sname, :stype, :dwstgrate, :dmcrate, :dcost, :istkqtya, :dstkwgta, :istkqtyb, :dstkwgtb, :dvaperc, :sstkinnos, :idefqty, :idis, :sstktype, :sqtype, :dvaperqty, :drate2, :dwsrate, :staxint, :sbtype, :dstktouch, :svaoffer
	from items
	where code = :scode;

	if sqlca.sqlcode <> 0 then
		if scode <> "" then
			messagebox("Error","Invalid Item",exclamation!,ok!)
		end if

		parent.dw_sale.setitem(irow,"itemcode","")
		parent.bok = false
	else
		if sstkinnos2 = "Y" then
			sstkinnos = sstkinnos2
		end if

		if idis = 1 then
			messagebox("Disabled","This Item is disabled",exclamation!,ok!)
			parent.bok = false
			this.setitem(irow,"itemcode","")
		else
			parent.bok = true
			parent.dw_sale.accepttext()
			lbcode = this.getitemnumber(irow,"bcode")
			squnit = ""
			sstkinnos3 = ""
			drate3 = 0
			dtamt = 0

			if isnull(lbcode) or &
					lbcode = 0 then
				lbcode = 0
			else
				sqtype = ""

				select qtype , qunit , rate , tamt , stkinnos , subgrp 
				into :sqtype, :squnit, :drate3, :dtamt, :sstkinnos3, :ssubgrp
				from barcode
				where bcode = :lbcode;

				if isnull(sqtype) then
					sqtype = ""
				end if

				if isnull(squnit) then
					squnit = ""
				end if

				if isnull(drate3) then
					drate3 = 0
				end if

				if gsinternationalrate = "Y" and &
						sqtype <> "" then
					select rate 
					into :drate3
					from itemsqtype
					where code = :sqtype;

					if isnull(drate3) then
						drate3 = 0
					end if
				end if

				if left(trim(sqtype),2) = "18" and &
						drate3 = 0 then
					drate3 = gdg18rate
				end if

				if left(trim(sqtype),2) = "24" and &
						gdthrate > 0 and &
						drate3 = 0 then
					drate3 = gdthrate
				end if

				if sstkinnos3 = "Y" and &
						dtamt > 0 then
					drate3 = dtamt
				end if

				if staxint = "Y" then
					dtaxperc = dec(parent.em_taxperc.text)

					if parent.cbx_cst.checked then
						dastperc = 0
					end if

					if dtaxperc > 0 then
						if profilestring(gsinifile,"Software","CessIsBasedOnBillAmt","Y") = "Y" then
							drate3 = (drate3 * 100) / (100 + dtaxperc + dastperc)
						else
							drate3 = (drate3 * 10000) / (10000 + 100 * dtaxperc + dtaxperc * dastperc)
						end if
					end if
				end if
			end if

			if isnull(ssubgrp) then
				ssubgrp = ""
			end if

			if ssubgrp <> "" then
				if profilestring(gsinifile,"Software","SubGrpNameForItemName","N") = "Y" then
					select name 
					into :stmp
					from itemsubgrp
					where code = :ssubgrp;

					if isnull(stmp) then
						stmp = ""
					end if

					sname = stmp
				end if
			end if

			if spart <> "" then
				sname = spart
			end if

			if sqtype <> "" then
				sname = trim(sname) + "-" + sqtype
			end if

			if squnit <> "" then
				sname = trim(sname) + "-" + squnit
			end if

			parent.dw_sale.setitem(irow,"itemname",sname)

			if dtamt > 0 then
				dwgt = parent.dw_sale.getitemnumber(irow,"weight")
				dstwgt = parent.dw_sale.getitemnumber(irow,"stonewgt")
				dstprice = parent.dw_sale.getitemnumber(irow,"stoneprice")
				ddmdamt = parent.dw_sale.getitemnumber(irow,"dmdamt")
				dmcharge = parent.dw_sale.getitemnumber(irow,"mcharge")

				if isnull(ddmdamt) then
					ddmdamt = 0
				end if

				if isnull(dstprice) then
					dstprice = 0
				end if

				if isnull(dmcharge) then
					dmcharge = 0
				end if

				if isnull(dwgt) then
					dwgt = 0
				end if

				if isnull(dstwgt) then
					dstwgt = 0
				end if

				if sstkinnos3 = "Y" then
					drate3 = dtamt

					if staxint = "Y" then
						dtaxperc = dec(parent.em_taxperc.text)

						if profilestring(gsinifile,"Software","CessIsBasedOnBillAmt","Y") = "Y" then
							drate3 = (drate3 * 100) / (100 + dtaxperc + dastperc)
						else
							drate3 = (drate3 * 10000) / (10000 + 100 * dtaxperc + dtaxperc * dastperc)
						end if
					end if

					ddmdamt = 0
					parent.dw_sale.setitem(irow,"dmdamt",0)
				else
					if dwgt - dstwgt > 0 then
						drate3 = (dtamt - ddmdamt - dstprice - dmcharge) / (dwgt - dstwgt)
					else
						drate3 = dtamt - ddmdamt - dstprice - dmcharge
					end if
				end if
			end if

			if stype = "G" or &
					stype = "D" then
				drate = 0

				if gsinternationalrate = "Y" then
					select rate 
					into :drate
					from itemsqtype
					where code = :sqtype;
				end if

				if parent.bijewl and &
						drate = 0 then
					drate = gdjrate
				else
					if left(sqtype,2) = "18" and &
							gdg18rate > 0 and &
							drate = 0 then
						drate = gdg18rate
					else
						if left(sqtype,2) = "24" and &
								gdthrate > 0 and &
								drate = 0 then
							drate = gdthrate
						else
							if drate = 0 then
								drate = dec(parent.em_rate.text)
							end if
						end if
					end if
				end if
			else
				if stype = "S" then
					drate = gdsrate
				else
					if stype = "P" then
						drate = gdprate
					end if
				end if
			end if

			if drate2 > 0 then
				drate = drate2
			end if

			if drate3 > 0 then
				drate = drate3
			end if

			if parent.cbx_ws.checked then
				drate = dwsrate
			end if

			if stype = "G" and &
					parent.sibulrate = "Y" then
				if parent.siratebeftax = "Y" then
					dtaxperc = dec(parent.em_taxperc.text)
					drate = (drate * 100) / (100 + dtaxperc)
				end if

				drate = (drate * dstktouch) / parent.dibultouch
			end if

			parent.dw_sale.setitem(irow,"rate",drate)
			parent.dw_sale.setitem(irow,"itemtype",stype)

			if lbcode = 0 then
				parent.dw_sale.setitem(irow,"wstgrate",dwstgrate)
				parent.dw_sale.setitem(irow,"mcrate",dmcrate)
				parent.dw_sale.setitem(irow,"vaperc",dvaperc)
				parent.dw_sale.setitem(irow,"vaperqty",dvaperqty)

				if idefqty > 0 then
					parent.dw_sale.setitem(irow,"qty",idefqty)
				end if

				parent.dw_sale.setitem(irow,"cost",dcost)
			end if

			if parent.sidefstktype <> "" then
				sstktype = parent.sidefstktype
			end if

			parent.dw_sale.setitem(irow,"jewl",0)
			parent.dw_sale.setitem(irow,"stkinnos",sstkinnos)
			parent.dw_sale.setitem(irow,"stktype",sstktype)
			parent.dw_sale.setitem(irow,"iqtype",sqtype)
			parent.dw_sale.setitem(irow,"stktouch",dstktouch)

			if gilevel = 1 then
				parent.dw_sale.setitem(irow,"stockqty",istkqtya)
				parent.dw_sale.setitem(irow,"stockwgt",dstkwgta)
				parent.st_stock.text = trim(string(istkqtya)) + " / " + trim(string(dstkwgta,"####0.000"))
			else
				parent.dw_sale.setitem(irow,"stockqty",istkqtyb)
				parent.dw_sale.setitem(irow,"stockwgt",dstkwgtb)
				parent.st_stock.text = trim(string(istkqtyb)) + " / " + trim(string(dstkwgtb,"####0.000"))
			end if

			parent.st_stktype.text = trim(sstktype)
		end if
	end if
else
	if scolname = "jewl" then
		if integer(data) = 1 then
			sparm = trim(this.getitemstring(irow,"jewlcode"))
			djrate = this.getitemnumber(irow,"jrate")
			dva = this.getitemnumber(irow,"jva")

			if isnull(sparm) then
				sparm = ""
			end if

			if isnull(djrate) then
				djrate = 0
			end if

			if isnull(dva) then
				dva = 0
			end if

			if sparm = "" then
				djrate = gdgrate
				dva = 0
			end if

			sparm = sparm + "|" + string(djrate) + "|" + string(dva)
			openwithparm(w_jewlcode,sparm)
			sparm = message.stringparm

			if sparm <> "" then
				ipos1 = pos(sparm,"|")
				sjcode = left(sparm,ipos1 - 1)
				parent.dw_sale.setitem(irow,"jewlcode",sjcode)
				ipos2 = pos(sparm,"|",ipos1 + 1)
				djrate = dec(mid(sparm,ipos1 + 1,ipos2 - ipos1 - 1))
				dva = dec(mid(sparm,ipos2 + 1,12))
				parent.dw_sale.setitem(irow,"jrate",djrate)
				parent.dw_sale.setitem(irow,"jva",dva)
			end if

			if sjcode = "" then
				parent.bok = false
			end if
		else
			parent.st_jcode.text = ""
		end if

		this.setfocus()
	else
		if scolname = "weight" then
			lbcode = this.getitemnumber(irow,"bcode")

			if isnull(lbcode) then
				lbcode = 0
			end if

			dwgt = dec(this.gettext())

			if lbcode > 0 and &
					parent.dibcadjustablewgt > 0 and &
					dwgt > 0 then
				select weight 
				into :dwgt2
				from barcode
				where bcode = :lbcode;

				if abs(dwgt2 - dwgt) > parent.dibcadjustablewgt then
					parent.bok = false
				end if
			end if

			if parent.bok then
				parent.dw_sale.accepttext()
			end if
		else
			if scolname = "vaperc" then
				lbcode = this.getitemnumber(irow,"bcode")

				if isnull(lbcode) then
					lbcode = 0
				end if

				dvap = dec(this.gettext())

				if lbcode > 0 then
					select vap 
					into :dvap2
					from barcode
					where bcode = :lbcode;

					if dvap < dvap2 then
						parent.bok = false
					end if
				end if

				if parent.bok then
					parent.dw_sale.accepttext()
				end if
			else
				parent.dw_sale.accepttext()
			end if
		end if
	end if
end if

sname = parent.dw_sale.getitemstring(irow,"itemname")
scode = parent.dw_sale.getitemstring(irow,"itemcode")
dwgt = parent.dw_sale.getitemnumber(irow,"weight")
iqty = parent.dw_sale.getitemnumber(irow,"qty")
dstwgt = parent.dw_sale.getitemnumber(irow,"stonewgt")
dstprice = parent.dw_sale.getitemnumber(irow,"stoneprice")
stype = parent.dw_sale.getitemstring(irow,"itemtype")
drate = parent.dw_sale.getitemnumber(irow,"rate")
ddmdamt = parent.dw_sale.getitemnumber(irow,"dmdamt")
dwstgrate = parent.dw_sale.getitemnumber(irow,"wstgrate")
dmcharge = parent.dw_sale.getitemnumber(irow,"mcharge")
dbcmcamt = parent.dw_sale.getitemnumber(irow,"bcmcamt")
dmcrate = parent.dw_sale.getitemnumber(irow,"mcrate")
dvaperc = parent.dw_sale.getitemnumber(irow,"vaperc")
dvaperqty = parent.dw_sale.getitemnumber(irow,"vaperqty")
sstkinnos = parent.dw_sale.getitemstring(irow,"stkinnos")
sqtype = parent.dw_sale.getitemstring(irow,"iqtype")
dstkwgtb = parent.dw_sale.getitemnumber(irow,"stockwgt")
lbcode = this.getitemnumber(irow,"bcode")

if isnull(dwgt) then
	dwgt = 0
end if

if isnull(drate) then
	drate = 0
end if

if isnull(dstwgt) then
	dstwgt = 0
end if

if isnull(dstprice) then
	dstprice = 0
end if

if isnull(dwstgrate) then
	dwstgrate = 0
end if

if isnull(dmcrate) then
	dmcrate = 0
end if

if isnull(dvaperc) then
	dvaperc = 0
end if

if isnull(dvaperqty) then
	dvaperqty = 0
end if

if isnull(ddmdamt) then
	ddmdamt = 0
end if

if isnull(sqtype) then
	sqtype = ""
end if

if isnull(dstkwgtb) then
	dstkwgtb = 0
end if

if isnull(lbcode) then
	lbcode = 0
end if

if isnull(dbcmcamt) then
	dbcmcamt = 0
end if

if scolname = "weight" and &
		gisemi > 1 then
	select weightb 
	into :dstkwgtb
	from items
	where code = :scode;

	if isnull(dstkwgtb) then
		dstkwgtb = 0
	end if

	if dwgt > dstkwgtb then
		messagebox("Warning","Insufficient Stock. Please confirm...")
	end if
end if

if (scolname = "weight" or &
		scolname = "stonewgt" or &
		scolname = "itemcode" or &
		scolname = "rate" or &
		scolname = "vaperc" or &
		(scolname = "qty" and &
		dvaperqty > 0)) and &
		svachange = "Y" then
	dnetwgt = dwgt - dstwgt

	if parent.sivamodel = "Y" and &
			dbcmcamt = 0 then
		dmcharge = 0
		dwastage = 0

		if lbcode = 0 then
			if dvaperc > 0 then
				if parent.sibulrate = "Y" then
					dtaxperc = dec(parent.em_taxperc.text)
					drate3 = (dec(parent.em_rate.text) * 100) / parent.dibultouch
					drate3 = (drate3 * 100) / (100 + dtaxperc)
					dmcharge = (drate3 * dnetwgt * dvaperc) / 100
				else
					dmcharge = (drate * dnetwgt * dvaperc) / 100
				end if
			else
				dmcharge = mccalc(scode,dnetwgt,iqty,drate,sqtype)
			end if
		end if

		if dmcharge = 0 then
			if gimcwstgadd = 1 then
				dwastage = wastagecalc(scode,sqtype,dnetwgt)

				if dwastage = 0 then
					if giwstgadd = 1 then
						dwastage = round((dnetwgt + (dnetwgt * 0.2) / 8) * dwstgrate / 8,3)
					else
						dwastage = round(dnetwgt * dwstgrate / 8,3)
					end if
				end if

				dmcharge = ((dnetwgt + dwastage) * drate * dvaperc) / 100
			else
				dmcharge = (dnetwgt * drate * dvaperc) / 100
			end if

			if dvaperc = 0 and &
					dvaperqty > 0 then
				dmcharge = iqty * dvaperqty
			end if
		end if
	else
		if giwastageopt = 1 then
			if gsids = "Aaj" then
				if dnetwgt <= 1 then
					dwastage = round((dnetwgt * 10) / 100,3)
				else
					dwastage = round((dnetwgt * gdwastage) / 100,3)
				end if

				iwrno = 10
				dwastage1 = (dwastage - int(dwastage)) * 1000
				dwastage1 = mod(dwastage1,iwrno)

				if dwastage1 > 0 then
					dwastage = truncate(dwastage + (iwrno - dwastage1) / 1000,3)
				end if

				if dnetwgt > 1 and &
						dnetwgt < 2 then
					dwastage = 0.100
				end if

				if dmcrate > 0 and &
						dbcmcamt = 0 then
					if gimcwstgadd = 1 then
						dmcharge = (dnetwgt + dwastage) * dmcrate
					else
						dmcharge = dnetwgt * dmcrate
					end if
				end if
			else
				dwastage = round((dnetwgt * gdwastage) / 100,3)

				if dwgt > 0.500 then
					iwrno = 50
				else
					iwrno = 30
				end if

				dwastage1 = (dwastage - int(dwastage)) * 1000
				dwastage1 = mod(dwastage1,iwrno)

				if dwastage1 > 0 then
					dwastage = truncate(dwastage + (iwrno - dwastage1) / 1000,3)
				end if

				if dmcrate > 0 and &
						dbcmcamt = 0 then
					if gimcwstgadd = 1 then
						dmcharge = (dnetwgt + dwastage) * dmcrate
					else
						dmcharge = dnetwgt * dmcrate
					end if
				end if
			end if
		else
			if giwastageopt = 2 then
				dwastage = wastagecalc(scode,sqtype,dnetwgt)

				if dwastage = 0 then
					if giwstgadd = 1 then
						dwastage = round((dnetwgt + (dnetwgt * 0.2) / 8) * dwstgrate / 8,3)
					else
						dwastage = round(dnetwgt * dwstgrate / 8,3)
					end if
				end if

				if dwgt > 0.500 then
					iwrno = 50
				else
					iwrno = 30
				end if

				if gsids = "Nj" or &
						gsids = "Ga" then
					dwastage1 = (dwastage - int(dwastage)) * 1000
					dwastage1 = mod(dwastage1,iwrno)

					if dwastage1 > 0 then
						dwastage = truncate(dwastage + (iwrno - dwastage1) / 1000,3)
					end if
				else
					if parent.diwstgroundup > 0 then
						dwastage1 = (dwastage - int(dwastage)) * 1000
						dwastage1 = mod(dwastage1,parent.diwstgroundup * 1000)

						if dwastage1 > 0 then
							dwastage = truncate(dwastage + (parent.diwstgroundup * 1000 - dwastage1) / 1000,3)
						end if
					else
						if parent.diwstgrounddown > 0 then
							dwastage1 = (dwastage - int(dwastage)) * 1000
							dwastage1 = mod(dwastage1,parent.diwstgroundup * 1000)

							if dwastage1 > 0 then
								dwastage = truncate(dwastage - dwastage1 / 1000,3)
							end if
						end if
					end if
				end if

				if parent.diwstgminimum > 0 and &
						dwastage < parent.diwstgminimum and &
						dwgt > 0 and &
						dwstgrate > 0 then
					dwastage = parent.diwstgminimum
				end if

				dmcharge = 0

				if lbcode = 0 then
					dmcharge = mccalc(scode,dnetwgt,iqty,drate,sqtype)
				end if

				if dmcrate > 0 and &
						dmcharge = 0 then
					if gimcwstgadd = 1 then
						dmcharge = (dnetwgt + dwastage) * dmcrate
					else
						dmcharge = dnetwgt * dmcrate
					end if

					if parent.dimcminimum > 0 and &
							dmcharge < parent.dimcminimum and &
							dwgt > 0 then
						if profilestring(gsinifile,"Software","DevideNetwgtByQty","N") = "Y" and &
								iqty > 0 then
							dnetwgt /= iqty
						end if

						select mcperqty 
						into :dtmp
						from mctable
						where code = :scode and
						 :dnetwgt > weight1 and
						 :dnetwgt <= weight2;

						if isnull(dtmp) then
							dtmp = 0
						end if

						if dtmp = 0 then
							dmcharge = parent.dimcminimum
						end if
					end if
				end if
			else
				if giwastageopt = 3 and &
						lbcode = 0 then
					select wastage 
					into :dwastage
					from wstg
					where  :dnetwgt >= llimit and
					 :dnetwgt <= ulimit;

					if sqlca.sqlcode <> 0 then
						dwastage = 0
					end if

					if dmcrate > 0 then
						if gimcwstgadd = 1 then
							dmcharge = (dnetwgt + dwastage) * dmcrate
						else
							dmcharge = dnetwgt * dmcrate
						end if
					end if
				end if
			end if
		end if
	end if

	if dwgt = 0 then
		dwastage = 0
		dmcharge = 0
	end if

	if profilestring(gsinifile,"Software","RoundOffAllAmt","N") = "Y" then
		dmcharge = round(dmcharge,0)
	end if

	if stype = "G" then
		parent.dw_sale.setitem(irow,"wastage",dwastage)

		if dmcharge > 0 then
			if parent.saded = "E" then
				if profilestring(gsinifile,"Software","ExchForm","") = "Saleena" then
				else
					parent.dw_sale.setitem(irow,"mcharge",dmcharge)
				end if
			else
				parent.dw_sale.setitem(irow,"mcharge",dmcharge)
			end if
		end if

		if gsids = "Nj" then
			this.settaborder("rate",0)
		end if
	else
		parent.dw_sale.setitem(irow,"wastage",0)
		dwastage = 0

		if lbcode = 0 then
			parent.dw_sale.setitem(irow,"mcharge",0)
			dmcharge = 0
		end if

		this.settaborder("rate",80)
	end if
else
	if scolname = "qty" then
		if profilestring(gsinifile,"Software","DevideNetwgtByQty","N") = "Y" and &
				iqty > 0 then
			dnetwgt = (dwgt - dstwgt) / iqty
		else
			dnetwgt = dwgt - dstwgt
		end if

		dmcharge = 0

		select mcperqty 
		into :dmcharge
		from mctable
		where code = :scode and
		 :dnetwgt > weight1 and
		 :dnetwgt <= weight2;

		if isnull(dmcharge) then
			dmcharge = 0
		end if

		if dvaperc = 0 and &
				dvaperqty > 0 then
			dmcharge = iqty * dvaperqty
		else
			if dmcharge > 0 then
				dmcharge *= iqty

				if profilestring(gsinifile,"Software","RoundOffAllAmt","N") = "Y" then
					dmcharge = round(dmcharge,0)
				end if

				parent.dw_sale.setitem(irow,"mcharge",dmcharge)
			end if
		end if
	end if
end if

dwastage = parent.dw_sale.getitemnumber(irow,"wastage")
dmcharge = parent.dw_sale.getitemnumber(irow,"mcharge")
drate = parent.dw_sale.getitemnumber(irow,"rate")

if isnull(dwgt) then
	dwgt = 0
end if

if isnull(iqty) then
	iqty = 0
end if

if isnull(dstwgt) then
	dstwgt = 0
end if

if isnull(dstprice) then
	dstprice = 0
end if

if isnull(dmcharge) then
	dmcharge = 0
end if

if isnull(dwastage) then
	dwastage = 0
end if

if isnull(ddmdamt) then
	ddmdamt = 0
end if

if isnull(drate) then
	drate = 0
end if

if sstkinnos = "Y" then
	damount = iqty * drate + dstprice + dmcharge + ddmdamt
else
	damount = (dwgt - dstwgt + dwastage) * drate + dstprice + dmcharge + ddmdamt
end if

if profilestring(gsinifile,"Software","RoundOffAllAmt","N") = "Y" then
	damount = round(damount,0)
else
	damount = round(damount,profileint(gsinifile,"Software","RoundDec",2))
end if

parent.dw_sale.setitem(irow,"amount",damount)
parent.st_va.text = trim(string(dwastage * drate + dmcharge,"#####0.00"))
parent.bchkentry = true

if isnull(sbtype) then
	sbtype = ""
end if

if sbtype <> "" then
	parent.dw_billtype.setitem(1,1,sbtype)
end if

if scolname = "itemcode" and &
		iret > 0 then
	parent.cb_add.postevent(clicked!)
end if

if not parent.bok then
	return 1
else
	return 0
end if
end event

event dberror;
return 1
end event

event losefocus;long lrow
long ltrow
long lbcode
dec damt
dec dbamt
dec dtaxamt
dec dtmpamt
dec dexamt
dec dsretamt
dec dtaxable
dec dast
dec ddisc
dec dretdisc
dec dbamt2
dec drva
dec dmc
dec dtmc
dec dbamt1
dec dmc2
dec dnetamt
dec dtmc2
dec dvadisc
dec dextra
dec dastperc
string scode
string staxable
string snodisc
string spcard
string sccode
string snodisc2
boolean bsave = true
int ifr

if not parent.bchkentry then
	return
end if

dbamt = 0
dtmpamt = 0
dexamt = 0
dsretamt = 0
dtaxable = 0
dretdisc = 0
dbamt2 = 0
dtmc = 0
drva = dec(parent.em_rva.text)
sccode = trim(parent.dw_1.gettext())
dvadisc = 0

if sccode <> "" then
	select pcard 
	into :spcard
	from clients
	where code = :sccode;

	select vadisc 
	into :dvadisc
	from pcard
	where code = :spcard;

	if isnull(dvadisc) then
		dvadisc = 0
	end if
end if

parent.dw_sale.accepttext()
lrow = 1
ltrow = parent.dw_sale.rowcount()
parent.sinodisc = ""

do while lrow <= ltrow
	scode = parent.dw_sale.getitemstring(lrow,"itemcode")

	if not isnull(scode) and &
			trim(scode) <> "" then
		lbcode = parent.dw_sale.getitemnumber(lrow,"bcode")

		if lbcode > 0 then
			select nodisc 
			into :snodisc
			from barcode
			where bcode = :lbcode;

			if snodisc = "N" then
				parent.sinodisc = "N"
			end if
		end if

		select taxable , nodisc 
		into :staxable, :snodisc2
		from items
		where code = :scode;

		if isnull(snodisc2) then
			snodisc2 = ""
		end if

		if snodisc2 = "N" then
			parent.sinodisc = "N"
		end if

		dtmpamt = parent.dw_sale.getitemdecimal(lrow,"amount")

		if isnull(dtmpamt) then
			dtmpamt = 0
		end if

		ifr = parent.dw_sale.getitemnumber(lrow,"fr")

		if isnull(ifr) then
			ifr = 0
		end if

		dmc = parent.dw_sale.getitemdecimal(lrow,"mcharge")

		if isnull(dmc) then
			dmc = 0
		end if

		if ifr = 1 or &
				parent.cbx_updtfr.checked then
			dtaxable += dtmpamt
		end if

		dbamt += dtmpamt

		if staxable = "Y" then
			dbamt2 += dtmpamt
		end if

		dtmc += dmc
	end if

	lrow += 1
loop

ltrow = upperbound(parent.strexchange)
lrow = 1

do while lrow <= ltrow
	dexamt += parent.strexchange[lrow].amount
	lrow += 1
loop

ltrow = upperbound(parent.strsreturn)
lrow = 1
dretdisc = 0
dtmc2 = 0

do while lrow <= ltrow
	dsretamt += parent.strsreturn[lrow].amount
	dtmc2 += parent.strsreturn[lrow].mcharge
	lrow += 1
loop

if ltrow > 0 then
	dretdisc = parent.strsreturn[1].wgtamt
	dsretamt = dsretamt - dretdisc + parent.strsreturn[1].taxamt + parent.strsreturn[1].ast
end if

if parent.seb <> "B" then
	ddisc = 0
end if

dnetamt = dbamt - dexamt - dsretamt

if drva > 0 then
	dbamt1 = dbamt - dtmc
	dmc2 = round((dbamt1 * drva) / 100,0)
	ddisc = dtmc - dmc2

	if ddisc > 0 then
		parent.em_discount.text = string(ddisc)
	else
		ddisc = 0
	end if
else
	if parent.didiscperc > 0 then
		ddisc = round(((dbamt - dtmc - (dsretamt - dtmc2)) * parent.didiscperc) / 100,0)

		if gsids = "Nj" and &
				ddisc > 0 then
			dtmpamt = mod(dnetamt - ddisc,10)
			ddisc += dtmpamt
			parent.em_discount.text = string(ddisc)
		end if

		parent.em_discount.text = string(ddisc)
	else
		if dvadisc > 0 then
			ddisc = round((dtmc * dvadisc) / 100,0)
			parent.em_discount.text = string(ddisc)
		end if
	end if
end if

parent.em_billtotal.text = string(dbamt)
parent.em_exchange.text = string(dexamt)
parent.em_sreturn.text = string(dsretamt)
ddisc = dec(parent.em_discount.text)
dtaxamt = 0
dextra = 0
dastperc = dec(parent.em_astperc.text)

if profilestring(gsinifile,"Software","CessIsBasedOnBillAmt","Y") = "Y" then
	if parent.sitaxafterdisc = "Y" then
		dast = ((dbamt - ddisc) * dastperc) / 100
	else
		dast = (dbamt * dastperc) / 100
	end if

	if parent.cbx_cst.checked or &
			trim(parent.sle_tin.text) <> "" then
		dast = 0
	end if
end if

if profilestring(gsinifile,"Software","ShowTaxInEstimate","N") = "Y" or &
		parent.ditaxperc > 0 then
	if parent.sitaxafterdisc = "Y" then
		dbamt2 -= ddisc
	end if

	dtaxamt = truncate(((dbamt2 + dextra) * parent.ditaxperc) / 100,2)
else
	if dtaxable > 0 and &
			profilestring(gsinifile,"Software","SplitBills","N") = "Y" and &
			parent.seb = "E" then
		if parent.sitaxafterdisc = "Y" then
			dtaxable -= ddisc
		end if

		dtaxamt = truncate(((dtaxable + dextra) * parent.ditaxperc) / 100,2)
	else
		if parent.seb = "B" then
			if parent.sitaxafterdisc = "Y" then
				dbamt2 -= ddisc
			end if

			dtaxamt = truncate(((dbamt2 + dextra) * parent.ditaxperc) / 100,2)
		end if
	end if
end if

if dtaxamt = 0 then
	dast = 0
end if

if profilestring(gsinifile,"Software","CessIsBasedOnBillAmt","Y") = "N" then
	dast = round((dtaxamt * dastperc) / 100,2)
end if

if parent.cbx_cst.checked or &
		trim(parent.sle_tin.text) <> "" then
	dast = 0
end if

if profilestring(gsinifile,"Software","RoundOffTaxAmt","N") = "Y" then
	dtaxamt = round(dtaxamt,0)
	dast = round(dast,0)
end if

parent.em_staxamt.text = string(round(dtaxamt,2))
parent.em_ast.text = string(dast)

if parent.seb = "B" then
	parent.em_ptaxamt.text = string(round((dexamt * dec(parent.em_ptaxperc.text)) / 100,0))
end if

if parent.sinodisc = "N" then
	parent.em_discount.text = ""
	parent.em_discount.enabled = false
	parent.em_discperc.enabled = false
else
	parent.em_discount.enabled = true
	parent.em_discperc.enabled = true
end if

parent.balcalc(1)

return
end event

event itemfocuschanged;
this.selecttext(1,len(this.gettext()))
end event

event rowfocuschanged;dec dwastage
dec dmcharge
dec drate
dec dstkwgt
dec dva
dec dadjwgt
dec dvap
dec damt
dec dwgt
dec dstwgt
dec dttouch
dec dmccost
int istkqty
int iadjqty
string sstock
string sva
string stype
string sjcode
string skdm
string sadjitem
string sstktype
string sscode
string stmp
long lbcode

if currentrow > 0 then
	dwastage = this.getitemdecimal(currentrow,"wastage")
	dmcharge = this.getitemdecimal(currentrow,"mcharge")
	drate = this.getitemdecimal(currentrow,"rate")
	sjcode = trim(this.getitemstring(currentrow,"jewlcode"))
	sadjitem = trim(this.getitemstring(currentrow,"Adjitem"))
	dadjwgt = this.getitemdecimal(currentrow,"adjwgt")
	iadjqty = this.getitemnumber(currentrow,"adjqty")
	sstktype = trim(this.getitemstring(currentrow,"stktype"))
	dwgt = this.getitemdecimal(currentrow,"weight")
	dstwgt = this.getitemdecimal(currentrow,"stonewgt")
	dmccost = this.getitemdecimal(currentrow,"mccost")
	dstkwgt = this.getitemdecimal(currentrow,"stockwgt")
	istkqty = this.getitemnumber(currentrow,"stockqty")
	stype = this.getitemstring(currentrow,"itemtype")
	skdm = this.getitemstring(currentrow,"iqtype")
	dttouch = this.getitemdecimal(currentrow,"ttouch")
	sscode = this.getitemstring(currentrow,"scode")

	if isnull(dwastage) then
		dwastage = 0
	end if

	if isnull(dmcharge) then
		dmcharge = 0
	end if

	if isnull(drate) then
		drate = 0
	end if

	if isnull(dstkwgt) then
		dstkwgt = 0
	end if

	if isnull(istkqty) then
		istkqty = 0
	end if

	if isnull(dadjwgt) then
		dadjwgt = 0
	end if

	if isnull(iadjqty) then
		iadjqty = 0
	end if

	if isnull(sstktype) then
		sstktype = ""
	end if

	if isnull(dwgt) then
		dwgt = 0
	end if

	if isnull(dstwgt) then
		dstwgt = 0
	end if

	if isnull(dttouch) then
		dttouch = 0
	end if

	if isnull(sscode) then
		sscode = ""
	end if

	if isnull(dmccost) then
		dmccost = 0
	end if

	dvap = 0

	if dwgt > 0 and &
			(dwgt - dstwgt) * drate > 0 then
		dvap = dmcharge / ((dwgt - dstwgt) * drate) * 100
	end if

	sstock = trim(string(istkqty)) + " / " + trim(string(dstkwgt,"####0.000"))
	dva = dmcharge + dwastage * drate
	sva = string(dva,"#####0.00")
	parent.st_stock.text = sstock
	parent.st_jcode.text = sjcode
	parent.st_itemadj.text = trim(sadjitem) + " " + trim(string(iadjqty,"###")) & 
			+ "/" & 
			+ trim(string(dadjwgt,"####.###"))
	parent.st_stktype.text = trim(sstktype)
	stmp = ""

	if dttouch > 0 or &
			sscode <> "" then
		stmp = "TT:" + string(dttouch,"####0.##") + "-S:" & 
				+ sscode
	end if

	if dmccost > 0 then
		stmp = stmp + " MCC:" + string(dmccost,"#####0.00")
	end if

	parent.st_cas.text = stmp

	if stype = "S" then
		parent.dw_sale.settaborder("rate",80)
	else
		if gsids = "Nj" then
			parent.dw_sale.settaborder("rate",0)
		end if
	end if

	parent.st_kdm.text = skdm

	if profilestring(gsinifile,"Software","BlockSalesIfBCExist","Y") = "Y" and &
			parent.sialloweditbcdet = "N" then
		lbcode = parent.dw_sale.getitemnumber(currentrow,"bcode")

		if isnull(lbcode) then
			lbcode = 0
		end if

		if lbcode > 0 then
			parent.dw_sale.object.qty.edit.displayonly = true
			parent.dw_sale.object.itemname.edit.displayonly = true
			parent.dw_sale.object.stonewgt.edit.displayonly = true
			parent.dw_sale.object.stoneprice.edit.displayonly = true
			parent.dw_sale.object.wastage.edit.displayonly = true
			parent.dw_sale.object.mcharge.edit.displayonly = true
			parent.dw_sale.object.amount.edit.displayonly = true
			parent.dw_sale.object.rate.edit.displayonly = true
		else
			parent.dw_sale.object.qty.edit.displayonly = false
			parent.dw_sale.object.itemname.edit.displayonly = false
			parent.dw_sale.object.stonewgt.edit.displayonly = false
			parent.dw_sale.object.stoneprice.edit.displayonly = false
			parent.dw_sale.object.wastage.edit.displayonly = false
			parent.dw_sale.object.mcharge.edit.displayonly = false
			parent.dw_sale.object.amount.edit.displayonly = false
			parent.dw_sale.object.rate.edit.displayonly = false
		end if
	end if

	parent.evacalc()
end if
end event

event rowfocuschanging;//Omitted: the default "return"
end event

